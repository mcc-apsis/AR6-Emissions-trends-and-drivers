---
title: "Emissions trends and drivers"
output: html_document
---

```{r setup, include=FALSE}

#knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(ggpubr)
library(gganimate)


rm(list = ls())
load('Data/basic.RData')

# any other adjustments here

```

## Regional trends
### i.e. Figure 5.2 from IPCC AR5 (booorring)

```{r regional_trends, echo=FALSE,warning=FALSE,fig.width=8}

region <- basic %>%
  filter(Country!="World") %>% 
  filter(Year>1969 & Year<2018) %>% 
  group_by(UN6,Year) %>% 
  summarise(co2_territorial_total = sum(co2_terr_GCB,na.rm=TRUE),pop_total=sum(pop_UN)) %>% 
  mutate(co2_territorial_pc = co2_territorial_total/pop_total)

p1 <- region %>% ggplot(.,aes(x=Year,y=co2_territorial_total,fill=UN6)) +
  geom_area() +
  theme(legend.title = element_blank(),legend.position = "none")

p2 <- region %>% ggplot(.,aes(x=Year,y=co2_territorial_pc,colour=UN6)) +
  geom_path(size=1) +
  theme(legend.title = element_blank(), legend.position = "none")

ggarrange(p1, p2, ncol=2, common.legend = TRUE, legend="bottom")

```

### Fast decline and growth in total emissions, relative to 2000-2005

```{r growth_rates, echo=FALSE,warning=FALSE,fig.width=8}

rates <- basic %>% 
  filter(Country!="World") %>% 
  filter(Year>1979 & Year<2018) %>% 
  mutate(co2_terr_pc = co2_terr_GCB/pop_UN) %>% 
  mutate(co2_cons_pc = co2_cons_GCB/pop_UN) %>% 
  select(Country,UN6,Year,co2_terr_pc,pop_UN,co2_terr_GCB)

subset <- rates %>% 
  group_by(Country) %>% 
  filter(Year>1999 & Year<2006) %>% 
  summarise(average=mean(co2_terr_GCB))

rates <- left_join(rates,subset %>% select(Country,average),by=c("Country"="Country"))

rates <- rates %>% 
  group_by(Country,Year) %>% 
  mutate(rate = 1-(average/co2_terr_GCB))

# filter by years to assess here (last 10?)
models <- rates %>% 
  filter(Year>2004) %>% 
  na.omit() %>% 
  group_by(Country) %>% 
  nest() %>% 
  mutate(model = map(data, ~lm(rate ~ Year, data = .x)),
         tidy_model = map(model, broom::tidy)) %>% 
  unnest(tidy_model) %>% 
  mutate(intercept = first(estimate))

rates <- left_join(rates,models %>% filter(term=='Year') %>% select(-term),by=c("Country"="Country"))



## choose subset (fast decline)
blarg<- rates %>%
  na.omit() %>% 
  group_by(Country,Year) %>% 
  filter(max(pop_UN)>1e6) %>% 
  filter(std.error<0.01) %>% 
  arrange(estimate) %>%
  group_by(Year) %>% 
  do(head(., n = 20))

# plot 
blarg %>% 
  ggplot(aes(x=Year,y=rate))+
  geom_point(colour='grey') +
  geom_line(colour='grey') +
  geom_smooth(data=subset(blarg, Year>2004),method = "lm") +
  facet_wrap(. ~ Country,ncol=5) +
  ylim(-0.5,0.5)
  

## choose subset (fast increase)
blarg<- rates %>%
  na.omit() %>% 
  group_by(Country,Year) %>% 
  filter(max(pop_UN)>1e6) %>% 
  filter(std.error<0.01) %>% 
  arrange(desc(estimate)) %>%
  group_by(Year) %>% 
  do(head(., n = 20))

# plot 
blarg %>% 
  ggplot(aes(x=Year,y=rate))+
  geom_point(colour='grey') +
  geom_line(colour='grey') +
  geom_smooth(data=subset(blarg, Year>2004),method = "lm") +
  facet_wrap(. ~ Country,ncol=5) +
  ylim(-0.5,0.5)


#top increase
# decline <- rates %>%
#   group_by(Country,Year) %>% 
#   filter(max(pop_UN)>1e6) %>% 
#   arrange(estimate) %>%
#   group_by(Year) %>%
#   do(head(., n = 15))
# 
# # plot facet grid
# decline %>%
#   ggplot(aes(x=Year,y=co2_terr_pc)) +
#   geom_point() +
#   geom_line() +
#   geom_smooth(data=subset(decline, Year>2004),method = "lm") +
#   #geom_abline(data=subset(decline,Year>2004),aes(intercept = intercept, slope = estimate)) +
#   facet_wrap(. ~ Country,ncol=5) 
# 
# # plot normalised rates
# decline %>% 
#   ggplot(aes(x=Year,y=rate))+
#   geom_point() +
#   geom_line() +
#   facet_wrap(. ~ Country,ncol=5)
  

```


```{r well_being, echo=FALSE,warning=FALSE,fig.width=8}


# wb <- basic %>% 
#   filter(Country!="World")
# 
# p1 <- wb %>% 
#   filter(Year>1990) %>% 
#   ggplot(aes(x=co2_cons_GCB/pop_UN,y=health_lex_WB,colour=UN6,size=pop_UN)) +
#   geom_point(alpha = 0.7) +
#   scale_size(range = c(2, 12),guide=FALSE) +
#   ylim(35,85) +
#   xlim(0,30) +
#   theme(legend.title = element_blank())
# 
# p1 + transition_time(Year) +
#   labs(title = "Year: {round(frame_time)}") +
#   shadow_wake(wake_length = 0.1, alpha = FALSE)

```
