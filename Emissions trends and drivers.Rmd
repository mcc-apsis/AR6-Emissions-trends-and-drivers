---
title: "Emissions trends and drivers"
output: html_document
---

```{r setup, include=FALSE}

#knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(ggpubr)
library(gganimate)


rm(list = ls())
load('Data/basic.RData')

# any other adjustments here
basic$UN6 <- gsub("LATIN AMERICA AND THE CARIBBEAN","LATIN AMERICA",basic$UN6)

basic <- basic %>% 
  mutate(gdp_ppp_pc = gdp_ppp_WB/pop_UN)

basic$income_category  <- cut(basic$gdp_ppp_pc,breaks = c(1700,4300,8600,15000,29000,150000),dig.lab=10,include.lowest=TRUE)


```

### Regional trends
<strong>i.e. Figure 5.2 from IPCC AR5 (booorring)</strong>  

```{r regional_trends_territorial, echo=FALSE,warning=FALSE,fig.width=10,fig.height=5}

region <- basic %>%
  filter(Country!="World") %>% 
  filter(Year>1969 & Year<2018) %>% 
  group_by(UN6,Year) %>% 
  summarise(co2_territorial_total = sum(co2_terr_GCB,na.rm=TRUE),pop_total=sum(pop_UN)) %>% 
  mutate(co2_territorial_pc = co2_territorial_total/pop_total)



## cumulative emissions total (horizontal bar chart)
p1 <- region %>% 
  group_by(UN6) %>% 
  summarise(cumulative_co2 = sum(co2_territorial_total)) %>% 
  ggplot(.,aes(y=cumulative_co2,x=UN6,fill=UN6)) +
  geom_bar(stat='identity') +
  coord_flip() +
  theme(legend.title = element_blank(), legend.position = "none") +
  theme(axis.title.y = element_blank()) 
  
## total territorial emissions (stacked area)
p2 <- region %>% ggplot(.,aes(x=Year,y=co2_territorial_total,fill=UN6)) +
  geom_area() +
  theme(legend.title = element_blank(),legend.position = "none")

## per capita territorial emissions (line chart)
p3 <- region %>% ggplot(.,aes(x=Year,y=co2_territorial_pc,colour=UN6)) +
  geom_path(size=1) +
  theme(legend.title = element_blank(), legend.position = "none")

ggarrange(p1, p2, p3, ncol=3)

```

### Growth rates


```{r growth_rates, echo=FALSE,warning=FALSE}

rates <- basic %>% 
  filter(Country!="World") %>% 
  filter(Year>1979 & Year<2018) %>% 
  mutate(co2_terr_pc = co2_terr_GCB/pop_UN) %>% 
  mutate(co2_cons_pc = co2_cons_GCB/pop_UN) %>% 
  mutate(gdp_ppp_pc = gdp_ppp_WB/pop_UN)# %>% 
  #select(Country,UN6,Year,co2_terr_pc,pop_UN,co2_terr_GCB,health_lex_WB)

subset <- rates %>% 
  group_by(Country) %>% 
  filter(Year>1999 & Year<2006) %>% 
  summarise(average=mean(co2_terr_GCB))

rates <- left_join(rates,subset %>% select(Country,average),by=c("Country"="Country"))

rates <- rates %>% 
  group_by(Country,Year) %>% 
  mutate(rate = 1-(average/co2_terr_GCB))

# filter by years to assess here (last 10?)
models <- rates %>% 
  filter(Year>2004) %>% 
  na.omit() %>% 
  group_by(Country) %>% 
  nest() %>% 
  mutate(model = map(data, ~lm(rate ~ Year, data = .x)),
         tidy_model = map(model, broom::tidy)) %>% 
  unnest(tidy_model) %>% 
  mutate(intercept = first(estimate))

rates <- left_join(rates,models %>% filter(term=='Year') %>% select(-term),by=c("Country"="Country"))

```

<strong>Fast decline in total emissions, relative to 2000-2005</strong>  

``` {r decline, echo=FALSE,warning=FALSE,fig.width=8,fig.path="Plots/",dev=c('png')}

## choose subset (fast decline)
blarg<- rates %>%
  na.omit() %>% 
  group_by(Country,Year) %>% 
  filter(max(pop_UN)>1e6) %>% 
  filter(std.error<0.01) %>% 
  arrange(estimate) %>%
  group_by(Year) %>% 
  do(head(., n = 20))

# plot 
blarg %>% 
  ggplot(aes(x=Year,y=rate))+
  geom_point(colour='grey') +
  geom_line(colour='grey') +
  geom_smooth(data=subset(blarg, Year>2004),method = "lm") +
  facet_wrap(. ~ Country,ncol=5) +
  ylim(-0.5,0.5)
  
```

<strong>Fast growth in total emissions, relative to 2000-2005</strong>  

``` {r increase, echo=FALSE,warning=FALSE,fig.width=8,fig.path="Plots/",dev=c('png')}
## choose subset (fast increase)
blarg<- rates %>%
  na.omit() %>% 
  group_by(Country,Year) %>% 
  filter(max(pop_UN)>1e6) %>% 
  filter(std.error<0.01) %>% 
  arrange(desc(estimate)) %>%
  group_by(Year) %>% 
  do(head(., n = 20))

# plot 
blarg %>% 
  ggplot(aes(x=Year,y=rate))+
  geom_point(colour='grey') +
  geom_line(colour='grey') +
  geom_smooth(data=subset(blarg, Year>2004),method = "lm") +
  facet_wrap(. ~ Country,ncol=5) +
  ylim(-0.5,0.5)

```

<strong>Fast increase in total emissions, relative to 2000-2005, with high well-being (70yrs life exp.)</strong>  

``` {r increase_WB, echo=FALSE,warning=FALSE,fig.width=8,fig.path="Plots/",dev=c('png')}

## choose subset (fast increase)
blarg<- rates %>%
  na.omit() %>% 
  group_by(Country) %>% 
  filter(max(pop_UN)>1e6) %>% 
  filter(max(health_lex_WB)>75) %>%
  filter(std.error<0.01) %>% 
  group_by(Country,Year)%>% 
  arrange(desc(estimate)) %>%
  group_by(Year) %>% 
  do(head(., n = 20))

# plot 
blarg %>% 
  ggplot(aes(x=Year,y=rate))+
  geom_point(colour='grey') +
  geom_line(colour='grey') +
  geom_smooth(data=subset(blarg, Year>2004),method = "lm") +
  facet_wrap(. ~ Country,ncol=5) +
  ylim(-0.5,0.5) +
  ylab('Change in CO2, relative to 2000-2005 (%)') +
  theme(axis.title.x = element_blank()) 


```

<strong>Fast increase in total emissions, relative to 2000-2005, with high income (>10,000)</strong>  

``` {r increase_income, echo=FALSE,warning=FALSE,fig.width=8,fig.path="Plots/",dev=c('png')}

## choose subset (fast increase)
blarg<- rates %>%
  na.omit() %>% 
  group_by(Country) %>% 
  filter(max(pop_UN)>1e6) %>% 
  filter(max(gdp_ppp_pc)>15000) %>%
  filter(std.error<0.01) %>% 
  group_by(Country,Year)%>% 
  arrange(desc(estimate)) %>%
  group_by(Year) %>% 
  do(head(., n = 10))

# plot 
blarg %>% 
  ggplot(aes(x=Year,y=rate))+
  geom_point(colour='grey') +
  geom_line(colour='grey') +
  geom_smooth(data=subset(blarg, Year>2004),method = "lm") +
  facet_wrap(. ~ Country,ncol=5) +
  ylim(-0.5,0.5) +
  ylab('Change in CO2, relative to 2000-2005 (%)') +
  theme(axis.title.x = element_blank()) 


```


```{r well_being_co2, echo=FALSE,warning=FALSE,fig.width=9,fig.path="Plots/",dev=c('pdf')}

theme_set(theme_bw())

wb <- basic %>% 
  filter(Country!="World") %>% 
  filter(Year==2016) %>% 
  select(Country,UN6,co2_cons_GCB,pop_UN,health_lex_WB,gdp_ppp_WB,gdp_ppp_pc,income_category) %>% 
  filter(!is.na(income_category))

pointsToLabel <- wb$Country[wb$pop_UN>50e6 | wb$co2_cons_GCB/wb$pop_UN > 20]

plot <- wb %>%
  ggplot(aes(x=co2_cons_GCB/pop_UN,y=health_lex_WB,size=pop_UN,colour=income_category)) +
  geom_point(alpha = 0.7,stroke=1) +
  geom_text(inherit.aes=FALSE,
            aes(x=co2_cons_GCB/pop_UN,y=health_lex_WB,label=Country),
            data=wb[wb$Country %in% pointsToLabel,]) +
  scale_size(range = c(2, 12),guide=FALSE) +
  scale_y_continuous(limits=c(50,85))+
  xlim(0,30) +
  theme(legend.title = element_blank(),
        legend.position=c(0.90, 0.2), 
        legend.background = element_blank(),
        legend.key = element_blank()) +
  scale_colour_brewer(palette = "GnBu") +
  labs(y="Life expectancy at birth (years)", x="Carbon emissions in 2016 (tCO2/capita)")

inset <- wb %>% 
  ggplot(aes(x=co2_cons_GCB/pop_UN,y=health_lex_WB,size=pop_UN,colour=income_category)) +
  geom_point(alpha = 0.7,stroke=1) +
  geom_text(inherit.aes=FALSE,
            aes(x=co2_cons_GCB/pop_UN,y=health_lex_WB,label=Country)) +
  scale_size(range = c(2, 12),guide=FALSE) +
  scale_y_continuous(breaks=c(70,75,80),limits = c(70,80),expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3),limits=c(0.5,3.5),expand=c(0,0)) +
  scale_colour_brewer(palette = "GnBu") +
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        plot.background=element_blank(),
        strip.background=element_blank())
  
inset_grob <- ggplotGrob(inset)

plot + annotation_custom(inset_grob,xmin = 10,xmax = 26, ymin = 50, ymax = 67.5)


# wb <- basic %>% 
#   filter(Country!="World")
# 
# p1 <- wb %>% 
#   filter(Year>1990) %>% 
#   ggplot(aes(x=co2_cons_GCB/pop_UN,y=health_lex_WB,colour=UN6,size=pop_UN)) +
#   geom_point(alpha = 0.7) +
#   scale_size(range = c(2, 12),guide=FALSE) +
#   ylim(35,85) +
#   xlim(0,30) +
#   theme(legend.title = element_blank())
# 
# p1 + transition_time(Year) +
#   labs(title = "Year: {round(frame_time)}") +
#   shadow_wake(wake_length = 0.1, alpha = FALSE)

```

```{r well_being_ene, echo=FALSE,warning=FALSE,fig.width=9,fig.path="Plots/",dev=c('pdf','png')}

theme_set(theme_bw())

wb_iea <- basic %>% 
  filter(Country!="World") %>% 
  filter(Year==2014) %>% 
  select(Country,UN6,co2_cons_GCB,pop_UN,health_lex_WB,gdp_ppp_WB,gdp_ppp_pc,income_category,ene_tot_final_cons_IEA) %>% 
  filter(!is.na(income_category))

pointsToLabel <- wb_iea$Country[wb_iea$pop_UN>50e6 | wb_iea$ene_tot_final_cons_IEA/wb_iea$pop_UN > 200]

plot <- wb_iea %>%
  ggplot(aes(x=ene_tot_final_cons_IEA/pop_UN,y=health_lex_WB,size=pop_UN,colour=income_category)) +
  geom_point(alpha = 0.7,stroke=1) +
  geom_text(inherit.aes=FALSE,
            aes(x=ene_tot_final_cons_IEA/pop_UN,y=health_lex_WB,label=Country),
            data=wb_iea[wb_iea$Country %in% pointsToLabel,]) +
  scale_size(range = c(2, 12),guide=FALSE) +
  scale_y_continuous(limits=c(50,85))+
  xlim(0,250) +
  theme(legend.title = element_blank(),
        legend.position=c(0.90, 0.2), 
        legend.background = element_blank(),
        legend.key = element_blank()) +
  scale_colour_brewer(palette = "GnBu") +
  labs(y="Life expectancy at birth (years)", x="Final energy consumption in 2014 (GJ/capita)")

inset <- wb_iea %>% 
  ggplot(aes(x=ene_tot_final_cons_IEA/pop_UN,y=health_lex_WB,size=pop_UN,colour=income_category)) +
  geom_point(alpha = 0.7,stroke=1) +
  geom_text(inherit.aes=FALSE,
            aes(x=ene_tot_final_cons_IEA/pop_UN,y=health_lex_WB,label=Country)) +
  scale_size(range = c(2, 12),guide=FALSE) +
  scale_y_continuous(breaks=c(70,75,80),limits = c(70,80),expand=c(0,0)) +
  scale_x_continuous(breaks=c(10,20,30,40),limits=c(0,50),expand=c(0,0)) +
  scale_colour_brewer(palette = "GnBu") +
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        plot.background=element_blank(),
        strip.background=element_blank())
  
inset_grob <- ggplotGrob(inset)

plot + annotation_custom(inset_grob,xmin = 75,xmax = 210, ymin = 50, ymax = 67.5)


```
