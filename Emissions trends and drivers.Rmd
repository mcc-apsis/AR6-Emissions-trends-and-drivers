---
title: "Emissions trends and drivers"
output: html_document
---

```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)

######### load the global carbon budget ######### 

#gcb <- read.xlsx('Data/Global_Carbon_Budget_2018v1.0.xlsx',sheetIndex = 'Global Carbon Budget',startRow = 20,endRow = 79,colIndex = 1:7)

gcb <- read.xlsx('Data/Global_Carbon_Budget_2018v1.0.xlsx',sheetIndex = "CDIAC CO2",startRow = 4,endRow = 270)
names(gcb) <- c("Year","Total","Gas","Oil","Coal","Cement","Flaring","Net land-use","Total CO2")


fft <- read.xlsx('Data/Global_Carbon_Budget_2018v1.0.xlsx',sheetIndex = 'Fossil Emissions by Fuel Type',startRow = 13,endRow = 2017,colIndex = 1:8)

######### load basic development and emissions data ######### 

load('Data/basic.RData')

## bring in more regional codes
codes <- read.xlsx('C:/Users/lamw/Documents/SpiderOak Hive/Work/Code/R/.Place names and codes/output/ISOcodes.xlsx',sheetName = 'ISO_master')

basic <- left_join(basic,codes %>% select(Code,WB.income),by=c("ISO"="Code")) %>% 
  select(Country,ISO,Year,UN6,RCP5,IAM10,WB.income,pop_UN,everything())

basic$WB.income <- factor(basic$WB.income,levels(basic$WB.income)[c(1,4,3,2)])

# any other adjustments here
basic$UN6 <- gsub("LATIN AMERICA AND THE CARIBBEAN","LATIN AMERICA",basic$UN6)

basic <- basic %>% 
  mutate(gdp_ppp_pc = gdp_ppp_WB/pop_UN)

basic$income_category  <- cut(basic$gdp_ppp_pc,breaks = c(1700,4300,8600,15000,29000,150000),dig.lab=10,include.lowest=TRUE)

######### load edgar data ######### 

load('Data/edgar.RData')

edgar_GHG <- left_join(edgar_GHG,codes %>% select(Country,Code,WB.income),by=c("ISO"="Code"))
edgar_GHG$WB.income <- factor(edgar_GHG$WB.income,levels(edgar_GHG$WB.income)[c(1,4,3,2)])
rm(codes)



```


### GHG emissions by gas (Figure 1)

```{r Figure_1, echo=FALSE,warning=FALSE,fig.width=10,fig.path="Plots/",dev=c('png','pdf')}

blarg <- edgar_GHG %>% 
  group_by(Year) %>% 
  summarise(CO2=sum(CO2,na.rm=T),CH4=sum(CH4,na.rm=T),N2O=sum(N2O,na.rm=T),Fgas=sum(Fgas,na.rm=T))

gather(blarg,gas,value,-Year) %>% 
  ggplot(.,aes(x=Year,y=value,fill=gas)) +
  geom_area()

```

### Long term CO2 emissions sources and sinks (Figure 2)


```{r budget, echo=FALSE,warning=FALSE,fig.width=10,fig.path="Plots/",dev=c('png','pdf')}

plot_data <- gather(gcb,key,value,-Year) %>% 
  filter(key!="Total CO2",key!="Total") %>% 
  filter(Year>=1850) 

plot_data$key <- as.factor(plot_data$key)
plot_data$key <- factor(plot_data$key,levels(plot_data$key)[c(1,2,3,4,6,5)])

p1 <- plot_data %>% 
  ggplot(.,aes(x=Year,y=value,fill=key)) + 
  geom_area() +
  ylab("Carbon emissions (GtCO2/yr)") +
  theme(legend.position = c(0.15,0.75),
        legend.title = element_blank(),
        axis.title.x = element_blank())


future_budget <- data.frame(target=c("1.5oC target","2oC target"),budget=c(500,1000)) %>% 
  mutate(years=ceiling(budget/as.vector(plot_data %>% filter(Year==2017) %>% summarise(total=sum(value)))[[1]]))

p2 <- future_budget %>% 
  ggplot(.,aes(x=target,y=budget)) +
  geom_bar(stat='identity') +
  geom_text(aes(x=target,y=budget+50,label=paste("Years: ",years))) +
  theme(axis.title.x = element_blank()) +
  ylab("Total carbon budget relative to climate targets (GtCO2)")

ggarrange(p1,p2,ncol=2,widths = c(2.5,1))

```



### Regional trends by sector / GHG segment

```{r edgar_prep,include=FALSE}
# 
# sector="Total"
# gas="GHG"
# time_start=2010

edgar_emissions_plot <- function(time_start,sector,gas) {
  
  ##############  calculate growth rates in given time period ############## 
  
  rates <- edgar_GHG %>% 
    filter(category_1==sector) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  ####### CHECK DATA HERE FOR ZEROS AND NANS ####### 
  
  
  # what is 80% of the emissions?
  blarg <- rates %>%
    filter(Year==2017)
  threshold <- sum(blarg$value,na.rm=T)*0.8
  
  ## remove countries below absolute emissions threshold
  
  rates <- rates %>% 
    group_by(Country) %>% 
    mutate(rate=(last(value)/first(value))^(1/(last(Year)-time_start+1))-1) %>% 
    filter(Year==2017) %>% 
    na.omit() %>% 
    arrange(desc(value))
  
  
  rates$cutoff <- 0
  z <- 0
  for (i in 1:length(rates$Country)){
    z <- z + rates$value[i]
    if (z > threshold) {
      break
    }
    rates$cutoff[i] <- 1
  }
  
  country_list <- rates %>% select(Country,cutoff)
  
  #### calculate growth rates for countries below threshold, grouped by region ####
  
  blarg <- edgar_GHG %>% 
    filter(category_1==sector) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  blarg <- left_join(blarg,country_list,by=c("Country"="Country")) %>% 
    filter(cutoff==0) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(WB.income,Year) %>% 
    summarise_at('value',sum,na.rm=TRUE)
  
  blarg <- blarg %>% 
    group_by(WB.income) %>% 
    mutate(rate=(last(value)/first(value))^(1/(last(Year)-time_start+1))-1) %>% 
    filter(Year==2017) %>% 
    na.omit() %>% 
    mutate(Country=paste(WB.income,"(rest)"))
  
  
  ### join and plot
  rates <- rbind(rates %>% filter(cutoff==1) %>% select(-cutoff),blarg)
  
  p2 <- rates %>% 
    ggplot(.,aes(x = reorder(Country,rate), y = rate*100, fill=WB.income)) +
    geom_bar(stat='identity') + 
    ylab(paste("Rate of change in ",gas," emissions (",sector," Sector), ",time_start,"-2017\n (Countries responsible for 80% of sector emissions are shown)",sep="")) +
    coord_flip() +
    theme(legend.position="none",
          axis.title.y = element_blank()) 
  
  
  regions <- left_join(edgar_GHG,country_list,by=c("Country"="Country")) %>%
    filter(category_1==sector) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Country!="World") %>% 
    filter(Year>1979 & Year<2018) %>% 
    filter(cutoff==0) %>% 
    group_by(WB.income,Year) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    mutate(Country=paste(WB.income,"(rest)")) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  rect <- data.frame(xmin=time_start, xmax=2017, ymin=-Inf, ymax=Inf)
  
  p1 <- regions %>%
    ggplot(.,aes(x=Year,y=value,fill=WB.income)) +
    geom_area() +
    geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              fill="grey20",
              alpha=0.35,
              inherit.aes = FALSE) +
    theme(legend.position='bottom',
          legend.title=element_blank(),
          axis.title.x = element_blank()) +
    ylab(paste(gas,"Emissions, Gg CO2eq")) +
    ggtitle(paste(sector,"Sector,",gas,"Emissions"))
  
  
  ############## plot absolute values ############## 
  
  countries <- left_join(edgar_GHG,country_list,by=c("Country"="Country")) %>%
    filter(category_1==sector) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Country!="World") %>% 
    filter(Year>1979 & Year<2018) %>% 
    filter(cutoff==1) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  plot_data <- rbind(countries,regions) %>% 
    filter(Year==2017)
  
  library(treemapify)
  
  # p3 <- plot_data %>% ggplot(.,aes(area=value,fill=WB.income,subgroup=WB.income,label=Country)) +
  #   geom_treemap() +
  #   geom_treemap_text(reflow=TRUE,min.size=2) +
  #   theme(legend.position='none',
  #         plot.margin = unit(c(0,0,0,2.5),"cm")) +
  #   xlab("Distribution of total sector emissions")
  
  
  # blarg <- plot_data %>% 
  #   arrange(desc(value))
  # 
  # plot_data$ordered <- factor(plot_data$Country,levels=blarg$Country)
  # 
  # p3 <- plot_data %>% 
  #   ggplot(.,aes(x=Year,y=value,fill=WB.income,group=ordered)) +
  #   geom_bar(stat='identity')
  
  
  p4 <- ggarrange(p1,p2,ncol=1,nrow=2)
  return(p4)
}

# blarg <asd- edgar_GHG %>% 
#   group_by(Year,WB.income) %>% 
#   summarise(total_GHG=sum(total_GHG))
# 
# blarg %>% 
#   ggplot(.,aes(x=Year,y=total_GHG,fill=WB.income)) +
#   geom_area() +
#   theme(legend.position='bottom',
#         legend.title=element_blank())

```


```{r edgar_plots, echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="Plots/",dev=c('png','pdf')}

#### 


time_start = 2010

plot_energy_GHG <- edgar_emissions_plot(time_start,'Energy','GHG')
plot_energy_GHG

plot_industry_GHG <- edgar_emissions_plot(time_start,'Industrial Processes','GHG')
plot_industry_GHG

plot_transport_GHG <- edgar_emissions_plot(time_start,'Solvent and Other Product Use','GHG')
plot_transport_GHG

plot_buildings_GHG <- edgar_emissions_plot(time_start,'Agriculture','GHG')
plot_buildings_GHG

plot_AFOLU_GHG <- edgar_emissions_plot(time_start,'Other (please specify)','GHG')
plot_AFOLU_GHG

plot_AFOLU_GHG <- edgar_emissions_plot(time_start,'Waste','GHG')
plot_AFOLU_GHG

plot_total_GHG <- edgar_emissions_plot(time_start,'Total','GHG')
plot_total_GHG

```






```