---
title: "Emissions trends and drivers: sectoral trends"
author: "William F. Lamb, Jan C. Minx"
output: 
  word_document:
    toc: yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Results") })
---
# Summary
This document provides an overview and breakdown of emissions trends by IPCC chapter. We have compiled a consistent allocation of emissions categories to sectors using the EDGAR emissions database. We propose to use this allocation and the following figures across the main sectoral chapters (#6 Energy systems, #7 AFOLU, #9 Buildings, #10 Transport, #11 Industry).

The following supporting information is available online: 
- our code in R
- the sector categorisations
- the figure files
- the data files for each figure (the full EDGAR database must remain private)
- this document and any updates
Please find these at: https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers

Latest update: `r format(Sys.time(), '%d %B, %Y, %H:%M')`

**Author information**

William F. Lamb - Mercator Research Institute on Global Commons and Climate Change (MCC); School of Earth and Environment, University of Leeds; Contributing Author in Chapter 2 of the Working Group III Report (Emissions Trends and Drivers); lamb@mcc-berlin.net

Jan C. Minx - Mercator Research Institute on Global Commons and Climate Change (MCC); School of Earth and Environment, University of Leeds; Lead Author in Chapter 2 of the Working Group III Report (Emissions Trends and Drivers); minx@mcc-berlin.net


```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)

```

# Classification of emissions sources

```{r classification, echo=FALSE, warning=FALSE}

load('../Data/ipcc_categories.RData')
load('../Data/edgar.RData')
library(flextable)

categories <- ipcc_categories %>% 
  select(Code=code,Chapter=IPCC_AR6_chapter,Description=description,Cat1=category_1,Cat2=category_2,Cat3=category_3)
categories$Chapter <- as.factor(categories$Chapter)

myft <- flextable(categories,col_keys=names(categories))
myft

```





```{r edgar_prep,include=FALSE}

sector=8
gas="GHG"
time_start=2010
category="chapter"
rate_or_abs="rate"


library(openxlsx)

######### load edgar data ######### 

load('../Data/edgar.RData')

edgar_emissions_plot <- function(time_start,category,sector,gas,rate_or_abs) {
  
  ##############  calculate growth rates in given time period ############## 
  
  #sector_code <- edgar_GHG %>%
  #  filter_at(vars(category),all_vars(.==sector))
  #sector_code <- substr(sector_code$sector_code[[1]],1,as.numeric(str_sub(category,-1)))
  
  rates <- edgar_GHG %>% 
    filter_at(vars(category),all_vars(.==sector)) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  ####### CHECK DATA HERE FOR ZEROS AND NANS ####### 
  
  
  # what is 80% of the emissions?
  blarg <- rates %>%
    filter(Year==2017)
  threshold <- sum(blarg$value,na.rm=T)*0.8
  
  ## remove countries below absolute emissions threshold
  
  rates <- rates %>% 
    group_by(Country) %>% 
    mutate(rate=(last(value)/first(value))^(1/(last(Year)-time_start+1))-1) %>% 
    mutate(abs_growth=last(value)-first(value)) %>%
    filter(Year==2017) %>% 
    na.omit() %>% 
    arrange(desc(value))
  
  
  rates$cutoff <- 0
  z <- 0
  for (i in 1:length(rates$Country)){
    z <- z + rates$value[i]
    if (z > threshold) {
      break
    }
    rates$cutoff[i] <- 1
  }
  
  country_list <- rates %>% select(Country,cutoff)
  
  #### calculate growth rates for countries below threshold, grouped by region ####
  
  blarg <- edgar_GHG %>% 
    filter_at(vars(category),all_vars(.==sector)) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  blarg <- left_join(blarg,country_list,by=c("Country"="Country")) %>% 
    filter(cutoff==0) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(WB.income,Year) %>% 
    summarise_at('value',sum,na.rm=TRUE)
  
  blarg <- blarg %>% 
    group_by(WB.income) %>% 
    mutate(rate=(last(value)/first(value))^(1/(last(Year)-time_start+1))-1) %>% 
    mutate(abs_growth=last(value)-first(value)) %>%
    filter(Year==2017) %>% 
    na.omit() %>% 
    mutate(Country=paste(WB.income,"(rest)"))
  
  
  ### join and plot
  rates <- rbind(rates %>% filter(cutoff==1) %>% select(-cutoff),blarg)
  
    rates <- gather(rates %>% mutate(rate=rate*100),var,value,rate:abs_growth)
  
  p2 <- rates %>% 
    filter(var==rate_or_abs) %>% 
    ggplot(.,aes(x = reorder(Country,value),y = value, fill=WB.income)) +
    geom_bar(stat='identity') + 
    ylab(paste(ifelse(rate_or_abs=="rate","Rate of","Absolute")," change in ",gas," emissions (Sector ",sector,") ",time_start,"-2017\n (Countries responsible for 80% of sector emissions are shown)",sep="")) +
    coord_flip() +
    theme_bw() +
    theme(legend.position="none",
          axis.title.y = element_blank()) 

  regions <- left_join(edgar_GHG,country_list,by=c("Country"="Country")) %>%
    filter_at(vars(category),all_vars(.==sector)) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Country!="World") %>% 
    filter(Year>1979 & Year<2018) %>% 
    filter(cutoff==0) %>% 
    group_by(WB.income,Year) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    mutate(Country=paste(WB.income,"(rest)")) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  rect <- data.frame(xmin=time_start, xmax=2017, ymin=-Inf, ymax=Inf)
  
  p1 <-regions %>%
    ggplot(.,aes(x=Year,y=value,fill=WB.income)) +
    geom_area() +
    geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              fill="grey20",
              alpha=0.35,
              inherit.aes = FALSE) +
    theme_bw() +
    theme(legend.position='bottom',
          legend.title=element_blank(),
          axis.title.x = element_blank()) +
    ylab(paste(gas,"Emissions, Gg CO2eq")) +
    ggtitle(paste("IPCC Sector ",sector,", ",gas," Emissions",sep=""))
  
  
  ############## plot absolute values ############## 
  
  countries <- left_join(edgar_GHG,country_list,by=c("Country"="Country")) %>%
    filter_at(vars(category),all_vars(.==sector)) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Country!="World") %>% 
    filter(Year>1979 & Year<2018) %>% 
    filter(cutoff==1) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  
  p4 <- ggarrange(p1,p2,ncol=1,nrow=2)
  return(list("plot"=p4,"data"=rates))
}


```

# Total sector trends & rates of change


```{r total_sector_trends,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

########### total sector emissions



########### create totals
load('../Data/edgar.RData')
totals <- edgar_GHG %>% 
  group_by(ISO,Year,WB.income,Country) %>% 
  summarise(CO2=sum(CO2,rm.na=T),CH4=sum(CH4,rm.na=T),N2O=sum(N2O,rm.na=T),Fgas=sum(Fgas,rm.na=T),GHG=sum(GHG,rm.na=T)) %>% 
  mutate(sector_code="Total",category_final="Total",category_1="Total",category_2="Total",category_3="Total",IPCC_AR5_chapter=0,IPCC_AR5_sector=0) %>% 
  select(ISO,sector_code,category_final,category_1,category_2,category_3,Year,CO2,CH4,N2O,Fgas,GHG,Country,WB.income,IPCC_AR5_chapter,IPCC_AR5_sector)

edgar_GHG <- edgar_GHG %>% 
  bind_rows(totals)

p <- edgar_emissions_plot(2010,"sector_code","Total","GHG",'rate')
p$plot
rm(edgar_GHG)

#write.xlsx(p$data %>% select(-Year),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName="Total_GHGs_2010",append=TRUE)


```

### Regional trends & rates of change by IPCC sector


```{r edgar_plots_rates,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}


########### rates of change: sectors 7-11
load('../Data/edgar.RData')
c=1
data = data.frame()
plot_list = list()
time_start = 2010
category = 'chapter'
gas = 'GHG'

for (i in 6:7) {
  
  p <- edgar_emissions_plot(time_start,category,i,gas,'rate')
  plot_list[[c]] <- p$plot
  
  #if (c==1) {
  #  data <- p$data %>% 
  #    mutate(run=paste(category,i,gas,time_start,sep="_"))
  #} else {
  #  data <- rbind(data,p$data %>% mutate(run=paste(category,i,gas,time_start,sep="_")))
  #}
  
  c=c+1
  
}
for (i in 9:11) {
  
  p <- edgar_emissions_plot(time_start,category,i,gas,'rate')
  plot_list[[c]] <- p$plot
  c=c+1
  
}

plot_list

#write.xlsx(data %>% select(-Year),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName=paste(category,gas,time_start,sep="_"),append=TRUE)


```

### Regional trends & absolute change by IPCC sector


```{r edgar_plots_abs,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

########### absolute growth: sectors 7-11
# c=1
# data = data.frame()
# plot_list = list()
# time_start = 2010
# category = 'chapter'
# gas = 'GHG'
# 
# for (i in 7:11) {
#   
#   p <- edgar_emissions_plot(time_start,category,i,gas,'abs_growth')
#   
#   plot_list[[c]] <- p$plot
#   
#   if (c==1) {
#     data <- p$data %>% 
#       mutate(run=paste(category,i,gas,time_start,sep="_"))
#   } else {
#     data <- rbind(data,p$data %>% mutate(run=paste(category,i,gas,time_start,sep="_")))
#   }
#   
#   c=c+1
#   
# }
# plot_list
# 


```