---
title: "Emissions trends and drivers: sectoral trends"
author: "William F. Lamb, Jan C. Minx"
output: 
  word_document:
    toc: yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Results") })
---
# Summary
This document provides an overview and breakdown of emissions trends by IPCC chapter. We have compiled a consistent allocation of emissions categories to sectors using the EDGAR emissions database. We propose to use this allocation and the following figures across the main sectoral chapters of AR6.

The following supporting information is available online: 

* our code in R
* the sector categorisations
* the figure files
* the data files for each figure
* this document and any updates

Please find these at: https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers

Latest update: `r format(Sys.time(), '%d %B, %Y, %H:%M')`

**Author information**

William F. Lamb - Mercator Research Institute on Global Commons and Climate Change (MCC); School of Earth and Environment, University of Leeds; Contributing Author in Chapter 2 of the Working Group III Report (Emissions Trends and Drivers); lamb@mcc-berlin.net

Jan C. Minx - Mercator Research Institute on Global Commons and Climate Change (MCC); School of Earth and Environment, University of Leeds; Lead Author in Chapter 2 of the Working Group III Report (Emissions Trends and Drivers); minx@mcc-berlin.net


```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)
library(flextable)
library(openxlsx)


```

``` {r trend_figure,include=FALSE}

trend_figure <- function(time_start,category,sector,gas) {
  
  data <- edgar_GHG %>%
    filter_at(vars(category),all_vars(.==sector)) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Country!="World") %>% 
    filter(Year>1979 & Year<2018) %>% 
    #filter(cutoff==0) %>% 
    group_by(WB.income,Year) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    rename_at(gas,funs(sprintf('value')))
  
  #rect <- data.frame(xmin=time_start, xmax=2017, ymin=-Inf, ymax=Inf)
  
  p <- data %>%
    ggplot(.,aes(x=Year,y=value/1e6,fill=WB.income)) +
    geom_area(color='#737373') +
    #geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
    #          fill="grey20",
    #          alpha=0.35,
    #          inherit.aes = FALSE) +
    theme_bw() +
    theme(legend.justification=c(0,1), 
          legend.position=c(0.05, 0.97),
          legend.title=element_blank(),
          legend.background = element_blank(),
          legend.spacing.x = unit(0.2,'cm'),
          axis.title.x = element_blank()) +
    ylab(bquote(.(gas) ~" Emissions (Gt" ~CO[2]* "eq)"))

  return(list("plot"=p,"data"=data))
  
}



```



```{r decomp_figure,include=FALSE}

sector=6
gas="GHG"
time_start=2010
category="chapter"

decomp_figure <- function(time_start,category,sector,gas) {
  
  ##############  calculate growth rates in given time period ############## 
  
  rates <- edgar_GHG %>% 
    filter_at(vars(category),all_vars(.==sector)) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  ####### CHECK DATA HERE FOR ZEROS AND NANS ####### 
  
  
  # what is 80% of the emissions?
  blarg <- rates %>%
    filter(Year==2017)
  threshold <- sum(blarg$value,na.rm=T)*0.8
  
  ## remove countries below absolute emissions threshold
  
  rates <- rates %>% 
    group_by(Country) %>% 
    mutate(rate=(last(value)/first(value))^(1/(last(Year)-time_start+1))-1) %>% 
    mutate(abs_growth=last(value)-first(value)) %>%
    filter(Year==2017) %>% 
    na.omit() %>% 
    arrange(desc(value))
  
  
  rates$cutoff <- 0
  z <- 0
  for (i in 1:length(rates$Country)){
    z <- z + rates$value[i]
    if (z > threshold) {
      break
    }
    rates$cutoff[i] <- 1
  }
  
  country_list <- rates %>% select(Country,cutoff)
  
  #### calculate growth rates for countries below threshold, grouped by region ####
  
  blarg <- edgar_GHG %>% 
    filter_at(vars(category),all_vars(.==sector)) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(Country,Year,WB.income) %>% 
    summarise_at(gas,sum,na.rm=TRUE) %>% 
    ungroup() %>% 
    rename_at(gas,funs(sprintf('value')))
  
  blarg <- left_join(blarg,country_list,by=c("Country"="Country")) %>% 
    filter(cutoff==0) %>% 
    filter(!is.na(WB.income)) %>% 
    filter(Year>=time_start & Year<2018) %>% 
    group_by(WB.income,Year) %>% 
    summarise_at('value',sum,na.rm=TRUE)
  
  blarg <- blarg %>% 
    group_by(WB.income) %>% 
    mutate(rate=(last(value)/first(value))^(1/(last(Year)-time_start+1))-1) %>% 
    mutate(abs_growth=last(value)-first(value)) %>%
    filter(Year==2017) %>% 
    na.omit() %>% 
    mutate(Country=paste(WB.income,"(rest)"))
  
  
  ### join and plot
  rates <- rbind(rates %>% filter(cutoff==1) %>% select(-cutoff),blarg)
  rates <- gather(rates %>% mutate(rate=rate*100),var,value,rate:abs_growth)
  
  ### shortened names
  
  rates <- rates %>%
    ungroup() %>% 
    mutate(Country = ifelse(Country=="High income (rest)","HI (rest)",Country)) %>% 
    mutate(Country = ifelse(Country=="Low income (rest)","LI (rest)",Country)) %>% 
    mutate(Country = ifelse(Country=="Lower middle income (rest)","LMI (rest)",Country)) %>% 
    mutate(Country = ifelse(Country=="Upper middle income (rest)","UMI (rest)",Country))
    
  
  
  #rate
  p1 <- rates %>% 
    filter(var=="rate") %>% 
    ggplot(.,aes(x = reorder(Country,value),y = value, fill=WB.income)) +
    geom_bar(stat='identity') + 
    ylab(bquote(atop("Rate of change in" ~.(gas) ~ " Emissions","(Gt" ~CO[2]* "eq),"~.(time_start)*"-2017"))) +
    #ylab(paste("Rate of change in ",gas," emissions,\n",time_start,"-2017 (GtCO2eq/yr)",sep="")) +
    coord_flip() +
    theme_bw() +
    theme(legend.position="none",
          axis.title.y = element_blank()) 
  
  
  #absolute
  p2 <- rates %>% 
    filter(var=="abs_growth") %>% 
    ggplot(.,aes(x = reorder(Country,value),y = value/1e6, fill=WB.income)) +
    geom_bar(stat='identity') + 
    ylab(bquote(atop("Absolute change in" ~.(gas) ~ " Emissions","(Gt" ~CO[2]* "eq),"~.(time_start)*"-2017"))) +
    #ylab(paste("Absolute change in ",gas," emissions,\n",time_start,"-2017 (GtCO2eq/yr)",sep="")) +
    coord_flip() +
    theme_bw() +
    theme(legend.position="none",
          axis.title.y = element_blank()) 

  return(list("rate_plot"=p1,"abs_plot"=p2,"data"=rates))
}


```

``` {r make_table, include=FALSE}

make_table <- function(data) {
  
  ft <- flextable(data,col_keys=names(data))
  ft <- autofit(ft)
  ft <- fontsize(ft, size = 8,part="all")
  ft <- height_all(ft,0.1)
  ft <- width(ft,j=3,width=5)
  ft <- align(ft,align="left",part="all")
  
  return(ft)
}


```

```{r bar_figure,include=FALSE}

sector=6
gas="GHG"
time_start=2010
category="chapter"

bar_figure <- function(category,sector,gas) {

  data <- edgar_GHG %>% 
    filter(Year==2017) %>% 
    group_by(chapter) %>% 
    summarise_at(gas,sum) %>% 
    filter(!is.na(chapter)) %>% 
    arrange(desc(GHG))
  
  total = sum(data$GHG)
  
  data <- data %>% 
    mutate(fraction=round(GHG/total*100)) %>% 
    mutate(alpha=if_else(chapter==ch,TRUE,FALSE))
  
  data <- data %>% 
    mutate(title=if_else(chapter==6,"Energy","title")) %>% 
    mutate(title=if_else(chapter==7,"AFOLU",title)) %>% 
    mutate(title=if_else(chapter==9,"Buildings",title)) %>% 
    mutate(title=if_else(chapter==10,"Transport",title)) %>%
    mutate(title=if_else(chapter==11,"Industry",title))
  
  p <- data %>% 
    ggplot(.,aes(y=reorder(fraction,fraction),x=as.factor(1),alpha=alpha)) +
    geom_bar(stat='identity',size=0.5,fill="#252525",color="#737373",width=0.9)  +
    scale_alpha_discrete(range = c(0.25, 0.6)) +
    theme_bw() +
    coord_flip() +
    geom_text(aes(label = paste0(title," - ",fraction,"%")), 
              position = position_stack(vjust = 0.5),alpha=1) +
    ylab("Fraction of total emissions") +
    xlab(" ") +
    theme(legend.position="none",
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
  
  return(p)
  
}

```

# 1. All sectors

```{r total_sector_trends,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

########### create totals ###########
load('../Data/edgar.RData')
totals <- edgar_GHG %>% 
  group_by(ISO,Year,WB.income,Country) %>% 
  summarise(CO2=sum(CO2,rm.na=T),CH4=sum(CH4,rm.na=T),N2O=sum(N2O,rm.na=T),Fgas=sum(Fgas,rm.na=T),GHG=sum(GHG,rm.na=T)) %>% 
  mutate(sector_code="Total",category_final="Total",category_1="Total",category_2="Total",category_3="Total",IPCC_AR5_chapter=0,IPCC_AR5_sector=0) %>% 
  select(ISO,sector_code,category_final,category_1,category_2,category_3,Year,CO2,CH4,N2O,Fgas,GHG,Country,WB.income,IPCC_AR5_chapter,IPCC_AR5_sector)

edgar_GHG <- edgar_GHG %>% 
  bind_rows(totals)

########### Trend figure ###########

trend <- trend_figure(2010,"sector_code","Total","GHG")
p1 <- trend$plot
p1 <- p1 + ggtitle("All sectors, GHG Emissions")
d1 <- trend$data

########### Decomposition figure ###########

decomp <- decomp_figure(2010,'sector_code','Total','GHG')
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.4,0.6))
plot

rm(edgar_GHG)

#write.xlsx(p$data %>% select(-Year),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName="Total_GHGs_2010",append=TRUE)


```

# 2. Energy systems (Ch.6)

```{r energy_systems,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

load('../Data/edgar.RData')
ch = 6

########### Bar figure 

bar <- bar_figure("chapter",ch,"GHG")

########### Trend figure ###########

trend <- trend_figure(2010,'chapter',ch,'GHG')
p1 <- trend$plot

p1 <- ggarrange(trend$plot,bar,nrow=2,ncol=1,heights = c(0.8,0.2))
#p1 <- p1 + ggtitle("Energy systems, GHG Emissions")
d1 <- trend$data

########### Decomposition figure ###########

decomp <- decomp_figure(2010,'chapter',ch,'GHG')
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.5,0.5))
plot <- annotate_figure(plot,
  top = text_grob("Energy systems, GHG Emissions", size = 14,hjust=1.32))
plot


###### document emissions categories #####
categories <- edgar_GHG %>% 
  select(chapter,sector_code,description) %>% 
  distinct(.keep_all = TRUE) %>% 
  filter(chapter==ch)
categories$chapter <- as.factor(categories$chapter)

table <- make_table(categories)
table

```

# 2. AFOLU (Ch.7)

```{r AFOLU,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

load('../Data/edgar.RData')
ch = 7

########### Bar figure 

bar <- bar_figure("chapter",ch,"GHG")

########### Trend figure ###########

trend <- trend_figure(2010,'chapter',ch,'GHG')
p1 <- trend$plot

p1 <- ggarrange(trend$plot,bar,nrow=2,ncol=1,heights = c(0.8,0.2))
#p1 <- p1 + ggtitle("Energy systems, GHG Emissions")
d1 <- trend$data

########### Decomposition figure ###########

decomp <- decomp_figure(2010,'chapter',ch,'GHG')
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.5,0.5))
plot <- annotate_figure(plot,
  top = text_grob("AFOLU, GHG Emissions", size = 14,hjust=1.32))
plot


###### document emissions categories #####
categories <- edgar_GHG %>% 
  select(chapter,sector_code,description) %>% 
  distinct(.keep_all = TRUE) %>% 
  filter(chapter==ch)
categories$chapter <- as.factor(categories$chapter)

table <- make_table(categories)
table

```

# 4. Buildings (Ch.9)

```{r buildings,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

load('../Data/edgar.RData')
ch = 9

########### Bar figure 

bar <- bar_figure("chapter",ch,"GHG")

########### Trend figure ###########

trend <- trend_figure(2010,'chapter',ch,'GHG')
p1 <- trend$plot

p1 <- ggarrange(trend$plot,bar,nrow=2,ncol=1,heights = c(0.8,0.2))
#p1 <- p1 + ggtitle("Energy systems, GHG Emissions")
d1 <- trend$data

########### Decomposition figure ###########

decomp <- decomp_figure(2010,'chapter',ch,'GHG')
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.5,0.5))
plot <- annotate_figure(plot,
  top = text_grob("Buildings, GHG Emissions", size = 14,hjust=1.32))
plot


###### document emissions categories #####
categories <- edgar_GHG %>% 
  select(chapter,sector_code,description) %>% 
  distinct(.keep_all = TRUE) %>% 
  filter(chapter==ch)
categories$chapter <- as.factor(categories$chapter)

table <- make_table(categories)
table
```

# 5. Transport (Ch.10)

```{r transport,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}


load('../Data/edgar.RData')
ch = 10

########### Bar figure 

bar <- bar_figure("chapter",ch,"GHG")

########### Trend figure ###########

trend <- trend_figure(2010,'chapter',ch,'GHG')
p1 <- trend$plot

p1 <- ggarrange(trend$plot,bar,nrow=2,ncol=1,heights = c(0.8,0.2))
#p1 <- p1 + ggtitle("Energy systems, GHG Emissions")
d1 <- trend$data

########### Decomposition figure ###########

decomp <- decomp_figure(2010,'chapter',ch,'GHG')
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.5,0.5))
plot <- annotate_figure(plot,
  top = text_grob("Transport, GHG Emissions", size = 14,hjust=1.32))
plot


###### document emissions categories #####
categories <- edgar_GHG %>% 
  select(chapter,sector_code,description) %>% 
  distinct(.keep_all = TRUE) %>% 
  filter(chapter==ch)
categories$chapter <- as.factor(categories$chapter)

table <- make_table(categories)
table

```

# 6. Industry (Ch.11)

```{r industry,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

load('../Data/edgar.RData')
ch = 11

########### Bar figure 

bar <- bar_figure("chapter",ch,"GHG")

########### Trend figure ###########

trend <- trend_figure(2010,'chapter',ch,'GHG')
p1 <- trend$plot

p1 <- ggarrange(trend$plot,bar,nrow=2,ncol=1,heights = c(0.8,0.2))
#p1 <- p1 + ggtitle("Energy systems, GHG Emissions")
d1 <- trend$data

########### Decomposition figure ###########

decomp <- decomp_figure(2010,'chapter',ch,'GHG')
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.5,0.5))
plot <- annotate_figure(plot,
  top = text_grob("Industry, GHG Emissions", size = 14,hjust=1.32))
plot


###### document emissions categories #####
categories <- edgar_GHG %>% 
  select(chapter,sector_code,description) %>% 
  distinct(.keep_all = TRUE) %>% 
  filter(chapter==ch)
categories$chapter <- as.factor(categories$chapter)

table <- make_table(categories)
table

```
