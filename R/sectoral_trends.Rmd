---
title: "Emissions trends and drivers: sectoral trends"
author: "William F. Lamb"
output: 
  word_document:
    toc: yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Results") })
---


```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)
library(ggplot2); theme_set(theme_bw())
library(RColorBrewer)

source("small_figures.R")
source("decomp_figure_countries.R")
source("decomp_figure_sectors.R")
source("waterfall_plot.R")


load('../Data/edgar_data_gwp_ar6.RData')
load('../Data/gwps.RData')

wb <- openxlsx::createWorkbook(title = paste("ipcc_sector_data",Sys.Date()))

chapters = edgar_GHG_ar6 %>% 
  select(chapter,chapter_title) %>% 
  distinct()


blarg <- edgar_GHG_ar6 %>% 
  group_by(ISO,subsector_title) %>% 
  summarise(GHG=sum(GHG,na.rm=TRUE))

regions <- edgar_GHG_ar6 %>% 
  select(region_ar6_10) %>% 
  distinct()

regions <- cbind(regions,data.frame(region_ar6_10_short=c("N. America","Latin Am.","Africa","Europe","Eurasia","Middle E.","S. Asia","E. Asia","S.E. Asia","A. Pacific","AIR","SEA")))

edgar_GHG_ar6 <- left_join(edgar_GHG_ar6,regions,by = "region_ar6_10")


wb <- openxlsx::createWorkbook(title = paste("ipcc_sector_trend_plots",Sys.Date()))


```

```{r sector_trends_5,echo=FALSE,warning=FALSE,fig.width=8,fig.height=4,fig.path="../Results/Plots/",dev=c('png','pdf')}

# sectors <- edgar_GHG_ar6 %>% 
#   filter(region_ar6_5!="Intl. Aviation") %>% 
#   filter(region_ar6_5!="Intl. Shipping") %>% 
#   filter(year %in% c(1990,2000,2010,2018)) %>% 
#   group_by(chapter,chapter_title,region_ar6_5,year) %>% 
#   summarise(GHG=sum(GHG,na.rm=TRUE)/1e9) %>% 
#   mutate(year=as.factor(year))
# 
# sectors %>% ggplot(.,aes(x=year,y=GHG,fill=region_ar6_5)) +
#   geom_bar(stat='identity',colour="#737373") +
#   facet_grid(.~chapter_title) +
#   ylab('GHG Emissions (GtCO2eq/yr)') +
#   theme_bw() +
#   theme(legend.position=c(.2,.8),
#         legend.title = element_blank(),
#         axis.title.x = element_blank())

```


```{r sector_trends_10,echo=FALSE,warning=FALSE,fig.width=8,fig.height=4,fig.path="../Results/Plots/",dev=c('png','pdf')}

# sectors <- edgar_GHG_ar6 %>% 
#   filter(region_ar6_10!="Intl. Aviation") %>% 
#   filter(region_ar6_10!="Intl. Shipping") %>% 
#   filter(year %in% c(1990,2000,2010,2018)) %>% 
#   group_by(chapter,chapter_title,region_ar6_10,year) %>% 
#   summarise(GHG=sum(GHG,na.rm=TRUE)/1e9) %>% 
#   mutate(year=as.factor(year))
# 
# sectors %>% ggplot(.,aes(x=year,y=GHG,fill=region_ar6_10)) +
#   geom_bar(stat='identity',colour="#737373") +
#   facet_grid(.~chapter_title) +
#   ylab('GHG Emissions (GtCO2eq/yr)') +
#   theme_bw() +
#   theme(legend.position="bottom",
#         legend.title = element_blank(),
#         axis.title.x = element_blank())

```

```{r figure_code,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=7,fig.path="../Results/Plots/",dev=c('png','pdf')}



sector_figure <- function(chapter,edgar_GHG_ar6) {
  
  ## Bar figure
  #bar <- bar_figure("chapter",ch,"GHG",edgar_GHG_ar6)
  
  ## Trend figure
  trend_data <- edgar_GHG_ar6 %>%
    filter(year>1989) %>% 
    filter(chapter==ch) %>% 
    group_by(year,subsector,subsector_title) %>% 
    summarise(value=sum(GHG,na.rm=TRUE)) %>% 
    mutate(value=value/1e9)
  
  ## align labels
  labels <- trend_data %>%
    filter(year==2018) %>% 
    arrange(desc(subsector_title))
  
  labels$cum <- cumsum(labels$value)
  
  for (j in 1:length(labels$year)) {
    labels$location[j] = labels$value[j]*0.5
  }
  for (j in 2:length(labels$year)) {
    labels$location[j] = labels$location[j] + labels$cum[j-1]
  }
  
  ## calculate shares
  shares <- trend_data %>% 
    filter(year %in% c(1990,2000,2010,2018)) %>% 
    group_by(year) %>% 
    mutate(totals=sum(value)) %>% 
    ungroup() %>% 
    group_by(year,subsector) %>% 
    mutate(fractions=(value/totals)*100) %>% 
    ungroup()

  shares <- locate_shares(shares,"subsector",4)
  
  p1 <- trend_data %>%
    ggplot(.,aes(x=year,y=value,fill=subsector_title)) +
    geom_area(color='#737373') +
    
    geom_vline(xintercept=c(1990,2000,2010,2018),alpha=0.3,linetype="dashed") +
    geom_text(data=shares %>% filter(subsector==shares$subsector[1]),aes(x=year,y=max(shares$totals+1),label=paste(round(totals,1),  "Gt")),size=3.5,colour="#252525")+
    
    #geom_text(data=labels,aes(x=year+1,y=location,label=subsector_title),hjust=0) +
    
    scale_x_continuous(breaks=c(1990,2000,2010,2018)) +
    scale_fill_brewer(type = "qual",palette="Set2") +
  
    big_trend_theme +
    ggtitle(paste0("a. ",chapters$chapter_title[i], " global GHG emissions trends")) +
    theme(legend.position="right",
          axis.title.x = element_blank(),
          legend.title=element_blank(),
          legend.spacing.x= unit(0.25, 'cm')) +
    ylab(bquote(.(gas) ~" Emissions (Gt" ~CO[2]* "eq)"))
  
  
  ## Region figure
  region_data <- edgar_GHG_ar6 %>% 
    #filter(region_ar6_5!="Intl. Aviation") %>% 
    #filter(region_ar6_5!="Intl. Shipping") %>% 
    filter(chapter==ch) %>% 
    filter(year %in% c(1990,2000,2010,2018)) %>% 
    group_by(subsector,subsector_title,region_ar6_10,region_ar6_10_short,year) %>% 
    summarise(value=sum(GHG,na.rm=TRUE)) %>% 
    mutate(value=value/1e9) %>% 
    mutate(year=as.factor(year))
  
  # if (ch==10) {
  #   
  #   region_data <- region_data %>% 
  #     ungroup() %>% 
  #     mutate(value=ifelse(region_ar6_5=="Intl. Aviation",0,value)) %>% 
  #     mutate(value=ifelse(region_ar6_5=="Intl. Shipping",0,value))
  #   
  #   region_data$region_ar6_5_short[region_data$region_ar6_5_short=="AIR"] <- "APC"  
  #   region_data$region_ar6_5_short[region_data$region_ar6_5_short=="SEA"] <- "APC"  
  #   
  # }  else {
  #   
  #   region_data <- region_data %>% 
  #     filter(region_ar6_5!="Intl. Aviation") %>% 
  #     filter(region_ar6_5!="Intl. Shipping") 
  #   
  # }
  
  if (ch==10) {
    
    region_data <- region_data %>% 
      ungroup() %>% 
      mutate(value=ifelse(region_ar6_10_short=="AIR",0,value)) %>% 
      mutate(value=ifelse(region_ar6_10_short=="SEA",0,value))
    
    region_data$region_ar6_10_short[region_data$region_ar6_10_short=="AIR"] <- "A. Pacific"  
    region_data$region_ar6_10_short[region_data$region_ar6_10_short=="SEA"] <- "A. Pacific"  
    
  }  else {
    
    region_data <- region_data %>% 
      filter(region_ar6_10!="Intl. Aviation") %>% 
      filter(region_ar6_10!="Intl. Shipping") 
    
  }
  
  region_data <- region_data %>% 
    group_by(subsector,year) %>% 
    mutate(total=sum(value)) %>% 
    ungroup() %>% 
    group_by(subsector,subsector_title,region_ar6_10,region_ar6_10_short,year) %>% 
    mutate(fraction=value/total*100)
  

  p2 <- region_data %>% ggplot(.,aes(x=year,y=fraction,fill=region_ar6_5_short)) +
    geom_bar(stat='identity',colour="#737373") +
    facet_grid(.~subsector_title) +
    ylab("Fraction of total subsector emissions (%)") +
    big_trend_theme +
    scale_fill_brewer(type = "qual",palette="Set2") +
    theme(legend.position="right",
          axis.title.x = element_blank(),
          legend.title=element_blank())
  
  p3 <- region_data %>% ggplot(.,aes(x=year,y=value,fill=region_ar6_5_short)) +
    geom_bar(stat='identity',colour="#737373") +
    facet_grid(.~subsector_title) +
    ylab(bquote(.(gas) ~" Emissions (Gt" ~CO[2]* "eq)")) +
    #ggtitle(paste0(chapters$chapter_title[i], " sector regional emissions trends")) +
    big_trend_theme +
    scale_fill_brewer(type = "qual",palette="Set2") +
    theme(legend.position="right",
          axis.title.x = element_blank(),
          legend.title=element_blank())
  
  p4 <- region_data %>% ggplot(.,aes(x=year,y=value,fill=subsector_title)) +
    geom_bar(stat='identity',colour="#737373") +
    facet_grid(.~region_ar6_10_short) +
    ylab(bquote(.(gas) ~" Emissions (Gt" ~CO[2]* "eq)")) +
    scale_fill_brewer(type = "qual",palette="Set2") +
    ggtitle(paste0("b. ",chapters$chapter_title[i], " regional GHG emissions trends")) +
    big_trend_theme +
    theme(legend.position="none",
          axis.title.x = element_blank(),
          legend.title=element_blank(),
          axis.text.x = element_text(angle = 45,hjust=1),
          legend.spacing.x= unit(0.25, 'cm'))
  
  
  return(list("p1"=p1,"p2"=p2,"p3"=p3,"p4"=p4,"trend_data"=trend_data,"region_data"=region_data))
  
}
  

```

# Energy

```{r energy,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=6,fig.path="../Results/Plots/",dev=c('png','pdf')}


## Which chapter?
i=1
ch = chapters$chapter[i]

plot <- sector_figure(ch,edgar_GHG_ar6)
ggarrange(plot$p1,plot$p4,nrow=2,align = "h")


openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," trend"))
openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," regions"))
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," trend"), spread(plot$trend_data,year,value), colNames = T, rowNames = F)
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," regions"), spread(plot$region_data %>% select(-total,-fraction),year,value), colNames = T, rowNames = F)






```

# Industry

```{r industry,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=6,fig.path="../Results/Plots/",dev=c('png','pdf')}


## Which chapter?
i=2
ch = chapters$chapter[i]


plot <- sector_figure(ch,edgar_GHG_ar6)
ggarrange(plot$p1,plot$p4,nrow=2,align = "h")
#ggarrange(plot$p3,plot$p2,nrow=2)


openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," trend"))
openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," regions"))
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," trend"), spread(plot$trend_data,year,value), colNames = T, rowNames = F)
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," regions"), spread(plot$region_data %>% select(-total,-fraction),year,value), colNames = T, rowNames = F)

```

# Transport

```{r transport,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=6,fig.path="../Results/Plots/",dev=c('png','pdf')}


## Which chapter?
i=3
ch = chapters$chapter[i]

plot <- sector_figure(ch,edgar_GHG_ar6)
ggarrange(plot$p1,plot$p4,nrow=2,align = "h")


openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," trend"))
openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," regions"))
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," trend"), spread(plot$trend_data,year,value), colNames = T, rowNames = F)
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," regions"), spread(plot$region_data %>% select(-total,-fraction),year,value), colNames = T, rowNames = F)

```

# Buildings

```{r buildings,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=6,fig.path="../Results/Plots/",dev=c('png','pdf')}


## Which chapter?
i=4
ch = chapters$chapter[i]

plot <- sector_figure(ch,edgar_GHG_ar6)
ggarrange(plot$p1,plot$p4,nrow=2,align = "h")


openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," trend"))
openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," regions"))
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," trend"), spread(plot$trend_data,year,value), colNames = T, rowNames = F)
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," regions"), spread(plot$region_data %>% select(-total,-fraction),year,value), colNames = T, rowNames = F)

```


# AFOLU

```{r AFOLU,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=6,fig.path="../Results/Plots/",dev=c('png','pdf')}


## Which chapter?
i=5
ch = chapters$chapter[i]

plot <- sector_figure(ch,edgar_GHG_ar6 %>% filter(subsector!="7.9"))
ggarrange(plot$p1,plot$p4,nrow=2,align = "h")


openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," trend"))
openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," regions"))
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," trend"), spread(plot$trend_data,year,value), colNames = T, rowNames = F)
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," regions"), spread(plot$region_data %>% select(-total,-fraction),year,value), colNames = T, rowNames = F)


```

```{r write,include=FALSE,echo=FALSE}

openxlsx::saveWorkbook(wb,paste0("../Results/Data/ipcc_sector_trend_plots_",Sys.Date(),".xlsx"),overwrite=T)


```

# Top emitting sectors

```{r summary,echo=FALSE,warning=FALSE,results='asis',fig.width=10,fig.height=4.5,fig.path="../Results/Plots/",dev=c('png','pdf')}

mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(11)

summary_figure <- function(top_sectors,edgar_GHG_ar6) {

p1 <- top_sectors %>%
  ggplot(.,aes(y=value,x=reorder(subsector_title,value),fill=chapter_title)) +
  geom_bar(stat='identity',colour="#737373") +
  geom_text(aes(y=value+2,x=reorder(subsector_title,value),label=paste0("+",round(rate*100,1),"%"))) +
  coord_flip() +
  ylim(0,17) +
  scale_fill_brewer(type = "qual",palette="Set2") +
  theme(axis.title = element_blank(),
        legend.position = c(0.75,0.3),
        legend.title = element_blank(),
        legend.background = element_blank())

  #label=paste0("+ ",round(rate*100),2),"%")

top_sectors <- left_join(top_sectors,edgar_GHG_ar6,by = c("year", "chapter", "chapter_title", "subsector_title"))
top_sectors <- top_sectors %>%
#  group_by(subsector_title,value,rate,abs_growth,region_ar6_10_short) %>%
  group_by(subsector_title,value,rate,abs_growth,region_ar6_5,region_ar6_5_short) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas,GHG),sum,na.rm=TRUE) %>%
  mutate_at(vars(CO2,CH4,N2O,Fgas,GHG),list(~./1e9))

top_sectors <- top_sectors %>%
  group_by(subsector_title) %>%
  mutate_at(vars(CO2,CH4,N2O,Fgas),sum,na.rm=TRUE)

top_sectors <- top_sectors %>% 
  filter(region_ar6_5_short!="SEA")

# top_sectors <- top_sectors %>%
#   mutate(fraction=GHG/value) %>%
#   group_by(subsector_title) %>%
#   arrange(desc(fraction)) %>%
#   mutate(cumfraction=cumsum(fraction)) %>%
#   #mutate(region_ar6_10_short=as.character(region_ar6_10_short))
#   mutate(region_ar6_5_short=as.character(region_ar6_5_short))
# 
# 
# top_sectors <- top_sectors %>%
#   mutate(include=ifelse(cumfraction<0.75,1,0))
# 
# top_sectors <- top_sectors %>%
#   group_by(subsector_title,include) %>%
#   mutate(GHG=ifelse(include==0,sum(GHG),GHG)) %>%
#   mutate(region_ar6_10_short=ifelse(include==0,"Rest",region_ar6_10_short)) %>%
#   ungroup() %>%
#   select(-fraction,-cumfraction,-include) %>%
#   distinct()

p2 <- top_sectors %>%
  #ggplot(.,aes(y=GHG,x=reorder(subsector_title,value),fill=reorder(region_ar6_10_short,GHG))) +
  ggplot(.,aes(y=GHG,x=reorder(subsector_title,value),fill=region_ar6_5_short)) +
  geom_bar(stat='identity',colour="#737373") +
  coord_flip() +
  #scale_fill_manual(values = mycolors) +
  scale_fill_brewer(type = "qual",palette="Set2") +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = c(0.8,0.3),
        legend.title = element_blank(),
        legend.background = element_blank())

top_sectors <- gather(top_sectors,gas,gasvalue,CO2:Fgas) %>%
  #filter(region_ar6_5_short=="Rest")
  filter(region_ar6_5=="Developed Countries")
p3 <- top_sectors  %>%
  ggplot(.,aes(y=gasvalue,x=reorder(subsector_title,value),fill=reorder(gas,gasvalue))) +
  geom_bar(stat='identity',colour="#737373") +
  coord_flip() +
  scale_fill_brewer(type = "qual",palette="Set2") +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = c(0.8,0.3),
        legend.title = element_blank(),
        legend.background = element_blank())

  return(list("p1"=p1,"p2"=p2,"p3"=p3))

}


rates <- edgar_GHG_ar6  %>%
  filter(year>1989) %>%
  filter(year<2019) %>%
  group_by(year,chapter,chapter_title,subsector_title) %>%
  summarise(value=sum(GHG,na.rm=TRUE)/1e9) %>%
  ungroup()

time_start=2010

rates <- rates %>%
  group_by(subsector_title) %>%
  mutate(rate=(last(value)/first(value))^(1/(last(year)-time_start))-1) %>%
  mutate(abs_growth=last(value)-first(value)) %>%
  filter(year==2018)

### Top emitting sectors in 2018

top_sectors <- rates %>%
  ungroup() %>%
  arrange(desc(value)) %>%
  head(15)

plot <- summary_figure(top_sectors,edgar_GHG_ar6)
ggarrange(plot$p1 + ggtitle("Top emitting sectors in 2018"),plot$p2 + ggtitle("Regional composition"),plot$p3 + ggtitle("GHG composition"),align="h",widths=c(0.45,.225,0.225),nrow=1,ncol=3)


```

# All 5 sectors by 10 regions

```{r summary2,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=6,fig.path="../Results/Plots/",dev=c('png','pdf')}


## Which chapter?
i=6
ch = 1
chapters <- add_row(chapters,chapter=1,chapter_title="All sectors")

blarg <- edgar_GHG_ar6 %>% 
  group_by(country,year,chapter,chapter_title,region_ar6_10,region_ar6_10_short) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas,GHG),sum,na.rm=TRUE) %>% 
  ungroup() %>% 
  mutate(chapter=1) %>% 
  select(subsector=chapter,subsector_title=chapter_title,everything())


plot <- sector_figure(ch,blarg)
ggarrange(plot$p1,plot$p4,nrow=2,align = "h")


openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," trend"))
openxlsx::addWorksheet(wb,paste0(chapters$chapter_title[i]," regions"))
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," trend"), spread(plot$trend_data,year,value), colNames = T, rowNames = F)
openxlsx::writeData(wb, sheet = paste0(chapters$chapter_title[i]," regions"), spread(plot$region_data %>% select(-total,-fraction),year,value), colNames = T, rowNames = F)


```
