---
title: "Emissions trends and drivers: sectoral trends"
author: "William F. Lamb"
output: 
  word_document:
    toc: yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Results") })
---
# Summary
This document provides an overview and breakdown of emissions trends by IPCC chapter. We have compiled a consistent allocation of emissions categories to sectors using the EDGAR emissions database. We propose to use this allocation and the following figures across the main sectoral chapters of AR6.

The following supporting information is available online: 

* our code in R
* the sector categorisations
* the figure files
* the data files for each figure
* this document and any updates

Please find these at: https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers

Latest update: `r format(Sys.time(), '%d %B, %Y, %H:%M')`

**Author information**

William F. Lamb - Mercator Research Institute on Global Commons and Climate Change (MCC); School of Earth and Environment, University of Leeds; Contributing Author in Chapter 2 of the Working Group III Report (Emissions Trends and Drivers); lamb@mcc-berlin.net


```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)
library(ggplot2); theme_set(theme_bw())

source("small_figures.R")
source("decomp_figure_countries.R")
source("decomp_figure_sectors.R")
source("waterfall_plot.R")


load('../Data/edgar_data_gwp_ar5.RData')
load('../Data/gwps.RData')
load('../Data/ipcc_sectors.RData')

edgar_GHG_ar5 <- left_join(edgar_GHG_ar5,ipcc_sectors %>% select(code,subsector,subsector_title),by=c("sector_code"="code"))

wb <- openxlsx::createWorkbook(title = paste("ipcc_sector_data",Sys.Date()))

chapters = edgar_GHG_ar5 %>% 
  select(chapter,chapter_title) %>% 
  distinct()

```

```{r sector_trends,echo=FALSE,warning=FALSE,fig.width=9,fig.height=5,fig.path="../Results/Plots/",dev=c('png','pdf')}

sectors <- edgar_GHG_ar5 %>% 
  filter(region_ar6_5!="Intl. Aviation") %>% 
  filter(region_ar6_5!="Intl. Shipping") %>% 
  filter(year %in% c(1990,2000,2010,2018)) %>% 
  group_by(chapter,chapter_title,region_ar6_5,year) %>% 
  summarise(GHG=sum(GHG,na.rm=TRUE)/1e9)

sectors %>% ggplot(.,aes(x=year,y=GHG,fill=region_ar6_5)) +
  geom_bar(stat='identity',colour="#737373") +
  facet_grid(.~chapter_title) +
  ylab('GHG Emissions (GtCO2eq/yr)') +
  theme_bw() +
  theme(legend.position=c(.2,.8),
        legend.title = element_blank(),
        axis.title.x = element_blank())

```


```{r summary_text, include = FALSE}

summary_text <- function(ch,fraction,trend) {

  total <- trend %>% ungroup() %>% filter(Year==2017) %>% summarise(sum=sum(value))
  growth <- trend %>% 
    ungroup() %>% 
    group_by(Year) %>% 
    summarise(value=sum(value))
  compound <- ((tail(growth$value,1)/growth$value[1])^(1/length(growth$Year))-1)*100
  growth <- ((tail(growth$value,1)-growth$value[1])/growth$value[1])*100
  
  text <- paste0(sectors$value[sectors$key==ch]," emissions were ",round(total$sum,2), "Gt CO2 in 2017, ",fraction$value,"% of total GHG emissions from all sectors. ",sectors$value[sectors$key==ch]," emissions have grown by ",round(growth,2),"% between 1970 and 2017.")
  
  return(text)
}


```

# 1. All sectors

```{r total_sector_trends,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}
# 
# load('../Data/edgar_data_gwp_ar5.RData')
# 
# ########### Trend figure ###########
# 
# totals <- edgar_GHG_ar5 %>% 
#   filter(year>1989) %>% 
#   filter(year<2018) %>% 
#   group_by(ISO,country,year,region_ar6_5) %>% 
#   summarise_at(c("CO2","CH4","N2O","Fgas","GHG"),sum,na.rm=TRUE) %>% 
#   mutate(chapter=0,sector_code="Total",description="Total",category_1="Total",category_2="Total",category_3="Total")
# 
#   
# trend <- trend_figure(2010,"sector_code","Total","GHG",totals,big_trend_theme)
# p1 <- trend$plot
# p1 <- p1 + ggtitle("A. Trend in total emissions and income classification ")
# d1 <- trend$data
# 
# ########### Decomposition figure ###########
# 
# decomp <- decomp_figure_countries(2010,'GHG',edgar_GHG_ar5)
# p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)
# p2 <- annotate_figure(p2,
#   top = text_grob("B. Decomposition of relative and absolute contribution by country",size = 12,hjust=0.75))
# 
# plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.4,0.6))
# plot
# 
# 
# #write.xlsx(p$data %>% select(-Year),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName="Total_GHGs_2010",append=TRUE)

```

```{r figure_code,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=7,fig.path="../Results/Plots/",dev=c('png','pdf')}



sector_figure <- function(chapter,edgar_GHG_ar5) {
  

  
  ## Bar figure
  #bar <- bar_figure("chapter",ch,"GHG",edgar_GHG_ar5)
  
  ## Trend figure
  trend_data <- edgar_GHG_ar5 %>%
    filter(year>1989) %>% 
    filter(chapter==ch) %>% 
    group_by(year,subsector,subsector_title) %>% 
    summarise(value=sum(GHG,na.rm=TRUE)) %>% 
    mutate(value=value/1e9)
  
  ## align labels
  labels <- trend_data %>%
    filter(year==2018) %>% 
    arrange(desc(subsector_title))
  
  labels$cum <- cumsum(labels$value)
  
  for (j in 1:length(labels$year)) {
    labels$location[j] = labels$value[j]*0.5
  }
  for (j in 2:length(labels$year)) {
    labels$location[j] = labels$location[j] + labels$cum[j-1]
  }
  
  ## calculate shares
  shares <- trend_data %>% 
    filter(year %in% c(1990,2000,2010,2018)) %>% 
    group_by(year) %>% 
    mutate(totals=sum(value)) %>% 
    ungroup() %>% 
    group_by(year,subsector) %>% 
    mutate(fractions=(value/totals)*100) %>% 
    ungroup()

  shares <- locate_shares(shares,"subsector",4)
  
  p1 <- trend_data %>%
    ggplot(.,aes(x=year,y=value,fill=subsector_title)) +
    geom_area(color='#737373') +
    
    geom_vline(xintercept=c(1990,2000,2010,2018),alpha=0.3,linetype="dashed") +
    geom_text(data=shares %>% filter(subsector==shares$subsector[1]),aes(x=year,y=max(shares$totals+1),label=paste(round(totals,1),  "Gt")),size=3.5,colour="#252525")+
    
    geom_text(data=labels,aes(x=year+1,y=location,label=subsector_title),hjust=0) +
    
    scale_x_continuous(breaks=c(1990,2000,2010,2018),limits=c(1990,2025)) +
    scale_fill_brewer(type = "qual",palette="Set2") +
  
    big_trend_theme +
    ggtitle(paste0("a. ",chapters$chapter_title[i], " sector GHG emissions trends")) +
    theme(legend.position="none") +
    ylab(bquote(.(gas) ~" Emissions (Gt" ~CO[2]* "eq)"))
  
  
  ## Region figure
  region_data <- edgar_GHG_ar5 %>% 
    filter(region_ar6_5!="Intl. Aviation") %>% 
    filter(region_ar6_5!="Intl. Shipping") %>% 
    filter(chapter==ch) %>% 
    filter(year %in% c(1990,2000,2010,2018)) %>% 
    group_by(subsector,subsector_title,region_ar6_5,region_ar6_5_short,year) %>% 
    summarise(value=sum(GHG,na.rm=TRUE)) %>% 
    mutate(value=value/1e9)
  
  region_data <- region_data %>% 
    group_by(subsector,year) %>% 
    mutate(total=sum(value)) %>% 
    ungroup() %>% 
    group_by(subsector,subsector_title,region_ar6_5,region_ar6_5_short,year) %>% 
    mutate(fraction=value/total*100)
  

  p2 <- region_data %>% ggplot(.,aes(x=year,y=fraction,fill=region_ar6_5_short)) +
    geom_bar(stat='identity',colour="#737373") +
    facet_grid(.~subsector_title) +
    ylab("Fraction of total subsector emissions (%)") +
    ggtitle(paste0(chapters$chapter_title[i], " sector regional emissions trends")) +
    big_trend_theme +
    scale_fill_brewer(type = "qual",palette="Set2") +
    theme(legend.position="right",
          axis.title.x = element_blank(),
          legend.title=element_blank())
  
  p3 <- region_data %>% ggplot(.,aes(x=year,y=value,fill=region_ar6_5_short)) +
    geom_bar(stat='identity',colour="#737373") +
    facet_grid(.~subsector_title) +
    ylab(bquote(.(gas) ~" Emissions (Gt" ~CO[2]* "eq)")) +
    ggtitle(paste0(chapters$chapter_title[i], " sector regional emissions trends")) +
    big_trend_theme +
    scale_fill_brewer(type = "qual",palette="Set2") +
    theme(legend.position="right",
          axis.title.x = element_blank(),
          legend.title=element_blank())
  
  p4 <- region_data %>% ggplot(.,aes(x=year,y=value,fill=subsector_title)) +
    geom_bar(stat='identity',colour="#737373") +
    facet_grid(.~region_ar6_5_short) +
    ylab(bquote(.(gas) ~" Emissions (Gt" ~CO[2]* "eq)")) +
    scale_fill_brewer(type = "qual",palette="Set2") +
    ggtitle(paste0(chapters$chapter_title[i], " sector regional emissions trends")) +
    big_trend_theme +
    theme(legend.position="right",
          axis.title.x = element_blank(),
          legend.title=element_blank())
  
  
  return(list("p1"=p1,"p2"=p2,"p3"=p3,"p4"=p4))
  
}
  
  


```

# Transport

```{r transport,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=4,fig.path="../Results/Plots/",dev=c('png','pdf')}



chapters = edgar_GHG_ar5 %>% 
  select(chapter,chapter_title) %>% 
  distinct()

## Which chapter?
i=3
ch = chapters$chapter[i]

plot <- sector_figure(ch,edgar_GHG_ar5)
plot

```

# Buildings

```{r buildings,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=4,fig.path="../Results/Plots/",dev=c('png','pdf')}





## Which chapter?
i=4
ch = chapters$chapter[i]

plot <- sector_figure(ch,edgar_GHG_ar5)
plot

```



# 7. List of category codes

```{r category_table,include=FALSE,echo=FALSE}

# 
# categories <- edgar_GHG %>%
#   select(chapter,sector_code,description) %>%
#   distinct(.keep_all = TRUE) %>% 
#   arrange(chapter)
# categories$chapter <- as.factor(categories$chapter)
# 
# table <- make_table(categories)
# 
# 
# <br>
# `r table`





  ## Decomposition figure
  # load('../Data/basic.RData')
  # decomp <- decomp_figure_countries(1990,'GHG',edgar_GHG_ar5 %>% filter(chapter==ch),basic)
  # 
  # p_decomp <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)
  # p_decomp <- annotate_figure(p_decomp,
  #   top = text_grob("C. Relative and absolute changes amoung countries responsible for 75% of emissions",size = 12,hjust=0.57))
  # 
  # 
  # ## Plot everything
  # p_decomp_countries <- ggarrange(bar$plot,trend,nrow=2,ncol=1,heights = c(0.2,0.8),align = "v")
  # p_decomp_countries <- ggarrange(p_decomp_countries,p_decomp,ncol=1,nrow=2,heights=c(0.45,0.55))
  # 
  # print(p_decomp_countries)
  # cat('  \n')
  
  
  ## Summary text
  # text <- summary_text(ch,bar$fraction,trend$data)
  # cat('  \n',text, '  \n')
  
  
  # ## Sector decomposition
  # 
  # # trend
  # trend <- trend_figure_sectors(2010,'chapter',ch,'GHG',edgar_GHG)
  # 
  # # decomposition
  # decomp <- decomp_figure_sectors(2010,'chapter',ch,'GHG',edgar_GHG)
  # p_decomp <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)
  # p_decomp <- annotate_figure(p_decomp,
  #   top = text_grob("B. Relative and absolute changes amoung sectors responsible for 90% of emissions",size = 12,hjust=0.57))
  # 
  # ## Plot everything
  # p_decomp_sectors <- ggarrange(trend$plot,p_decomp,ncol=1,nrow=2,heights=c(0.4,0.6))
  # 
  # cat('  \n')
  # print(p_decomp_sectors)
  # cat('  \n')


```
