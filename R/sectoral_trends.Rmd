---
title: "Emissions trends and drivers: sectoral trends"
author: "William F. Lamb"
output: 
  word_document:
    toc: yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Results") })
---
# Summary
This document provides an overview and breakdown of emissions trends by IPCC chapter. We have compiled a consistent allocation of emissions categories to sectors using the EDGAR emissions database. We propose to use this allocation and the following figures across the main sectoral chapters of AR6.

The following supporting information is available online: 

* our code in R
* the sector categorisations
* the figure files
* the data files for each figure
* this document and any updates

Please find these at: https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers

Latest update: `r format(Sys.time(), '%d %B, %Y, %H:%M')`

**Author information**

William F. Lamb - Mercator Research Institute on Global Commons and Climate Change (MCC); School of Earth and Environment, University of Leeds; Contributing Author in Chapter 2 of the Working Group III Report (Emissions Trends and Drivers); lamb@mcc-berlin.net


```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)
library(flextable)
library(openxlsx)

sectors = data.frame(key=c(6,7,9,10,11),value=c("Energy systems","AFOLU","Buildings","Transport","Industry"))

source("small_figures.R")
source("decomp_figure_countries.R")
source("decomp_figure_sectors.R")

```

```{r summary_text, include = FALSE}

summary_text <- function(ch,fraction,trend) {

  total <- trend %>% ungroup() %>% filter(Year==2017) %>% summarise(sum=sum(value))
  growth <- trend %>% 
    ungroup() %>% 
    group_by(Year) %>% 
    summarise(value=sum(value))
  compound <- ((tail(growth$value,1)/growth$value[1])^(1/length(growth$Year))-1)*100
  growth <- ((tail(growth$value,1)-growth$value[1])/growth$value[1])*100
  
  text <- paste0(sectors$value[sectors$key==ch]," emissions were ",round(total$sum,2), "Gt CO2 in 2017, ",fraction$value,"% of total GHG emissions from all sectors. ",sectors$value[sectors$key==ch]," emissions have grown by ",round(growth,2),"% between 1970 and 2017.")
  
  return(text)
}


```

# 1. All sectors

```{r total_sector_trends,echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="../Results/Plots/",dev=c('png','pdf')}

########### create totals ###########
load('../Data/edgar.RData')
totals <- edgar_GHG %>% 
  group_by(ISO,Year,WB.income,Country) %>% 
  summarise(CO2=sum(CO2,rm.na=T),CH4=sum(CH4,rm.na=T),N2O=sum(N2O,rm.na=T),Fgas=sum(Fgas,rm.na=T),GHG=sum(GHG,rm.na=T)) %>% 
  mutate(sector_code="Total",category_final="Total",category_1="Total",category_2="Total",category_3="Total",IPCC_AR5_chapter=0,IPCC_AR5_sector=0) %>% 
  select(ISO,sector_code,category_final,category_1,category_2,category_3,Year,CO2,CH4,N2O,Fgas,GHG,Country,WB.income,IPCC_AR5_chapter,IPCC_AR5_sector)

edgar_GHG <- edgar_GHG %>% 
  bind_rows(totals)

########### Trend figure ###########

trend <- trend_figure(2010,"sector_code","Total","GHG",edgar_GHG)
p1 <- trend$plot
p1 <- p1 + ggtitle("A. Trend in total emissions and income classification ")
d1 <- trend$data

########### Decomposition figure ###########

decomp <- decomp_figure_countries(2010,'sector_code','Total','GHG',edgar_GHG)
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)
p2 <- annotate_figure(p2,
  top = text_grob("B. Decomposition of relative and absolute contribution by country",size = 12,hjust=0.75))

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.4,0.6))
plot


#write.xlsx(p$data %>% select(-Year),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName="Total_GHGs_2010",append=TRUE)

```

```{r sectors,echo=FALSE,warning=FALSE,results='asis',fig.width=8,fig.height=11,fig.path="../Results/Plots/",dev=c('png','pdf')}

load('../Data/edgar.RData')

for (i in 1:length(sectors$key)) {
  
  ## Which chapter?
  ch = sectors$key[i]
  
  
  ## Generate header
  header = paste0(i+1,". ",sectors$value[i]," (Ch.",sectors$key[i],")")
  cat('\n#', header, '\n')
  
  
  ## Bar figure
  bar <- bar_figure("chapter",ch,"GHG",edgar_GHG)
  
  
  ## Trend figure
  trend <- trend_figure(2010,'chapter',ch,'GHG',edgar_GHG)
  
  
  ## Decomposition figure
  decomp <- decomp_figure_countries(2010,'chapter',ch,'GHG',edgar_GHG)
  p_decomp <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)
  p_decomp <- annotate_figure(p_decomp,
    top = text_grob("C. Relative and absolute changes amoung countries responsible for 75% of emissions",size = 12,hjust=0.57))
  
  
  ## Plot everything
  p_decomp_countries <- ggarrange(bar$plot,trend$plot,nrow=2,ncol=1,heights = c(0.2,0.8),align = "v")
  p_decomp_countries <- ggarrange(p_decomp_countries,p_decomp,ncol=1,nrow=2,heights=c(0.45,0.55))
  
  print(p_decomp_countries)
  cat('  \n')
  
  
  ## Summary text
  text <- summary_text(ch,bar$fraction,trend$data)
  cat('  \n',text, '  \n')
  
  
  # ## Sector decomposition
  # 
  # # trend
  # trend <- trend_figure_sectors(2010,'chapter',ch,'GHG',edgar_GHG)
  # 
  # # decomposition
  # decomp <- decomp_figure_sectors(2010,'chapter',ch,'GHG',edgar_GHG)
  # p_decomp <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)
  # p_decomp <- annotate_figure(p_decomp,
  #   top = text_grob("B. Relative and absolute changes amoung sectors responsible for 90% of emissions",size = 12,hjust=0.57))
  # 
  # ## Plot everything
  # p_decomp_sectors <- ggarrange(trend$plot,p_decomp,ncol=1,nrow=2,heights=c(0.4,0.6))
  # 
  # cat('  \n')
  # print(p_decomp_sectors)
  # cat('  \n')
  
}


```

# 7. List of category codes

```{r category_table,include=FALSE,echo=FALSE}


categories <- edgar_GHG %>%
  select(chapter,sector_code,description) %>%
  distinct(.keep_all = TRUE) %>% 
  arrange(chapter)
categories$chapter <- as.factor(categories$chapter)

table <- make_table(categories)


```
<br>
`r table`