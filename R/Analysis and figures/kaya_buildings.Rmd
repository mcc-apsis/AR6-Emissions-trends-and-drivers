---
title: "Kaya buildings"
author: "William F. Lamb"
date: "2 12 2020"
output: word_document
---

output: 
  word_document:
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../Results") })
---

```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(openxlsx)
library(ggplot2); theme_set(theme_bw())
library(data.table)
library(janitor)

load("../../Data/ipcc_regions.RData")
load('../../Data/basic.RData')
load('../../Data/activity.RData')
load('../../Data/edgar_data_gwp_ar6.RData')
load('../../Data/indirect_CO2.RData')



# floor space from IEA EE indicators
# residential/services energy from IEA EE indicators
# GHG from EDGAR, indirect CO2 from IEA
# pop from UN

## floor space and pop from IEA EE indicators

floor_space <- act %>% 
  filter(product %in% c("Residential floor area (10^9 m2)","Services floor area (10^9 m2)"))

floor_space <- floor_space %>% 
  mutate(product=ifelse(product=="Residential floor area (10^9 m2)","residential",product)) %>% 
  mutate(product=ifelse(product=="Services floor area (10^9 m2)","services",product))

floor_space <- floor_space %>% 
  mutate(value=value*1e9) %>% 
  mutate(pop=pop*1e6)

floor_space <- floor_space %>% 
  mutate(subsector_title=ifelse(product=="residential","Residential","Non-residential")) %>% 
  select(-activity,-product,-region_ar6_5,-region_ar6_5_short) %>% 
  select(everything(),floor_space_m2=value,pop_persons=pop)


## energy from IEA EE indicators

energy <- IEA_EE %>% 
  filter(end_use %in% c("Total Residential","Total Services")) %>% 
  filter(product=="Total final energy (PJ)")

energy <- energy %>%
  mutate(subsector_title=ifelse(end_use=="Total Residential","Residential","Non-residential")) %>% 
  mutate(value=value*1e6) %>% 
  select(-product,-end_use,-region_ar6_5,-region_ar6_5_short) %>% 
  select(everything(),tot_fin_energy_GJ=value)

## CO2 direct

co2 <- edgar_GHG_ar6 %>% 
  filter(chapter_title=="Buildings") %>% 
  group_by(country,ISO,region_ar6_10,year,subsector_title,) %>% 
  summarise(CO2_t=sum(CO2,na.rm=TRUE))

## CO2 indirect

co2_indirect <- indirect_CO2_countries %>% 
  filter(chapter_title=="Buildings") %>% 
  group_by(country,ISO,region_ar6_10,year,subsector_title) %>% 
  summarise(CO2_indirect_t=sum(CO2_indirect*1e9,na.rm=TRUE))

## join all

data <- left_join(co2,co2_indirect,by = c("country", "ISO", "year", "subsector_title"))
data <- left_join(data,energy,by = c("country", "ISO", "year", "subsector_title"))
data <- left_join(data,floor_space,by = c("country", "ISO", "year", "subsector_title"))

```

```{r floor_area_descriptive,echo=FALSE,warning=FALSE,fig.width=6,fig.height=4,fig.path="../../Results/Plots/Supplementary/",dev=c('png','pdf')}

floor_space_plot <- floor_space %>% 
  mutate(floor_space_percapita = floor_space_m2/pop_persons) %>% 
  filter(country!="Ukraine")

floor_space_plot <- left_join(floor_space_plot,basic %>% select(ISO,year=Year,gdp_ppp_WB),by = c("ISO", "year"))

floor_space_plot <- floor_space_plot %>% 
  filter(year %in% c(2000,2017)) %>% 
  filter(subsector_title=="Residential") %>% 
  mutate(gdp_pc = gdp_ppp_WB/pop_persons)


library(RColorBrewer)


floor_space_plot <- floor_space_plot %>% 
  filter(country %in% c("Australia","Canada","Czech Republic","Finland","Hungary","France","Germany","Japan","United Kingdom","Mexico","United States")) 

mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(length(unique(floor_space_plot$country)))


  
floor_space_plot %>% ggplot(.,aes(x=gdp_pc,y=floor_space_percapita,color=country,group=country)) +
  geom_path() +
  geom_point() +
  geom_text(data=floor_space_plot %>% filter(year==2017),
            inherit.aes=FALSE,aes(x=gdp_pc+1000,y=floor_space_percapita,label=country,color=country),hjust=0) + 
  scale_color_manual(values=mycolors) +
  xlim(15000,65000) +
  theme(legend.position="none") +
  ggtitle("Residential floor space vs. GDP per capita (2000 & 2017)") +
  ylab("Floor space per capita (m2/person)") +
  xlab("GDP per capita (US$ PPP)")

```


```{r residential_calc, include=FALSE}

# ## filter complete rows and years
# 
# kaya_residential <- data %>% 
#   filter(subsector_title=="Residential") %>% 
#   filter_at(vars(CO2_t:floor_space_m2),all_vars(!is.na(.)))
# 
# #sum co2 direct and indirect
# 
# kaya_residential <- kaya_residential %>% 
#   mutate(CO2_direct_indirect_t=CO2_t+CO2_indirect_t)
# 
# # calculate kaya components
# 
# kaya_residential <- kaya_residential %>% 
#   mutate(floor_area_population = floor_space_m2/pop_persons) %>% 
#   mutate(energy_floor_area = tot_fin_energy_GJ/floor_space_m2) %>% 
#   mutate(CO2_energy=CO2_direct_indirect_t/tot_fin_energy_GJ)
# 
# ## gather and normalise data to 1 in 2000
# 
# kaya_residential <- gather(kaya_residential,var,value,CO2_direct_indirect_t,pop_persons,floor_area_population,energy_floor_area,CO2_energy)
# 
# kaya_residential <- kaya_residential %>%
#   group_by(country,var) %>%
#   mutate(value=value/first(value))
# 
# ## filter complete years
# 
# kaya_residential <- kaya_residential %>% 
#   select(country,ISO,year,var,value)
# 
# kaya_residential <- spread(kaya_residential,year,value)
# kaya_residential <- kaya_residential %>% 
#   filter(!is.na(`2000`))
# kaya_residential <- gather(kaya_residential,year,value,`2000`:`2017`)
# kaya_residential <- kaya_residential %>% 
#   mutate(value=as.numeric(value)) %>% 
#   mutate(year=as.numeric(year))
# 
# #kaya_residential <- spread(kaya_residential,var,value)
# #openxlsx::write.xlsx(kaya_residential,file="buildings_kaya.xlsx")

```

## Residential

```{r old_residential_plot,echo=FALSE,warning=FALSE,fig.width=9,fig.height=9}


# # plot
# 
# kaya_residential %>% ggplot(.,aes(x=year,y=value,color=var)) +
#   geom_path() +
#   facet_wrap(country~.) +
#   theme(legend.position = "bottom",
#         axis.title = element_blank(),
#         legend.title = element_blank(),
#         panel.grid.minor = element_blank())


```

```{r services_calc, include=FALSE}

# ## filter complete rows and years
# 
# kaya_non_residential <- data %>% 
#   filter(subsector_title=="Non-residential") %>% 
#   filter_at(vars(CO2_t:floor_space_m2),all_vars(!is.na(.)))
# 
# #sum co2 direct and indirect
# 
# kaya_non_residential <- kaya_non_residential %>% 
#   mutate(CO2_direct_indirect_t=CO2_t+CO2_indirect_t)
# 
# # calculate kaya components
# 
# kaya_non_residential <- kaya_non_residential %>% 
#   mutate(floor_area_population = floor_space_m2/pop_persons) %>% 
#   mutate(energy_floor_area = tot_fin_energy_GJ/floor_space_m2) %>% 
#   mutate(CO2_energy=CO2_direct_indirect_t/tot_fin_energy_GJ)
# 
# ## gather and normalise data to 1 in 2000
# 
# kaya_non_residential <- gather(kaya_non_residential,var,value,CO2_direct_indirect_t,pop_persons,floor_area_population,energy_floor_area,CO2_energy)
# 
# kaya_non_residential <- kaya_non_residential %>%
#   group_by(country,var) %>%
#   mutate(value=value/first(value))
# 
# ## filter complete years
# 
# kaya_non_residential <- kaya_non_residential %>% 
#   select(country,ISO,year,var,value)
# 
# kaya_non_residential <- spread(kaya_non_residential,year,value)
# kaya_non_residential <- kaya_non_residential %>% 
#   filter(!is.na(`2000`))
# kaya_non_residential <- gather(kaya_non_residential,year,value,`2000`:`2017`)
# kaya_non_residential <- kaya_non_residential %>% 
#   mutate(value=as.numeric(value)) %>% 
#   mutate(year=as.numeric(year))

```

## Non-residential

```{r old_non_residential_plot,echo=FALSE,warning=FALSE,fig.width=9,fig.height=9}


# plot

# kaya_non_residential %>% ggplot(.,aes(x=year,y=value,color=var)) +
#   geom_path() +
#   facet_wrap(country~.) +
#   theme(legend.position = "bottom",
#         axis.title = element_blank(),
#         legend.title = element_blank(),
#         panel.grid.minor = element_blank())


```



```{r gather_data, include=FALSE}

data <- read.xlsx("../../Data/kaya/Buildings 2020-12-04  Dataset for Kaya decomposition.xlsx",sheet=2)

data <- gather(data,year,value,`1990`:`2018`) %>% 
  filter(!is.na(Region))

co2_buildings <- left_join(co2,co2_indirect,by = c("country", "ISO", "region_ar6_10", "year", "subsector_title"))
  
co2_buildings <- co2_buildings %>% 
  mutate(CO2_indirect_t=ifelse(is.na(CO2_indirect_t),0,CO2_indirect_t)) %>% 
  mutate(CO2_t=ifelse(is.na(CO2_t),0,CO2_t))

co2_buildings <- co2_buildings %>%  
  mutate(CO2_total_t = CO2_t+CO2_indirect_t)

co2_buildings <- co2_buildings %>% 
  group_by(region_ar6_10,year,subsector_title) %>% 
  summarise(value=sum(CO2_total_t)) %>% 
  mutate(Variable="Total CO2 emissions") %>%
  mutate(Unit = "tCO2") %>% 
  filter(subsector_title!="Non-CO2 (all buildings)") %>%
  filter(year %in% c(1990,2000,2005,2010,2015,2018)) %>% 
  select(Region=region_ar6_10,Variable,Unit,year,value,subsector_title) %>% 
  ungroup()

data <- data %>% 
  mutate(subsector_title=ifelse(grepl("Residential",Variable),"Residential",NA)) %>% 
  mutate(subsector_title=ifelse(grepl("Non-residential",Variable),"Non-residential",subsector_title))

data <- data %>% 
  filter(!is.na(subsector_title)) %>% 
  filter(Unit!="MtCO2")

data <- rbind(data,co2_buildings)

pop <- basic %>% select(ISO,year=Year,pop_UN)
pop <- left_join(pop,ipcc_regions,by = "ISO")
pop <- pop %>% 
  filter(year %in% c(1990,2000,2005,2010,2015,2018)) %>% 
  group_by(region_ar6_10,year) %>% 
  summarise(value=sum(pop_UN)) %>% 
  filter(!is.na(region_ar6_10))
pop <- pop %>% 
  mutate(Variable="Population") %>% 
  mutate(Unit="persons") %>% 
  select(Region=region_ar6_10,Variable,Unit,year,value) %>% 
  ungroup()

data <- rbind(data,pop %>% mutate(subsector_title="Residential"))
data <- rbind(data,pop %>% mutate(subsector_title="Non-residential"))

pop <- pop %>% 
  group_by(Variable,Unit,year) %>% 
  summarise(value=sum(value)) %>% 
  mutate(Region="World") %>% 
  select(Region,Variable,Unit,year,value) %>% 
  ungroup()

co2_buildings <- co2_buildings %>% 
  group_by(Variable,Unit,year,subsector_title) %>% 
  summarise(value=sum(value)) %>% 
  mutate(Region="World") %>% 
  select(Region,Variable,Unit,year,value,subsector_title) %>% 
  ungroup()

data <- rbind(data,pop %>% mutate(subsector_title="Residential"))
data <- rbind(data,pop %>% mutate(subsector_title="Non-residential"))
data <- rbind(data,co2_buildings)

data <- data %>% 
  mutate(Variable=paste0(Variable," (",Unit,")"))

# The kaya decomposition should be performed separately for residential and non-residential buildings as the drivers vary per building use: 
# •	Residential buildings
# 
# CO2= Population *[Floor area/Population]*[Energy/Floor area]*[CO2/Energy]
# 
# Source of data: 
# 	Population: the source used for Ch2 calculations but also included in IEA/Beyond2020/EE indicators/Activity
# 	Floor area: IEA Beyond 2020/EE indicators/Activity
# 	Energy (Total final energy): IEA Beyond 2020/EE indicators/Residential_Energy
# 	CO2: Total (direct+indirect+others) emissions from William’s previous calculations
# 
# •	Non-residential buildings
# 
# CO2= Value added*[Energy/Value Added]*[CO2/Energy] 
# 
# Source of data: 
# 	Value-added (Total services: Value added (10^9 USD PPP 2010): IEA/Beyond2020/EE indicators/Activity
# 	Energy (Total final energy): IEA Beyond 2020/EE indicators/Services_Energy
# 	CO2: Total (direct+indirect+others) emissions from William’s previous calculations
```


```{r calc_kaya_residential, include=FALSE}

residential <- data %>% 
  filter(subsector_title=="Residential") %>% 
  select(-Unit,-subsector_title) %>% 
  mutate(value=as.numeric(value))

residential <- spread(residential,Variable,value)

names(residential) <- c("region","year","pop","energy","floor","co2")

residential <- residential %>% 
  mutate(energy = energy*1e6) %>% 
  mutate(floor = floor*1e6)

residential <- residential %>% 
  mutate(floor_pop = floor/pop) %>% 
  mutate(energy_floor = energy/floor) %>% 
  mutate(co2_energy = co2/energy)


residential <- gather(residential,var,value,co2,pop,floor_pop,energy_floor,co2_energy)


residential <- residential %>% 
  group_by(region,var) %>% 
  mutate(value=value/first(value))

residential <- residential %>% 
  mutate(value=value-1)



```

```{r residential_plot,echo=FALSE,warning=FALSE,fig.width=8,fig.height=7,fig.path="../../Results/Plots/Supplementary/",dev=c('png','pdf')}


# plot


residential %>% 
  filter(var!="co2") %>% 
  ggplot(.,aes(x=year,y=value,fill=var)) +
  geom_bar(stat='identity',color="#636363") +
  geom_point(data=residential %>% filter(var=="co2"),color="#636363")+
  facet_wrap(region~.) +
  scale_fill_brewer(palette = "Set2") +
  theme(legend.position = "bottom",
        axis.title = element_blank(),
        legend.title = element_blank(),
        panel.grid.minor = element_blank())


```

```{r calc_kaya_non-residential, include=FALSE}

nonresidential <- data %>% 
  filter(subsector_title=="Non-residential") %>% 
  select(-Unit,-subsector_title) %>% 
  mutate(value=as.numeric(value))

nonresidential <- spread(nonresidential,Variable,value)

names(nonresidential) <- c("region","year","energy","value","pop","co2")

nonresidential <- nonresidential %>% 
  mutate(energy = energy*1e6) %>% 
  mutate(value=value*1e6)

nonresidential <- nonresidential %>% 
  mutate(value_pop = value/pop) %>% 
  mutate(energy_value = energy/value) %>% 
  mutate(co2_energy = co2/energy)

nonresidential <- nonresidential %>% 
  filter(year %in% c(1990,2000,2010,2018))

nonresidential <- gather(nonresidential,var,value,co2,pop,value_pop,energy_value,co2_energy)


nonresidential <- nonresidential %>% 
  group_by(region,var) %>% 
  mutate(value=value/first(value))

nonresidential <- nonresidential %>% 
  mutate(value=value-1)



```

```{r nonresidential_plot,echo=FALSE,warning=FALSE,fig.width=8,fig.height=7,fig.path="../../Results/Plots/Supplementary/",dev=c('png','pdf')}


# plot

nonresidential %>% 
  filter(var!="co2") %>% 
  ggplot(.,aes(x=year,y=value,fill=var)) +
  geom_bar(stat='identity',color="#636363") +
  geom_point(data=nonresidential %>% filter(var=="co2"),color="#636363")+
  facet_wrap(region~.) +
  scale_fill_brewer(palette = "Set2") +
  theme(legend.position = "bottom",
        axis.title = element_blank(),
        legend.title = element_blank(),
        panel.grid.minor = element_blank())


```
