---
title: "Decarbonising countries"
author: "William F. Lamb"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    toc: yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../Results") })
  
---

```{r setup,include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(ggplot2); theme_set(theme_bw())
library(zoo)
library(cluster)
library(ggmap)
library(maps)
library(patchwork)

load('../../Data/edgar_data_gwp_ar6.RData')
load('../../Data/basic.RData')

source("growth_rate.R")

isos <- openxlsx::read.xlsx("C:/Users/lamw/Documents/SpiderOak Hive/Work/Code/R/.Place names and codes/output/ISOcodes.xlsx","alternative_names")

colours_sectors <- c(`AFOLU` = "#66c2a5",
                       `Buildings` = "#fc8d62",
                       `Energy systems` = "#8da0cb",
                       `Industry` = "#e78ac3",
                       `Transport` = "#a6d854")

wb <- openxlsx::createWorkbook(title = paste("decarbonising_countries"))
openxlsx::addWorksheet(wb,"info")

info = data.frame(x=c("Title","Author","Date","Code"),y=c("Analysis of countries with sustained GHG emissions reductions","William F. Lamb (lamb@mcc-berlin.net)",paste(Sys.Date()),"https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers/blob/master/R/Analysis%20and%20figures/decarbonising_countries.Rmd"))

openxlsx::writeData(wb, sheet = "info", info, colNames = F, rowNames = F)


```

### Find countries with declining CO2 emissions (1970-2018)


```{r calculate_rates,echo=FALSE,warning=FALSE,include=FALSE}

## gather data

data <- edgar_GHG_ar6 %>% 
  group_by(ISO,country,year,region_ar6_10) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas,GHG),sum,na.rm=TRUE)

## join population and GDP data

data <- left_join(data,basic %>% select(ISO,Year,pop_UN,gdp_ppp_WB),by=c("ISO"="ISO","year"="Year"))

## filter to countries above 1m population

data <- data %>% 
  group_by(country) %>% 
  mutate(include=ifelse(max(pop_UN)>1e6,1,0)) %>% 
  ungroup() %>% 
  filter(include==1) %>% 
  select(-include)


## find peak year CO2, excluding years after 2009

peak_years <- data %>% 
  filter(year<2010) %>% 
  group_by(country) %>% 
  summarise(peak_year=year[which.max(CO2)])

## calculate CO2 growth since peak year, excluding countries where peak year is 2009 (no reductions)

data <- left_join(data,peak_years,by = "country") %>% 
  filter(peak_year!=2009)

rates_CO2 <- data %>% filter(country=="nothing") # create empty dataframe

for (i in 1:length(unique(data$country))) {
  
  temp_data <- data %>% 
    filter(country==unique(data$country)[i])
  
  temp_data <- temp_data %>% 
    filter(year>=temp_data$peak_year[1])
  
  rates <- growth_rate(temp_data$year,temp_data$CO2)
  
  temp_data$rate_CO2_peak <- rates$rate
  temp_data$fit <- rates$data$predicted_x
  temp_data$st_error <- rates$data$st_error
  
  rates_CO2 <- rbind(rates_CO2,temp_data)
}

#rejoin with full data

data <- left_join(data,rates_CO2 %>% select(country,year,rate_CO2_peak,fit,st_error),by = c("country", "year"))

data <- data %>% 
  group_by(country) %>% 
  mutate(rate_CO2_peak=na.locf(rate_CO2_peak,fromLast=TRUE))


## now do the same for GHG emissions

rates_GHG <- data %>% 
  filter(country=="nothing") %>%  # create empty dataframe 
  select(-fit,-rate_CO2_peak,-st_error)
  
for (i in 1:length(unique(data$country))) {
  
  temp_data <- data %>% 
    filter(country==unique(data$country)[i])
  
  temp_data <- temp_data %>% 
    filter(year>=temp_data$peak_year[1])
  
  rates <- growth_rate(temp_data$year,temp_data$GHG)
  
  temp_data$rate_GHG_peak <- rates$rate
  temp_data$fit <- rates$data$predicted_x
  temp_data$st_error <- rates$data$st_error
  
  rates_GHG <- rbind(rates_GHG,temp_data)
}


#rejoin with full data

data <- left_join(data,rates_GHG %>% select(country,year,rate_GHG_peak),by = c("country", "year"))

data <- data %>% 
  group_by(country) %>% 
  mutate(rate_GHG_peak=na.locf(rate_GHG_peak,fromLast=TRUE))



```

```{r exclusions,echo=FALSE,warning=FALSE}


# exclude countries with growth rates above 0

data <- data %>% 
  mutate(rate_CO2_peak=rate_CO2_peak*100) %>% 
  mutate(rate_GHG_peak=rate_GHG_peak*100) %>% 
  filter(rate_CO2_peak<0)

# calculate absolute and relative reductions since peak

rates_CO2 <- rates_CO2 %>% 
  group_by(country) %>% 
  summarise(percent_reduction_CO2_peak=((first(CO2)-last(CO2))/first(CO2))*100,
            absolute_reduction_CO2_peak=first(CO2)-last(CO2))

rates_GHG <- rates_GHG %>% 
  group_by(country) %>% 
  summarise(percent_reduction_GHG_peak=((first(GHG)-last(GHG))/first(GHG))*100,
            absolute_reduction_GHG_peak=first(GHG)-last(GHG))

data <- left_join(data,rates_CO2,by = "country")
data <- left_join(data,rates_GHG,by = "country")

# exclude countries where the overall CO2 reduction since peak is <10%

data <- data %>% 
  filter(percent_reduction_CO2_peak>10)

# exclude countries with recent major civil conflict or economic decline

data <- data %>%
  filter(country!="Yemen, Rep.") %>% 
  filter(country!="Venezuela, RB") %>% 
  filter(country!="Syrian Arab Republic") %>% 
  filter(country!="Korea, Dem. People's Rep.") %>% 
  filter(country!="Libya") %>% 
  filter(country!="Afghanistan")

# exclude countries with extreme year to year emissions increase (i.e. due to territory or political changes)

data <- data %>%
  filter(country!="Estonia") %>% 
  filter(country!="Moldova") %>% 
  filter(country!="Swaziland")

# exclude countries with growing GHG emissions since the same CO2 peak year

data <- data %>% 
  filter(rate_GHG_peak<0)

# exclude small countries with large oil industries and therefore large yearly emissions variations

data <- data %>% 
  filter(country!="Equatorial Guinea") %>% 
  filter(country!="Timor-Leste") 

# openxlsx::addWorksheet(wb,"data_included_countries")
# openxlsx::writeData(wb, sheet = "data_included_countries", data, colNames = T, rowNames = F)
# 
# openxlsx::addWorksheet(wb,"data_excluded_countries")
# openxlsx::writeData(wb, sheet = "data_excluded_countries", filtered_countries, colNames = T, rowNames = F)


```

```{r all_countries_decline,echo=FALSE,warning=FALSE,fig.width=8,fig.height=9,fig.path="../../Results/Plots/Peak/",dev=c('png','pdf')}


## set facet labels and order by growth rate

data <- data %>% 
  mutate(labels=paste0(country," (",round(rate_CO2_peak,2),"%)")) %>% 
  mutate(labels=as.factor(labels))

data$labels=fct_reorder(data$labels,data$rate_CO2_peak)


data %>% 
  ggplot(.,aes(x=year,y=CO2)) +
  geom_path() +
  geom_line(data=data,aes(x=year,y=fit),colour="#d7191c") +
  scale_x_continuous(limits=c(1970,2018),breaks=c(1970,1990,2010)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .2)), limits = c(0, NA)) +
  scale_fill_manual(values=c("#abdda4","#d7191c")) +
  facet_wrap(.~labels,scales="free",labeller = label_wrap_gen(width=23,multi_line = TRUE)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank()) +
  ggtitle("Countries with declining emissions (since peak year)")

```

```{r clustering,echo=FALSE,warning=FALSE,fig.width=8,fig.height=9,fig.path="../../Results/Plots/Peak/",dev=c('png','pdf')}


data <- data %>% 
  group_by(country) %>% 
  mutate(CO2_rm = rollmean(CO2,1,na.pad=TRUE,align="right"))

## normalise

data <- data %>% 
  filter(!is.na(CO2_rm)) %>% 
  group_by(country) %>% 
  mutate(CO2_rm = CO2_rm/first(CO2_rm))


data %>% 
  ggplot(.,aes(x=year,y=CO2_rm)) +
  geom_path() +
  #geom_line(data=peak,aes(x=year,y=fit),colour="red") +
  scale_x_continuous(limits=c(1970,2018),breaks=c(1970,1990,2010)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .2))) +
  facet_wrap(.~labels,labeller = label_wrap_gen(width=23,multi_line = TRUE)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank()) +
  ggtitle("Countries with declining emissions (since peak year)")


cluster_data <- data %>% 
  filter(year %in% c(1970,1975,1980,1985,1990,1995,2000,2005,2010,2015,2018)) %>% 
  #filter(year %in% c(1970,1980,1990,2000,2010,2018)) %>% 
  ungroup()

cluster_data <- spread(cluster_data %>% select(country,ISO,year,CO2_rm),year,CO2_rm)


# clusters <- pam(cluster_data %>% select(-country,-ISO),5)
# cluster_data <- cbind(cluster_data,cluster=clusters$clustering) ### bind clusters to dataset
# cluster_data$cluster <- as.factor(clusters$clustering) ### convert to factor

clusters <- kmeans(cluster_data %>% select(-country,-ISO),4)
cluster_data <- cbind(cluster_data,cluster=clusters$cluster) ### bind clusters to dataset
cluster_data$cluster <- as.factor(clusters$cluster) ### convert to factor

data <- left_join(data,cluster_data %>% select(ISO,cluster),by=c("ISO"="ISO"))


data %>% 
  ggplot(.,aes(x=year,y=CO2)) +
  geom_path() +
  geom_line(data=data,aes(x=year,y=fit),colour="red") +
  scale_x_continuous(limits=c(1970,2018),breaks=c(1970,1990,2010)) +
  scale_y_continuous(expand = expand_scale(mult = c(0, .2)), limits = c(0, NA)) +
  facet_wrap(cluster~labels,scales="free") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank()) +
  ggtitle("Countries with declining emissions (since peak year)")


```

```{r clustering,echo=FALSE,warning=FALSE,fig.width=8,fig.height=2,fig.path="../../Results/Plots/Peak/",dev=c('png','pdf')}

clusters <- data %>% 
  group_by(cluster,year) %>% 
  summarise(CO2_rm=mean(CO2_rm)) %>% 
  ungroup() %>% 
  group_by(cluster) %>% 
  mutate(CO2_rm = rollmean(CO2_rm,3,na.pad=TRUE,align="right"))


p1 <- data %>% ggplot(.,aes(x=year,y=CO2_rm,group=country,colour=cluster)) +
  geom_path(alpha=0.4) +
  geom_path(data=clusters,inherit.aes=FALSE,aes(x=year,y=CO2_rm,colour=cluster),size=1) +
  facet_grid(.~cluster) +
  scale_x_continuous(limits=c(1970,2018),breaks=c(1970,1990,2010)) +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank()) +
  ggtitle("b. Emissions trajectories and peak years by cluster")
p1





```

```{r map,echo=FALSE,warning=FALSE,fig.width=8,fig.height=3,include=FALSE}


world <- map_data("world") %>% 
  filter(region!="Antarctica")
world <- left_join(world %>% mutate(region=tolower(region)),isos,by=c("region"="alternative.name"))
world <- left_join(world,data %>% select(ISO,cluster) %>% distinct(),by=c("alpha.3"="ISO"))


p2 <- ggplot() + 
  geom_polygon(data = world, aes(x=long, y = lat, group=group, fill=cluster),color="white",size=0.25,na.rm=T) + 
  #coord_fixed(1,xlim=c(-155,175),ylim=c(0,75)) +
  #scale_fill_continuous(trans = 'reverse',na.value='#969696',name="No. studies") +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.border = element_rect(colour = "black",fill=NA),
        legend.position = "none",
        legend.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm")) +
  ggtitle("a. Countries with declining CO2 and GHG emissions since 1970")
p2

```


```{r tables,echo=FALSE,warning=FALSE}


# fraction of
# - global population
# - global GHG
# - global CO2
# - global income
# - what regions

table <- data %>% 
  filter(year==2018) %>% 
  summarise(cluster=nth(cluster,1),peak_year=nth(peak_year,1),CO2_rate=nth(rate_CO2_peak,1),GHG_rate=nth(rate_GHG_peak,1),CO2_2018=nth(CO2,1),GHG_2018=nth(GHG,1),pop_2018=nth(pop_UN,1),abs_reduction_CO2=nth(absolute_reduction_CO2_peak,1),abs_reduction_GHG=nth(absolute_reduction_GHG_peak,1))


table <- table %>% 
  mutate(abs_reduction_CO2=abs_reduction_CO2/1e6) %>% 
  mutate(abs_reduction_GHG=abs_reduction_GHG/1e6) %>% 
  mutate(CO2_2018=CO2_2018/1e6) %>% 
  mutate(GHG_2018=GHG_2018/1e6) %>% 
  mutate(pop_2018=pop_2018/1e6) %>% 
  mutate(CO2_2018_pc = CO2_2018/pop_2018) %>% 
  mutate(GHG_2018_pc = GHG_2018/pop_2018)


## get global GHG

world_GHG <- edgar_GHG_ar6 %>%
  filter(year==2018) %>%
  summarise(GHG=sum(GHG,na.rm = TRUE)/1e6,CO2=sum(CO2,na.rm=TRUE)/1e6)

## get global pop

world_pop <- basic %>%
  filter(Year==2018) %>%
  filter(Country=="World") %>%
  select(pop_UN)

## calculate totals

totals <- table %>% 
  summarise(CO2_2018=sum(CO2_2018),GHG_2018=sum(GHG_2018),pop_2018=sum(pop_2018),
            abs_reduction_CO2=sum(abs_reduction_CO2),abs_reduction_GHG=sum(abs_reduction_GHG)) %>% 
  mutate(country="Total")

table <- bind_rows(table,totals)

## calculate fractions

table <- table %>%
  mutate(GHG_fraction=(GHG_2018/world_GHG$GHG)*100) %>%
  mutate(CO2_fraction=(CO2_2018/world_GHG$CO2)*100) %>% 
  mutate(pop_fraction=(pop_2018/(world_pop$pop_UN/1e6))*100)


### cluster table

cluster_table <- table %>% 
  filter(!is.na(cluster)) %>% 
  group_by(cluster) %>% 
  summarise(mean_peak_year=round(mean(peak_year),0),CO2_2018=sum(CO2_2018),GHG_2018=sum(GHG_2018),pop_2018=sum(pop_2018),abs_reduction_CO2=sum(abs_reduction_CO2),abs_reduction_GHG=sum(abs_reduction_GHG),countries=paste0(country,collapse="; "))

## calculate totals

totals <- totals %>% 
  summarise(CO2_2018=sum(CO2_2018),GHG_2018=sum(GHG_2018),pop_2018=sum(pop_2018),
            abs_reduction_CO2=sum(abs_reduction_CO2),abs_reduction_GHG=sum(abs_reduction_GHG)) %>% 
  mutate(countries="Total")

cluster_table <- bind_rows(cluster_table,totals)

cluster_table <- cluster_table %>%
  mutate(GHG_fraction=(GHG_2018/world_GHG$GHG)*100) %>%
  mutate(CO2_fraction=(CO2_2018/world_GHG$CO2)*100) %>% 
  mutate(pop_fraction=(pop_2018/(world_pop$pop_UN/1e6))*100)



# openxlsx::addWorksheet(wb,"countries")
# openxlsx::writeData(wb, sheet = "countries", table, colNames = T, rowNames = F)
# 
# openxlsx::addWorksheet(wb,"clusters")
# openxlsx::writeData(wb, sheet = "clusters", cluster_table, colNames = T, rowNames = F)




```

```{r cluster_stats,echo=FALSE,warning=FALSE,fig.width=8,fig.height=2,include=FALSE}

p3 <- gather(cluster_table,var,value,GHG_fraction:pop_fraction)  %>% 
  filter(!is.na(cluster)) %>% 
  mutate(var=ifelse(var=="CO2_fraction","CO2",var)) %>% 
  mutate(var=ifelse(var=="GHG_fraction","GHG",var)) %>% 
  mutate(var=ifelse(var=="pop_fraction","pop",var)) %>% 
  ggplot(.,aes(x=var,y=value,fill=cluster)) +
  geom_bar(stat='identity') +
  facet_grid(.~cluster) +
  #scale_x_continuous(limits=c(1970,2018),breaks=c(1970,1990,2010)) +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank()) +
  ggtitle("c. Fraction of global CO2 emissions, GHG emissions and population by cluster")

  

```

```{r cluster_plot,echo=FALSE,warning=FALSE,fig.width=8,fig.height=7,fig.path="../../Results/Plots/Peak/",dev=c('png','pdf')}


p2 / p1 / p3 + plot_layout(heights = c(2,1,1))

```

```{r quadrants,echo=FALSE,warning=FALSE,fig.width=5,fig.height=4,fig.path="../../Results/Plots/Peak/",dev=c('png','pdf')}



peak_roll %>%
  filter(year==2018) %>%
  ggplot(.,aes(x=peak_year,rate_CO2_peak,label=country,color = cluster)) +
  geom_point() +
  geom_text(hjust=0) +
  #geom_vline(xintercept = 2000) + # plot vertical line
  #geom_hline(yintercept = -2) +
  #ylim(-4,0) +
  xlim(1970,2018) +
  xlab("Year of peak GHG emissions") +
  ylab("Rate of GHG emissions reduction since peak year") +
  theme(legend.position="none")

  

```

```{r country_stats,include=FALSE,warning=FALSE}

# fraction of 
# - global population
# - global GHG
# - global CO2
# - global income
# - what regions

# table <- data %>% 
#   ungroup() %>% 
#   filter(year>=time_start) %>% 
#   filter(year<2019) %>% 
#   group_by(country,region_ar6_10) %>% 
#   summarise(GHG_2005=nth(GHG,1)/1e6,GHG_2018=nth(GHG,-1)/1e6,pop=nth(pop_UN,-1),rate_2005=nth(rate_GHG_2005,-1))
# 
# table <- table %>% 
#   mutate(abs_reduction_2005=GHG_2005-GHG_2018)
# 
# new_peak_rates <- peak_rates %>% 
#   ungroup() %>% 
#   group_by(country) %>% 
#   summarise(peak_year=nth(peak_year,-1),GHG_peak=nth(GHG,1)/1e6,rate_peak=nth(rate_GHG_peak,-1)*100)
# 
# table <- left_join(table,new_peak_rates,by = "country")
# 
# table <- table %>% 
#   mutate(abs_reduction_peak=GHG_peak-GHG_2018)
# 
# ## get global GHG
# 
# world_GHG <- edgar_GHG_ar6 %>% 
#   filter(year==2018) %>% 
#   summarise(GHG=sum(GHG,na.rm = TRUE))
# 
# load('../../Data/land.RData')
# land <- land %>% 
#   group_by(year) %>% 
#   summarise_at(vars(blue,houghton),sum)
# land <- land %>% 
#   group_by(year) %>% 
#   mutate(mean=sum(blue,houghton)/2)
# 
# world_GHG$GHG = (world_GHG$GHG+land$mean[land$year==2018])/1e6
# 
# ## get global pop
# 
# world_pop <- basic %>% 
#   filter(Year==2018) %>% 
#   filter(Country=="World") %>% 
#   select(pop_UN)
# 
# ## get totals
# 
# totals <- table %>%
#   group_by(region_ar6_10) %>% 
#   summarise_at(vars(GHG_2018,pop,abs_reduction_2005,abs_reduction_peak),sum)
# 
# totals <- totals %>% 
#   mutate(country="Total")
# 
# ## calculate fractions
# 
# table <- table %>% 
#   mutate(GHG_fraction=(GHG_2018/world_GHG$GHG)*100) %>% 
#   mutate(pop_fraction=(pop/world_pop$pop_UN)*100)
# 
# totals <- totals %>% 
#   mutate(GHG_fraction=(GHG_2018/world_GHG$GHG)*100) %>% 
#   mutate(pop_fraction=(pop/world_pop$pop_UN)*100)
# 
# table <- table %>% 
#   select(country,pop_fraction,GHG_fraction,GHG_2018,abs_reduction_2005,rate_2005,peak_year,abs_reduction_peak,rate_peak)
# 
# table <- bind_rows(table %>% arrange(desc(abs_reduction_2005)),totals %>% select(-pop,-region_ar6_10))
# 
# openxlsx::addWorksheet(wb,"summary_table")
# openxlsx::writeData(wb, sheet = "summary_table", table, colNames = T, rowNames = F)


```



```{r sectors,include=FALSE,warning=FALSE,fig.width=8,fig.height=7,fig.path="../../Results/Plots/Peak/",dev=c('png','pdf')}



# 
# sectors <- right_join(edgar_GHG_ar6,rates,by=c("country"="country"))
# 
# sectors <- sectors %>%
#   filter(rate_CO2=="decline") %>%
#   filter(year %in% c(1970,1975,1980,1985,1990,1995,2000,2005,2010,2015,2018)) %>%
#   group_by(country,year,chapter_title) %>%
#   summarise_at(vars(CO2),sum,na.rm=TRUE) %>%
#   ungroup() %>%
#   mutate(year=as.factor(year))
# 
# sectors %>% ggplot(.,aes(x=year,y=CO2,fill=chapter_title)) +
#   geom_bar(stat='identity') +
#   facet_grid(country~chapter_title,scales="free") +
#   theme(legend.position="none",
#         axis.title.x = element_blank(),
#         axis.text.y = element_blank()) +
#   ylab("GHG emissions tCO2eq/year") +
#   ggtitle("GHG emissions in developed countries by sector")

```


```{r write_data,echo=FALSE,warning=FALSE}


#openxlsx::saveWorkbook(wb,paste0("../../Results/Data/decarbonising_countries.xlsx"),overwrite=T)

```



```{r decline_since_2005,echo=FALSE,warning=FALSE,fig.width=8,fig.height=9,fig.path="../../Results/Plots/Peak/",dev=c('png','pdf')}


# 
# ## calculate growth rates - Glen and Robbie method
# 
# time_start=2005
# 
# rates <- data %>% 
#   filter(year>=time_start & year<2019) %>% 
#   group_by(country) %>% 
#   mutate(rate_GHG_2005=growth_rate(year,GHG)$rate,
#          fit=growth_rate(year,GHG)$data$predicted_x,
#          st_error=growth_rate(year,GHG)$data$st_error) %>% 
#   ungroup() %>% 
#   mutate(rate_GHG_2005=rate_GHG_2005*100) %>% 
#   select(country,ISO,year,rate_GHG_2005,fit,st_error)
# 
# 
# data <- left_join(data,rates,by = c("ISO", "country", "year"))
# 
# data <- data %>% 
#   group_by(country) %>% 
#   mutate(rate_GHG_2005=na.locf(rate_GHG_2005,fromLast=TRUE)) %>% 
#   mutate(fit=na.locf(fit,fromLast=TRUE)) %>% 
#   mutate(st_error=na.locf(st_error,fromLast = TRUE))
# 
# 
# ##### filter results
# 
# ## filter out countries with growing emissions
# 
# data <- data %>% 
#   filter(rate_GHG_2005<0)
# 
# filtered_countries <- data
# 
# 
# ## filter out non-developed countries
# 
# data <- data %>% 
#   filter(region_ar6_10=="Europe" | region_ar6_10=="Asia-Pacific Developed" | region_ar6_10=="North America")
# 
# 
# ## filter to countries where rate is smaller than -0.5%
# 
# data <- data %>% 
#   filter(abs(rate_GHG_2005)>0.5)
# 
# 
# ## save filtered countries
# 
# filtered_countries <- anti_join(filtered_countries,data)
# 
# 
# ## set facet labels and order by growth rate
# 
# data <- data %>% 
#   mutate(labels=paste0(country," (",round(rate_GHG_2005,2),"%)")) %>% 
#   mutate(labels=as.factor(labels))
# 
# data$labels=fct_reorder(data$labels,data$rate_GHG_2005)
# 
# 
# data %>% 
#   filter(year>1989) %>% 
#   ggplot(.,aes(x=year,y=GHG)) +
#   geom_path() +
#   geom_line(data=data %>% filter(year>=time_start),aes(x=year,y=fit),colour="red") +
#   scale_x_continuous(breaks=c(1990,2000,2010)) +
#   scale_y_continuous(expand = expand_scale(mult = c(0, .2)), limits = c(0, NA)) +
#   facet_wrap(.~labels,scales="free",labeller = label_wrap_gen(width=23,multi_line = TRUE)) +
#   theme(axis.text.y = element_blank(),
#         axis.ticks.y = element_blank(),
#         legend.position = "none",
#         legend.title = element_blank(),
#         axis.title = element_blank()) +
#   ggtitle("Countries with declining emissions 2005-2018")
# 
# 
# filtered_countries <- filtered_countries %>% 
#   mutate(labels=paste0(country," (",round(rate_GHG_2005,2),"%)")) %>% 
#   mutate(labels=as.factor(labels))
# 
# filtered_countries$labels=fct_reorder(filtered_countries$labels,filtered_countries$rate_GHG_2005)
# 
# 
# filtered_countries %>% 
#   filter(year>1989) %>% 
#   ggplot(.,aes(x=year,y=GHG)) +
#   geom_path() +
#   geom_line(data=filtered_countries %>% filter(year>=time_start),aes(x=year,y=fit),colour="red") +
#   scale_x_continuous(breaks=c(1990,2000,2010)) +
#   scale_y_continuous(expand = expand_scale(mult = c(0, .2)), limits = c(0, NA)) +
#   facet_wrap(.~labels,scales="free",labeller = label_wrap_gen(width=23,multi_line = TRUE)) +
#   theme(axis.text.y = element_blank(),
#         axis.ticks.y = element_blank(),
#         legend.position = "none",
#         legend.title = element_blank(),
#         axis.title = element_blank()) +
#   ggtitle("Countries with declining emissions 2005-2018 (Excluded)")
# 


```

```{r countries,echo=FALSE,warning=FALSE,fig.width=8,fig.height=6,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf'),results="asis"}

# country_handle="United States"
# time_start = 2005
# 
# country_plot <- function(country_handle,edgar_GHG_ar6,rate) {
#   
#   data <- edgar_GHG_ar6 %>%
#     filter(year>1989) %>% 
#     filter(country==country_handle) %>% 
#     group_by(country,year,chapter,chapter_title) %>% 
#     summarise_at(vars(GHG),sum,na.rm=TRUE) %>% 
#     mutate(GHG=GHG/1e7) %>% 
#     ungroup() %>% 
#     mutate(chapter_title=as.factor(chapter_title))
#   
#   sector_rates <- data %>% 
#     filter(year %in% c(time_start,2018)) %>% 
#     group_by(country,chapter,chapter_title) %>% 
#     mutate(rate=((last(GHG)/first(GHG))^(1/(last(year)-first(year)))-1)*100) %>% 
#     filter(year==2018) 
#   
#   sector_rates <- sector_rates %>% 
#     arrange(desc(chapter_title)) %>% 
#     mutate(location=GHG/2) %>% 
#     group_by(country) %>% 
#     mutate(GHG=cumsum(GHG))
#   
#   z = 5
#   for (i in 2:z) {
#     sector_rates$location[i] = sector_rates$location[i] + sector_rates$GHG[i-1]
#   }
#     
#   sector_rates <- sector_rates %>%  
#     select(-year,-GHG)
#   
#   data <- left_join(data,sector_rates, by = c("country", "chapter", "chapter_title"))
#   
#   p1 <- data %>%
#     filter(year>1989) %>% 
#     ggplot(.,aes(x=year,y=GHG,fill=chapter_title)) +
#     geom_area(colour="#737373") +
#     geom_text(data = data %>% filter(year==2018),
#               aes(x=year+1,y=location,colour=chapter_title,label=paste0(chapter_title," [",ifelse(rate>0,"+",""),round(rate,1),"%]")),hjust=0,) +
#     geom_vline(xintercept=c(time_start,2018),alpha=0.3,linetype="dashed") +
#     scale_fill_brewer(palette = "Set2") +
#     scale_colour_brewer(palette = "Set2") +
#     scale_x_continuous(limits = c(1990,2026)) +
#     ylab("GHG Emissions (MtCO2eq)") + 
#     theme(axis.title.x = element_blank(),
#           legend.position = "none") +
#     ggtitle(paste0(country_handle," - ",rate,"% decline since ",time_start))
#   
#   data <- edgar_GHG_ar6 %>% 
#     filter(country==country_handle) %>% 
#     group_by(country,year,chapter_title,subsector,subsector_title) %>% 
#     summarise_at(vars(GHG),sum,na.rm=TRUE) %>% 
#     mutate(GHG=GHG/1e7)
#   
#   subsector_rates <- data %>% 
#     filter(year %in% c(2000,2018)) %>% 
#     group_by(country,subsector,subsector_title) %>% 
#     mutate(rate=((last(GHG)/first(GHG))^(1/(last(year)-first(year)))-1)*100) %>% 
#     filter(year==2018)
#   
#   data <- data %>% 
#     filter(year %in% c(2000,2018)) %>% 
#     group_by(country,subsector_title) %>% 
#     mutate(difference=last(GHG)-first(GHG)) %>% 
#     mutate(rate_sector=((last(GHG)/first(GHG))^(1/(last(year)-first(year)))-1)*100)
#   
#   total_GHG <- data %>% filter(year==2018) %>% group_by(country) %>% summarise(GHG=sum(GHG))
#   
#   data <- data %>% 
#     filter(year==2018) %>% 
#     mutate(filter=(abs(difference)/total_GHG$GHG)*100)
#   
#   p2 <- data %>% 
#     filter(filter>=0.25) %>% 
#     ggplot(.,aes(x=reorder(subsector_title,desc(difference)),y=difference,fill=chapter_title)) +
#     geom_text(aes(x=reorder(subsector_title,desc(difference)),y=difference,label=paste0(ifelse(rate_sector>0,"+",""),round(rate_sector,1),"%"),hjust = ifelse(difference >= 0, -0.1, 1.1)),size=3,colour="#737373") +
#     geom_bar(stat='identity',colour="#737373") +
#     scale_y_continuous(expand = expand_scale(mult = c(0.15, .15))) +
#     scale_fill_manual(values= colours_sectors) +
#     ylab(paste0("GHG Emissions change in major sectors, ",time_start,"-2018 (MtCO2eq)")) +
#     xlab('') +
#     coord_flip() +
#     theme(legend.position="none")
#   
#   p <- ggarrange(p1,p2,nrow=2)
#   
#   return(list("plot"=p,"data"=data))
# }
# 
# 
# for (i in 1:length(rates$country[rates$decline==1])) {
# #for (i in 1:2) {
#  
#   country_handle = rates$country[rates$decline==1][i]
#   rate = round(abs(rates$rate_GHG[rates$decline==1][i]*100),1)
#   
#   p <- country_plot(country_handle,edgar_GHG_ar6,rate)
#   cat("  \n### ",country_handle,"  \n")
#   print(p$plot)
#   cat("  \n")
#   
# }




```
```{r save_data,echo=FALSE,warning=FALSE}

# output <- data %>% 
#   filter(year %in% c(time_start,2017)) %>% 
#   group_by(country) %>% 
#   summarise(rate_POP=(last(pop_UN)/first(pop_UN))^(1/(last(year)-time_start))-1,
#     rate_GDP=(last(gdp_ppp_WB)/first(gdp_ppp_WB))^(1/(last(year)-time_start))-1) %>% 
#   ungroup()
# 
# output <- left_join(data,output,by = "country")
# output <- output %>% 
#   group_by(country) %>% 
#   fill(gdp_ppp_WB)
# 
# output <- output %>% 
#   filter(year==2018) %>% 
#   select(-year,-decline)
# 
# 
# 
# wb <- openxlsx::createWorkbook(title = paste("decarbonising_countries",Sys.Date()))
# openxlsx::addWorksheet(wb,"data")
# openxlsx::writeData(wb, sheet = "data", output, colNames = T, rowNames = F)
# openxlsx::saveWorkbook(wb,paste0("../../Results/Data/decarbonising_countries_",Sys.Date(),".xlsx"),overwrite=T)

```


