---
title: "Decarbonising countries"
author: "William F. Lamb"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    toc: yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../Results") })
  
---

```{r setup,include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(ggplot2); theme_set(theme_bw())
library(zoo)
library(cluster)
library(ggmap)
library(maps)
library(patchwork)

load('../../Data/edgar_data_gwp_ar6.RData')
load('../../Data/basic.RData')

source("growth_rate.R")

isos <- openxlsx::read.xlsx("C:/Users/lamw/Documents/SpiderOak Hive/Work/Code/R/.Place names and codes/output/ISOcodes.xlsx","alternative_names")

colours_sectors <- c(`AFOLU` = "#66c2a5",
                       `Buildings` = "#fc8d62",
                       `Energy systems` = "#8da0cb",
                       `Industry` = "#e78ac3",
                       `Transport` = "#a6d854")

wb <- openxlsx::createWorkbook(title = paste("decarbonising_countries"))
openxlsx::addWorksheet(wb,"info")

info = data.frame(x=c("Title","Author","Date","Code"),y=c("Analysis of countries with sustained GHG emissions reductions","William F. Lamb (lamb@mcc-berlin.net)",paste(Sys.Date()),"https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers/blob/master/R/Analysis%20and%20figures/decarbonising_countries.Rmd"))

openxlsx::writeData(wb, sheet = "info", info, colNames = F, rowNames = F)

# set palette
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Set2") + scale_fill_brewer(palette="Set2")


```

```{r calculate_rates,echo=FALSE,warning=FALSE,include=FALSE}

## gather data

data <- edgar_GHG_ar6 %>% 
  group_by(ISO,country,year,region_ar6_10) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas,GHG),sum,na.rm=TRUE)

## join population and GDP data

data <- left_join(data,basic %>% select(ISO,Year,pop_UN,gdp_ppp_WB),by=c("ISO"="ISO","year"="Year"))

## filter to countries above 1m population

data <- data %>% 
  group_by(country) %>% 
  mutate(include=ifelse(max(pop_UN)>1e6,1,0)) %>% 
  ungroup() %>% 
  filter(include==1) %>% 
  select(-include)


## find peak year CO2, excluding years after 2009

peak_years <- data %>% 
  filter(year<2009) %>% 
  group_by(country) %>% 
  summarise(peak_year=year[which.max(CO2)])

data <- left_join(data,peak_years,by = "country")

## calculate CO2 growth since peak year

rates_CO2 <- data %>% filter(country=="nothing") # create empty dataframe

for (i in 1:length(unique(data$country))) {
  
  temp_data <- data %>% 
    filter(country==unique(data$country)[i])
  
  temp_data <- temp_data %>% 
    filter(year>=temp_data$peak_year[1])
  
  rates <- growth_rate(temp_data$year,temp_data$CO2)
  
  temp_data$rate_CO2_peak <- rates$rate
  temp_data$fit <- rates$data$predicted_x
  temp_data$st_error <- rates$data$st_error
  
  rates_CO2 <- rbind(rates_CO2,temp_data)
}

#rejoin with full data

data <- left_join(data,rates_CO2 %>% select(country,year,rate_CO2_peak,fit,st_error),by = c("country", "year"))

data <- data %>% 
  group_by(country) %>% 
  mutate(rate_CO2_peak=na.locf(rate_CO2_peak,fromLast=TRUE))


## now do the same for GHG emissions

rates_GHG <- data %>% 
  filter(country=="nothing") %>%  # create empty dataframe 
  select(-fit,-rate_CO2_peak,-st_error)
  
for (i in 1:length(unique(data$country))) {
  
  temp_data <- data %>% 
    filter(country==unique(data$country)[i])
  
  temp_data <- temp_data %>% 
    filter(year>=temp_data$peak_year[1])
  
  rates <- growth_rate(temp_data$year,temp_data$GHG)
  
  temp_data$rate_GHG_peak <- rates$rate
  temp_data$fit <- rates$data$predicted_x
  temp_data$st_error <- rates$data$st_error
  
  rates_GHG <- rbind(rates_GHG,temp_data)
}


#rejoin with full data

data <- left_join(data,rates_GHG %>% select(country,year,rate_GHG_peak),by = c("country", "year"))

data <- data %>% 
  group_by(country) %>% 
  mutate(rate_GHG_peak=na.locf(rate_GHG_peak,fromLast=TRUE))



```

```{r exclusions,echo=FALSE,warning=FALSE}


# exclude countries with growth rates above 0

data <- data %>% 
  mutate(rate_CO2_peak=rate_CO2_peak*100) %>% 
  mutate(rate_GHG_peak=rate_GHG_peak*100) %>% 
  filter(rate_CO2_peak<0)

# calculate absolute and relative reductions since peak

rates_CO2 <- rates_CO2 %>% 
  group_by(country) %>% 
  summarise(percent_reduction_CO2_peak=((first(CO2)-last(CO2))/first(CO2))*100,
            absolute_reduction_CO2_peak=first(CO2)-last(CO2),
            CO2_peak=first(CO2))

rates_GHG <- rates_GHG %>% 
  group_by(country) %>% 
  summarise(percent_reduction_GHG_peak=((first(GHG)-last(GHG))/first(GHG))*100,
            absolute_reduction_GHG_peak=first(GHG)-last(GHG),
            GHG_peak=first(GHG))

data <- left_join(data,rates_CO2,by = "country")
data <- left_join(data,rates_GHG,by = "country")

# exclude countries where the overall CO2 reduction since peak is <10%

data <- data %>% 
  filter(percent_reduction_CO2_peak>10)

# exclude countries with recent major civil conflict or economic decline

data <- data %>%
  filter(country!="Yemen, Rep.") %>% 
  filter(country!="Venezuela, RB") %>% 
  filter(country!="Syrian Arab Republic") %>% 
  filter(country!="Korea, Dem. People's Rep.") %>% 
  filter(country!="Libya") %>% 
  filter(country!="Afghanistan")

# exclude countries with extreme year to year emissions increase (i.e. due to territory or political changes)

data <- data %>%
  filter(country!="Estonia") %>% 
  filter(country!="Moldova") %>% 
  filter(country!="Swaziland")

# exclude countries with growing GHG emissions since the same CO2 peak year

data <- data %>% 
  filter(rate_GHG_peak<0)

# exclude small countries with large oil industries and therefore large yearly emissions variations

data <- data %>% 
  filter(country!="Equatorial Guinea") %>% 
  filter(country!="Timor-Leste")

# exclude Austria, which has an absolute increase in GHG emissions since CO2 peak year (special!)

data <- data %>% 
  filter(country!="Austria")

# openxlsx::addWorksheet(wb,"data_included_countries")
# openxlsx::writeData(wb, sheet = "data_included_countries", data, colNames = T, rowNames = F)
# 
# openxlsx::addWorksheet(wb,"data_excluded_countries")
# openxlsx::writeData(wb, sheet = "data_excluded_countries", filtered_countries, colNames = T, rowNames = F)


```

```{r clustering,echo=FALSE,warning=FALSE,include=FALSE}


data <- data %>% 
  group_by(country) %>% 
  mutate(CO2_rm = rollmean(CO2,1,na.pad=TRUE,align="right"))

## normalise

data <- data %>% 
  group_by(country) %>% 
  mutate(CO2_rm = CO2_rm/nth(CO2_rm,1)) %>% 
  ungroup()

## import manual clusters

cluster_data <- openxlsx::read.xlsx('../../Data/Codes and classifications/decarbonising_country_clusters.xlsx','clusters')


## cluster by peak year

# data <- data %>% 
#   group_by(country) %>% 
#   mutate(min_year=year[which.min(CO2)]) %>% 
#   ungroup()
# 
# 
# cluster_data <- data %>% select(ISO,peak_year,min_year) %>% distinct()
# 
# clusters <- kmeans(cluster_data %>% select(-ISO),3)
# cluster_data <- cbind(cluster_data,cluster=clusters$cluster) ### bind clusters to dataset
# cluster_data$cluster <- as.factor(clusters$cluster) ### convert to factor

## cluster by normalised emissions in sliced years

# cluster_data <- data %>% 
#   #filter(year %in% c(1971,1976,1981,1986,1991,1996,2001,2006,2011,2016)) %>% 
#   #filter(year %in% c(1971,1981,1991,2001,2011,2017)) %>% 
#   filter(year %in% c(1970,1975,1980,1985,1990,1995,2000,2005,2010,2015)) %>% 
#   #filter(year %in% c(1972,1977,1982,1987,1992,1997,2002,2007,2012,2017)) %>% 
#   ungroup()

#cluster_data <- spread(cluster_data %>% select(country,ISO,year,CO2_rm),year,CO2_rm)

# clusters <- pam(cluster_data %>% select(-country,-ISO),4)
# cluster_data <- cbind(cluster_data,cluster=clusters$clustering) ### bind clusters to dataset
# cluster_data$cluster <- as.factor(clusters$clustering) ### convert to factor

# clusters <- kmeans(cluster_data %>% select(-country,-ISO),4)
# cluster_data <- cbind(cluster_data,cluster=clusters$cluster) ### bind clusters to dataset
# cluster_data$cluster <- as.factor(clusters$cluster) ### convert to factor

if ("cluster" %in% colnames(data)) {
  data <- data %>% select(-cluster)
}

data <- left_join(data,cluster_data %>% select(country,cluster),by="country")


```

```{r all_countries_trend,echo=FALSE,warning=FALSE,fig.width=10,fig.height=11,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}

## set facet labels and order by cluster and growth rate

data <- data %>% 
  mutate(labels=paste0(country," (",round(rate_CO2_peak,1),"%)"))

data <- data %>% 
  mutate(labels=as.factor(labels)) %>% 
  mutate(cluster=as.factor(cluster))

data$labels=fct_reorder(data$labels,as.numeric(data$cluster))

data %>% 
  ggplot(.,aes(x=year,y=CO2)) +
  geom_path() +
  geom_line(data=data,aes(x=year,y=fit),colour="red") +
  geom_text(data=data %>% filter(year==2015),aes(x=1970,y=0,label=paste0("Group ",cluster),color=cluster),hjust="inward",vjust="inward",size=3.5) + #color="#636363") + 
  scale_x_continuous(limits=c(1970,2018),breaks=c(1970,1990,2010)) +
  scale_y_continuous(expand = c(0.1, .1), limits = c(0, NA)) +
  facet_wrap(.~labels,scales="free",labeller = label_wrap_gen(width=19,multi_line = TRUE)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank()) +
  ggtitle("CO2 emissions trends of decarbonising countries")


```

```{r cluster_summary,echo=FALSE,warning=FALSE,include=FALSE,fig.width=8,fig.height=2}

clusters <- data %>% 
  group_by(cluster,year) %>% 
  summarise(CO2_rm=mean(CO2_rm)) %>% 
  ungroup() %>% 
  group_by(cluster) %>% 
  mutate(CO2_rm = rollmean(CO2_rm,3,na.pad=TRUE,align="right"))

peak_years <- data %>% 
  filter(year==2018) %>% 
  group_by(cluster) %>% 
  summarise(mean_peak_year=round(mean(peak_year),0),n=n())

p1 <- data %>% ggplot(.,aes(x=year,y=CO2_rm,group=country,colour=cluster)) +
  geom_path(alpha=0.4) +
  geom_path(data=clusters,inherit.aes=FALSE,aes(x=year,y=CO2_rm,colour=cluster),size=1) +
  
  geom_text(data=peak_years,inherit.aes=FALSE,aes(x=1970,y=4.1,label=paste0("Mean peak yr: ",mean_peak_year)),hjust=0,size=3.5,lineheight=0.85,color="#636363") +
  
  geom_text(data=peak_years,inherit.aes=FALSE,aes(x=1970,y=3.4,label=paste0("No. countries: ",n)),hjust=0,size=3.5,lineheight=0.85,color="#636363") +
  facet_grid(.~cluster) +
  scale_x_continuous(limits=c(1970,2018),breaks=c(1970,1990,2010)) +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size=12),
        strip.background = element_blank(),
        strip.text = element_blank()) +
  ggtitle("b. CO2 Emissions trajectories and peak years")
p1



```

```{r map,echo=FALSE,warning=FALSE,include=FALSE,fig.width=8,fig.height=3}


world <- map_data("world") %>% 
  filter(region!="Antarctica")
world <- left_join(world %>% mutate(region=tolower(region)),isos,by=c("region"="alternative.name"))
world <- left_join(world,data %>% select(ISO,cluster) %>% distinct(),by=c("alpha.3"="ISO"))


p2 <- ggplot() + 
  geom_polygon(data = world, aes(x=long, y = lat, group=group, fill=cluster),color="white",size=0.25,na.rm=T) + 
  #coord_fixed(1,xlim=c(-155,175),ylim=c(0,75)) +
  scale_fill_brewer(palette = "Set2",na.value='#969696') +
  theme(panel.border = element_rect(colour = "black",fill=NA),
        legend.position = "none",
        legend.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm"),
        plot.title = element_text(size=12)) +
  ggtitle("a. Countries with declining CO2 and GHG emissions since 1970")
p2

```


```{r tables,echo=FALSE,warning=FALSE,include=FALSE}


# fraction of
# - global population
# - global GHG
# - global CO2
# - global income
# - what regions

table <- data %>% 
  filter(year==2018) %>% 
  select(ISO,country,region_ar6_10,cluster,
         CO2_2018=CO2,
         GHG_2018=GHG,
         pop_2018=pop_UN,
         peak_year,
         CO2_peak,
         GHG_peak,
         CO2_rate=rate_CO2_peak,
         GHG_rate=rate_GHG_peak,
         abs_reduction_CO2=absolute_reduction_CO2_peak,
         abs_reduction_GHG=absolute_reduction_GHG_peak,
         rel_reduction_CO2=percent_reduction_CO2_peak,
         rel_reduction_GHG=percent_reduction_GHG_peak)

table <- table %>% 
  mutate(abs_reduction_CO2=abs_reduction_CO2/1e6) %>% 
  mutate(abs_reduction_GHG=abs_reduction_GHG/1e6) %>% 
  mutate(CO2_2018=CO2_2018/1e6) %>% 
  mutate(GHG_2018=GHG_2018/1e6) %>% 
  mutate(pop_2018=pop_2018/1e6) %>% 
  mutate(CO2_peak=CO2_peak/1e6) %>% 
  mutate(GHG_peak=GHG_peak/1e6) %>% 
  mutate(CO2_2018_pc = CO2_2018/pop_2018) %>% 
  mutate(GHG_2018_pc = GHG_2018/pop_2018)

## get global GHG

world_GHG <- edgar_GHG_ar6 %>%
  filter(year==2018) %>%
  summarise(GHG=sum(GHG,na.rm = TRUE)/1e6,CO2=sum(CO2,na.rm=TRUE)/1e6)

## get global pop

world_pop <- basic %>%
  filter(Year==2018) %>%
  filter(Country=="World") %>%
  select(pop_UN)

## calculate totals

totals <- table %>% 
  summarise(CO2_2018=sum(CO2_2018),GHG_2018=sum(GHG_2018),pop_2018=sum(pop_2018),
            CO2_peak=sum(CO2_peak),GHG_peak=sum(GHG_peak),
            abs_reduction_CO2=sum(abs_reduction_CO2),abs_reduction_GHG=sum(abs_reduction_GHG)) %>% 
  mutate(country="Total")

table <- bind_rows(table,totals)

## calculate fractions

table <- table %>%
  mutate(GHG_fraction=(GHG_2018/world_GHG$GHG)*100) %>%
  mutate(CO2_fraction=(CO2_2018/world_GHG$CO2)*100) %>% 
  mutate(pop_fraction=(pop_2018/(world_pop$pop_UN/1e6))*100)


### cluster table

cluster_table <- table %>% 
  filter(!is.na(cluster)) %>% 
  group_by(cluster) %>% 
  summarise(mean_peak_year=round(mean(peak_year),0),CO2_2018=sum(CO2_2018),GHG_2018=sum(GHG_2018),pop_2018=sum(pop_2018),CO2_peak=sum(CO2_peak),GHG_peak=sum(GHG_peak),abs_reduction_CO2=sum(abs_reduction_CO2),abs_reduction_GHG=sum(abs_reduction_GHG),countries=paste0(country,collapse="; "))

## calculate totals

totals <- totals %>% 
  summarise(CO2_2018=sum(CO2_2018),GHG_2018=sum(GHG_2018),pop_2018=sum(pop_2018),
            CO2_peak=sum(CO2_peak),GHG_peak=sum(GHG_peak),
            abs_reduction_CO2=sum(abs_reduction_CO2),abs_reduction_GHG=sum(abs_reduction_GHG)) %>% 
  mutate(countries="Total")

cluster_table <- bind_rows(cluster_table,totals)

cluster_table <- cluster_table %>%
  mutate(GHG_fraction=(GHG_2018/world_GHG$GHG)*100) %>%
  mutate(CO2_fraction=(CO2_2018/world_GHG$CO2)*100) %>% 
  mutate(pop_fraction=(pop_2018/(world_pop$pop_UN/1e6))*100)

cluster_table <- cluster_table %>% 
  mutate(rel_reduction_CO2=(abs_reduction_CO2/CO2_peak)*100) %>% 
  mutate(rel_reduction_GHG=(abs_reduction_GHG/GHG_peak)*100)



```

```{r cluster_stats,echo=FALSE,warning=FALSE,fig.width=8,fig.height=2,include=FALSE}

plot_data <- gather(cluster_table,var,value,GHG_fraction:pop_fraction) %>% 
  filter(!is.na(cluster)) %>% 
  mutate(var=ifelse(var=="CO2_fraction","CO2",var)) %>% 
  mutate(var=ifelse(var=="GHG_fraction","GHG",var)) %>% 
  mutate(var=ifelse(var=="pop_fraction","pop",var)) 

p3 <- plot_data %>% 
  ggplot(.,aes(x=var,y=value,fill=cluster)) +
  geom_bar(stat='identity',color="#636363") +
  geom_text(data=plot_data,inherit.aes=FALSE,aes(x=var,y=value+3,label=round(value,1)),size =3.5,color="#636363") +
  facet_grid(.~cluster) +
  scale_y_continuous(expand = c(0, 3)) +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size=12),
        strip.background = element_blank(),
        strip.text = element_blank()) +
  ggtitle("c. Fraction (%) of global CO2 emissions, GHG emissions and population by cluster")
p3
  

```

```{r cluster_abs_rel_reductions,echo=FALSE,warning=FALSE,include=FALSE,fig.width=6,fig.height=2}

# for each country, for each year, find the emissions difference to the previous year

plot_data <- gather(cluster_table,var,value,abs_reduction_CO2,abs_reduction_GHG) %>% 
  mutate(var=ifelse(var=="abs_reduction_CO2","CO2",var)) %>% 
  mutate(var=ifelse(var=="abs_reduction_GHG","GHG",var)) %>% 
  filter(!is.na(cluster)) %>% 
  mutate(value=value/1000)

p4 <- plot_data %>% ggplot(.,aes(x=var,y=value,fill=cluster)) +
  geom_bar(stat='identity',color="#636363") +
  geom_text(data=plot_data,inherit.aes=FALSE,aes(x=var,y=value+0.2,label=round(value,1)),size =3.5,color="#636363") +
  facet_grid(.~cluster) +
  scale_y_continuous(expand = c(0, 0.2)) +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size=12),
        strip.background = element_blank(),
        strip.text = element_blank()) +
  ggtitle("d. Absolute reduction in emissions since peak years (Gt CO2eq)")
p4 


plot_data <- gather(cluster_table,var,value,rel_reduction_CO2,rel_reduction_GHG) %>% 
  mutate(var=ifelse(var=="rel_reduction_CO2","CO2",var)) %>% 
  mutate(var=ifelse(var=="rel_reduction_GHG","GHG",var)) %>% 
  filter(!is.na(cluster))

p4 <- plot_data %>% ggplot(.,aes(x=var,y=value,fill=cluster)) +
  geom_bar(stat='identity',color="#636363") +
  geom_text(data=plot_data,inherit.aes=FALSE,aes(x=var,y=value+5,label=round(value,1)),size =3.5,color="#636363") +
  facet_grid(.~cluster) +
  scale_y_continuous(expand = c(0, 5)) +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.title = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size=12),
        strip.background = element_blank(),
        strip.text = element_blank()) +
  ggtitle("d. Relative reduction in emissions since peak years (%)")
p4 

```

```{r cluster_plot,echo=FALSE,warning=FALSE,fig.width=6.5,fig.height=8,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}


p2 / p1 / p3 / p4 + plot_layout(heights = c(2,1,1,1))

```

```{r country_rates,echo=FALSE,warning=FALSE,fig.width=8,fig.height=9,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}

rate_data <- data %>% 
  mutate(absolute_reduction_CO2_peak=round((absolute_reduction_CO2_peak/1e6),0)) %>% 
  mutate(percent_reduction_CO2_peak=round((percent_reduction_CO2_peak),0)) %>% 
  mutate(absolute_reduction_GHG_peak=round((absolute_reduction_GHG_peak/1e6),0)) %>% 
  mutate(percent_reduction_GHG_peak=round((percent_reduction_GHG_peak),0))

rate_data <- rate_data %>% 
  ungroup() %>% 
  mutate(country=as.factor(country))

rate_data$country <- fct_reorder(rate_data$country,desc(rate_data$rate_CO2_peak))


r1 <- rate_data %>% 
  filter(year==2018) %>% 
  ggplot(.,aes(y="a",x=country,label=peak_year))+
  geom_text(size =3.5,color="#636363") +
  coord_flip() +
  facet_grid(cluster~.,scales="free_y",space="free") +
  theme(axis.title.y = element_blank(),
        #axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(size = 10),
        strip.background = element_blank(),
        strip.text = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm")) +
  ggtitle("Peak year")


r2 <- rate_data %>% 
  filter(year==2018) %>% 
  ggplot(.,aes(y="a",x=country,label=paste0(absolute_reduction_CO2_peak," (",percent_reduction_CO2_peak,"%)"))) +
  geom_text(size =3.5,color="#636363") +
  coord_flip() +
  facet_grid(cluster~.,scales="free_y",space="free") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position="bottom",
        legend.title=element_blank(),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        plot.title = element_text(size = 10),
        plot.margin = unit(c(0,0,0,0),units="cm"),
        panel.grid.major.x = element_blank()) +
  ggtitle("CO2 reduction\n(MtCO2 & %)")

r3 <- rate_data %>% 
  filter(year==2018) %>% 
  ggplot(.,aes(y="a",x=country,label=paste0(absolute_reduction_GHG_peak," (",percent_reduction_GHG_peak,"%)"))) +
  geom_text(size =3.5,color="#636363") +
  coord_flip() +
  facet_grid(cluster~.,scales="free_y",space="free") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position="bottom",
        legend.title=element_blank(),
        plot.title = element_text(size = 10),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm"),
        panel.grid.major.x = element_blank()) +
  ggtitle("GHG reduction\n(MtCO2 & %)")



rate_data <- gather(rate_data,growth_rate,value,rate_CO2_peak,rate_GHG_peak)

annotes = data.frame(cluster=c("1","2","3"),country=c("Netherlands","Belgium","Russian Federation"))

r4 <- rate_data %>% 
  filter(year==2018) %>% 
  ggplot(.,aes(x=country,y=value,fill=growth_rate)) +
  geom_point(shape=21,size=3,color="#636363",stroke=0.5) +
  geom_text(data=annotes,inherit.aes=FALSE,aes(x=country,y=-5.3,label=paste0("Group ",cluster),color=cluster),hjust=0,vjust=0,size=3.5,show.legend=FALSE) +
  coord_flip() +
  facet_grid(cluster~.,scales="free_y",space="free") +
  scale_y_continuous(breaks=c(-5,-4,-3,-2,-1,0)) +
  scale_fill_manual(labels=c("CO2 emissions","GHG emissions"),values = c("#d7191c","#2c7bb6")) +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position="bottom",
        legend.title=element_blank(),
        plot.title = element_text(size = 10),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm")) +
  ggtitle("Average annual growth rate since peak (%)")

r1 + r2 + r3 + r4 + plot_layout(widths = c(1,1.5,1.5,6))


```


```{r calc_country_sectors,echo=FALSE,warning=FALSE}

# get sector data for countries

sector_data <- right_join(edgar_GHG_ar6,data %>% filter(year==2018) %>% select(country,peak_year,cluster,absolute_reduction_CO2_peak,absolute_reduction_GHG_peak) %>% distinct(),by = "country")

sector_data <- sector_data %>% 
  group_by(country,cluster,peak_year,year,chapter_title,abs_CO2_tot=absolute_reduction_CO2_peak,
           abs_GHG_tot=absolute_reduction_GHG_peak) %>% 
  summarise_at(vars(CO2,GHG),sum,na.rm=TRUE) %>% 
  ungroup() %>% 
  mutate(GHG=GHG/1e6) %>%
  mutate(CO2=CO2/1e6) %>% 
  mutate(abs_CO2_tot=abs_CO2_tot/1e6) %>% 
  mutate(abs_GHG_tot=abs_GHG_tot/1e6)

# filter to years > peak year

sector_data <- sector_data %>% 
  group_by(country,year) %>%
  filter(all(year>=peak_year))

# calculate absolute / relative change in each sector

sector_data <- sector_data %>% 
  group_by(country,cluster,chapter_title,abs_CO2_tot,abs_GHG_tot) %>% 
  summarise(CO2_peak = first(CO2),
            CO2_2018 = last(CO2),
            abs_CO2 = first(CO2)-last(CO2),
            GHG_peak = first(GHG),
            GHG_2018 = last(GHG),
            abs_GHG = first(GHG)-last(GHG))


# reverse signs

sector_data <- sector_data %>%
  mutate(abs_CO2_fraction = (abs_CO2/abs_CO2_tot)*-100) %>% 
  mutate(abs_GHG_fraction = (abs_GHG/abs_GHG_tot)*-100) 

```

```{r country_sectors_CO2,echo=FALSE,warning=FALSE,fig.width=6,fig.height=8,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}

# factorise countries, rank by absolute reduction

sector_data$country <- as.factor(sector_data$country)
sector_data$country <- fct_reorder(sector_data$country,sector_data$abs_CO2_tot)

annotes <- data.frame(cluster=c("1","2","3"),country=c("United States","Germany","Ukraine"))

# plot

sector_data %>% 
  ggplot(.,aes(x=country,y=abs_CO2_fraction,fill=chapter_title)) +
  geom_bar(stat='identity',color="#636363",width = 0.75) +
  geom_text(data=annotes,inherit.aes=FALSE,aes(x=country,y=20,label=paste0("Group ",cluster),color=cluster),hjust=0,vjust=1,size=3.5,show.legend=FALSE) +
  geom_hline(yintercept=0)+
  coord_flip() +
  facet_grid(cluster~.,scales="free_y",space="free") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position="bottom",
        legend.title=element_blank(),
        plot.title = element_text(size = 12),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank()) +
  ggtitle("CO2 reduction by sector (% of total reduction since peak)")


```

```{r country_sectors_GHG,echo=FALSE,warning=FALSE,fig.width=6,fig.height=8,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}

# factorise countries, rank by absolute reduction

sector_data$country <- as.factor(sector_data$country)
sector_data$country <- fct_reorder(sector_data$country,sector_data$abs_GHG_tot)

annotes <- data.frame(cluster=c("1","2","3"),country=c("Cyprus","Macedonia, FYR","Albania"))

# plot

sector_data %>% filter(country!="Uzbekistan") %>%
  ggplot(.,aes(x=country,y=abs_GHG_fraction,fill=chapter_title)) +
  geom_bar(stat='identity',color="#636363",width = 0.75) +
  geom_text(data=annotes,inherit.aes=FALSE,aes(x=country,y=50,label=paste0("Group ",cluster)),color="#636363",hjust=0,vjust=0,size=3.5,show.legend=FALSE) +
  geom_hline(yintercept=0)+
  coord_flip() +
  facet_grid(cluster~.,scales="free_y",space="free") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position="bottom",
        legend.title=element_blank(),
        plot.title = element_text(size = 12),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank()) +
  ggtitle("GHG reduction by sector (% of total reduction since peak)")


```

```{r calc_subsectors,echo=FALSE,warning=FALSE,fig.width=7,fig.height=6,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}


# get sector data for countries

sector_cluster_data <- right_join(edgar_GHG_ar6,data %>% filter(year==2018) %>% select(country,peak_year,cluster,absolute_reduction_CO2_peak,absolute_reduction_GHG_peak) %>% distinct(),by = "country")


sector_cluster_data <- sector_cluster_data %>% 
  mutate(subsector_title=ifelse(subsector_title=="Fuel combustion (REMOVE FROM FIGURES)","Fuel combustion",subsector_title)) %>% 
  mutate(subsector_title=paste0(subsector_title," (",chapter_title,")")) %>% 
  mutate(subsector_title = as.factor(subsector_title))

sector_cluster_data <- sector_cluster_data %>% 
  group_by(country,cluster,peak_year,year,chapter_title,subsector_title,
           abs_CO2_tot=absolute_reduction_CO2_peak,
           abs_GHG_tot=absolute_reduction_GHG_peak) %>% 
  summarise_at(vars(CO2,GHG),sum,na.rm=TRUE) %>% 
  ungroup() %>% 
  mutate(GHG=GHG/1e6) %>%
  mutate(CO2=CO2/1e6) %>% 
  mutate(abs_CO2_tot=abs_CO2_tot/1e6) %>% 
  mutate(abs_GHG_tot=abs_GHG_tot/1e6)

# filter to years > peak year

sector_cluster_data <- sector_cluster_data %>% 
  group_by(country,year) %>%
  filter(all(year>=peak_year))

# calculate absolute / relative change in each sector

sector_cluster_data <- sector_cluster_data %>% 
  group_by(country,cluster,chapter_title,subsector_title,abs_CO2_tot,abs_GHG_tot) %>% 
  summarise(CO2_peak = first(CO2),
            CO2_2018 = last(CO2),
            abs_CO2 = -(first(CO2)-last(CO2)),
            GHG_peak = first(GHG),
            GHG_2018 = last(GHG),
            abs_GHG = -(first(GHG)-last(GHG)))


# reverse signs

sector_cluster_data <- sector_cluster_data %>% 
  group_by(cluster,chapter_title,subsector_title) %>% 
  summarise_at(vars(CO2_peak,CO2_2018,abs_CO2,GHG_peak,GHG_2018,abs_GHG),sum,na.rm=TRUE)

sector_cluster_data <- sector_cluster_data %>% 
  group_by(cluster,chapter_title,subsector_title) %>% 
  mutate(rel_GHG = (abs_GHG/GHG_peak)*100)

```

```{r cluster_subsectors_GHG,echo=FALSE,warning=FALSE,fig.width=9,fig.height=8,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}


plot_data <- sector_cluster_data %>% 
  #filter(GHG_2018>15) %>% 
  filter(subsector_title!="Biomass burning (CO2, CH4) (AFOLU)") %>% 
  filter(subsector_title!="Biomass energy systems (Energy systems)") %>% 
  filter(subsector_title!="Non-CO2 (all buildings) (Buildings)") %>% 
  filter(subsector_title!="Rice cultivation (CH4) (AFOLU)") %>% 
  filter(subsector_title!="Rail  (Transport)") %>% 
  filter(subsector_title!="Other incl. Indirect N2O (Transport)") %>% 
  filter(subsector_title!="Other incl. Indirect N2O (Energy systems)") %>% 
  filter(subsector_title!="Inland Shipping (Transport)") %>% 
  arrange(chapter_title)


plot_data$order <- 1:length(plot_data$cluster)
plot_data$subsector_title <- fct_reorder(plot_data$subsector_title,plot_data$order)


plot_data %>% ggplot(.,aes(x=subsector_title,y=GHG_peak,fill=chapter_title)) + 
  geom_bar(stat='identity',color="#636363",width = 0.75,alpha=0.3) +
  geom_bar(aes(x=subsector_title,y=GHG_2018),stat='identity',color="#636363",width = 0.75) +
  geom_text(aes(x=subsector_title,y=ifelse(GHG_peak>GHG_2018,GHG_peak,GHG_2018),label=paste0(ifelse(rel_GHG>0,"+",""),round(rel_GHG,1),"%")),hjust = -0.15,size=3,colour="#636363",size=3.5) +
  scale_y_continuous(expand=expand_scale(mult = c(0.1, 0.5))) +
  coord_flip() +
  facet_grid(.~cluster,scales="free") +
  theme(axis.title.y = element_blank(),
        legend.position="bottom",
        legend.title=element_blank(),
        plot.title = element_text(size = 11),
        plot.background = element_blank(),
        panel.grid.minor.y = element_blank()) +
  ylab("Annual GHG emissions (MtCO2eq)") +
  ggtitle("Subsector GHG emissions at peak vs 2018 by cluster")
  
  
```

```{r calc_rolling_Rates,echo=FALSE,warning=FALSE,include=FALSE}


# calculate 3 year rolling average rates

rolling_rates <- data.frame() %>% 
  mutate(country=NA) %>% 
  mutate(year=NA) %>% 
  mutate(rate_rolling_CO2=NA) %>% 
  mutate(rate_rolling_GHG=NA)

for (i in 1:length(unique(data$country))) {
  
  temp_data <- data %>% 
    filter(country==unique(data$country)[i])
  
  for (j in seq(1975,2018,by=1)) {
    
    sub_temp_data <- temp_data %>% 
      filter(year<=j) %>% 
      filter(year>=j-4)
    
    rates_CO2 <- growth_rate(sub_temp_data$year,sub_temp_data$CO2)
    rates_GHG <- growth_rate(sub_temp_data$year,sub_temp_data$GHG)
    
    sub_temp_data <- sub_temp_data %>% 
      select(country,year) %>% 
      filter(year==j) %>% 
      mutate(rate_rolling_CO2 = rates_CO2$rate*100) %>% 
      mutate(rate_rolling_GHG = rates_GHG$rate*100)
    
    rolling_rates <- rbind(rolling_rates,sub_temp_data)
    #break
  }
}

rolling_rates <- left_join(rolling_rates,cluster_data %>% select(country,cluster),by = "country")
```

```{r scenario_data,echo=FALSE,warning=FALSE,include=FALSE}

## import scenario data

scenario_data <- read.csv("../../Data/supplemetary data/Emission reduction benchmarks.csv")

scenario_data <- scenario_data %>% 
  rename(rate=reduction_rates_2020.2040) %>% #can be changed
  filter(rate>-25) %>% 
  #filter(is.na(rate)) %>% 
  filter(aggregated_category!="Other") %>% 
  select(aggregated_category,rate) %>% 
  mutate(aggregated_category=as.character(aggregated_category))

scenario_data <- scenario_data %>% 
  mutate(aggregated_category=ifelse(aggregated_category=="1.5C","1.5oC warming",aggregated_category)) %>% 
  mutate(aggregated_category=ifelse(aggregated_category=="High 2C","2oC warming (>50% probability)",aggregated_category)) %>% 
  mutate(aggregated_category=ifelse(aggregated_category=="Low 2C","2oC warming (>66% probability)",aggregated_category))

scenario_data <- scenario_data %>% 
  mutate(country="x") %>% 
  mutate(facet="Scenario reduction rates (2020-2040)") %>% 
  select(country,aggregated_category,rate,facet)

scenario_data$aggregated_category <- as.factor(scenario_data$aggregated_category)
scenario_data$aggregated_category <- factor(scenario_data$aggregated_category, levels=levels(scenario_data$aggregated_category)[c(1,3,2)])
```

```{r rates_over_time,echo=FALSE,warning=FALSE,fig.width=7,fig.height=9,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf')}

rolling_rates <- rolling_rates %>% 
  mutate(threshold_CO2=ifelse(rate_rolling_CO2>-4,NA,"yes"))

lines = scenario_data %>% 
  group_by(aggregated_category) %>% 
  summarise(mean=mean(rate),median=median(rate))

rolling_rates <- rolling_rates %>% 
  group_by(country) %>% 
  mutate(median=median(rate_rolling_CO2)) %>% 
  mutate(mean=mean(rate_rolling_CO2)) %>% 
  mutate(country <- as.factor(country))

rolling_rates$country <- fct_reorder(rolling_rates$country,desc(rolling_rates$median))


p1 <- rolling_rates %>% ggplot(.,aes(x=country,y=rate_rolling_CO2,fill=as.factor(cluster))) +
  geom_hline(yintercept=0) +
  geom_hline(data=lines,aes(yintercept=median,color=aggregated_category),linetype="dashed") +
  geom_boxplot() +
  coord_flip()  +
  ylim(-15,15) +
  scale_color_manual(values=c("#e78ac3","#a6d854","#ffd92f")) +
  facet_grid(cluster~.,scales="free",space="free") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y = element_blank(),
        axis.title.x=element_blank(),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(size = 11),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm")) +
  ggtitle(str_wrap("5 year rolling average CO2 growth rates vs. Paris compatible scenario rates",width=35))

p3 <- scenario_data %>% ggplot(.,aes(x=aggregated_category,y=rate,fill=aggregated_category)) +
  geom_hline(data=lines,aes(yintercept=median,color=aggregated_category),linetype="dashed") +
  geom_boxplot() +
  coord_flip() +
  ylab("%") +
  scale_color_manual(values=c("#e78ac3","#a6d854","#ffd92f")) +
  scale_fill_manual(values=c("#e78ac3","#a6d854","#ffd92f")) +
  scale_x_discrete(labels = function(aggregated_category) str_wrap(aggregated_category, width = 18)) +
  scale_y_continuous(limits=c(-15,15),breaks=c(-10,-5,0,5,10)) +
  theme(axis.title.y = element_blank(),
        plot.title = element_text(size = 11),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm"),
        legend.position="none",
        panel.grid.minor = element_blank())

 p2 <- rolling_rates %>% ggplot(.,aes(x=country,y=year,fill=threshold_CO2)) +
  geom_tile(color="white",size=0.2) +
  scale_fill_manual(values=c("#636363"))+
  coord_flip()  +
  facet_grid(cluster~.,scales="free",space="free") +
  scale_y_continuous(breaks=c(1975,1985,1995,2005,2015)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(size = 11),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(0,0,0,0),units="cm")) +
   ggtitle(str_wrap("Years where rolling average CO2 growth rates < -4%",width=35))

(p1 + p2) / (p3 + plot_spacer()) + plot_layout(heights=c(6,1))

```

```{r write_data,echo=FALSE,warning=FALSE}


openxlsx::addWorksheet(wb,"countries")
openxlsx::writeData(wb, sheet = "countries", table, colNames = T, rowNames = F)

openxlsx::addWorksheet(wb,"clusters")
openxlsx::writeData(wb, sheet = "clusters", cluster_table, colNames = T, rowNames = F)

openxlsx::addWorksheet(wb,"all_data")
openxlsx::writeData(wb, sheet = "all_data", data, colNames = T, rowNames = F)

openxlsx::saveWorkbook(wb,paste0("../../Results/Data/decarbonising_countries.xlsx"),overwrite=T)

```



```{r countries,echo=FALSE,warning=FALSE,fig.width=8,fig.height=6,fig.path="../../Results/Plots/Decarbonising countries/",dev=c('png','pdf'),results="asis"}

# country_handle="United States"
# time_start = 2005
# 
# country_plot <- function(country_handle,edgar_GHG_ar6,rate) {
#   
#   data <- edgar_GHG_ar6 %>%
#     filter(year>1989) %>% 
#     filter(country==country_handle) %>% 
#     group_by(country,year,chapter,chapter_title) %>% 
#     summarise_at(vars(GHG),sum,na.rm=TRUE) %>% 
#     mutate(GHG=GHG/1e7) %>% 
#     ungroup() %>% 
#     mutate(chapter_title=as.factor(chapter_title))
#   
#   sector_rates <- data %>% 
#     filter(year %in% c(time_start,2018)) %>% 
#     group_by(country,chapter,chapter_title) %>% 
#     mutate(rate=((last(GHG)/first(GHG))^(1/(last(year)-first(year)))-1)*100) %>% 
#     filter(year==2018) 
#   
#   sector_rates <- sector_rates %>% 
#     arrange(desc(chapter_title)) %>% 
#     mutate(location=GHG/2) %>% 
#     group_by(country) %>% 
#     mutate(GHG=cumsum(GHG))
#   
#   z = 5
#   for (i in 2:z) {
#     sector_rates$location[i] = sector_rates$location[i] + sector_rates$GHG[i-1]
#   }
#     
#   sector_rates <- sector_rates %>%  
#     select(-year,-GHG)
#   
#   data <- left_join(data,sector_rates, by = c("country", "chapter", "chapter_title"))
#   
#   p1 <- data %>%
#     filter(year>1989) %>% 
#     ggplot(.,aes(x=year,y=GHG,fill=chapter_title)) +
#     geom_area(colour="#737373") +
#     geom_text(data = data %>% filter(year==2018),
#               aes(x=year+1,y=location,colour=chapter_title,label=paste0(chapter_title," [",ifelse(rate>0,"+",""),round(rate,1),"%]")),hjust=0,) +
#     geom_vline(xintercept=c(time_start,2018),alpha=0.3,linetype="dashed") +
#     scale_fill_brewer(palette = "Set2") +
#     scale_colour_brewer(palette = "Set2") +
#     scale_x_continuous(limits = c(1990,2026)) +
#     ylab("GHG Emissions (MtCO2eq)") + 
#     theme(axis.title.x = element_blank(),
#           legend.position = "none") +
#     ggtitle(paste0(country_handle," - ",rate,"% decline since ",time_start))
#   
#   data <- edgar_GHG_ar6 %>% 
#     filter(country==country_handle) %>% 
#     group_by(country,year,chapter_title,subsector,subsector_title) %>% 
#     summarise_at(vars(GHG),sum,na.rm=TRUE) %>% 
#     mutate(GHG=GHG/1e7)
#   
#   subsector_rates <- data %>% 
#     filter(year %in% c(2000,2018)) %>% 
#     group_by(country,subsector,subsector_title) %>% 
#     mutate(rate=((last(GHG)/first(GHG))^(1/(last(year)-first(year)))-1)*100) %>% 
#     filter(year==2018)
#   
#   data <- data %>% 
#     filter(year %in% c(2000,2018)) %>% 
#     group_by(country,subsector_title) %>% 
#     mutate(difference=last(GHG)-first(GHG)) %>% 
#     mutate(rate_sector=((last(GHG)/first(GHG))^(1/(last(year)-first(year)))-1)*100)
#   
#   total_GHG <- data %>% filter(year==2018) %>% group_by(country) %>% summarise(GHG=sum(GHG))
#   
#   data <- data %>% 
#     filter(year==2018) %>% 
#     mutate(filter=(abs(difference)/total_GHG$GHG)*100)
#   
#   p2 <- data %>% 
#     filter(filter>=0.25) %>% 
#     ggplot(.,aes(x=reorder(subsector_title,desc(difference)),y=difference,fill=chapter_title)) +
#     geom_text(aes(x=reorder(subsector_title,desc(difference)),y=difference,label=paste0(ifelse(rate_sector>0,"+",""),round(rate_sector,1),"%"),hjust = ifelse(difference >= 0, -0.1, 1.1)),size=3,colour="#737373") +
#     geom_bar(stat='identity',colour="#737373") +
#     scale_y_continuous(expand = expand_scale(mult = c(0.15, .15))) +
#     scale_fill_manual(values= colours_sectors) +
#     ylab(paste0("GHG Emissions change in major sectors, ",time_start,"-2018 (MtCO2eq)")) +
#     xlab('') +
#     coord_flip() +
#     theme(legend.position="none")
#   
#   p <- ggarrange(p1,p2,nrow=2)
#   
#   return(list("plot"=p,"data"=data))
# }
# 
# 
# for (i in 1:length(rates$country[rates$decline==1])) {
# #for (i in 1:2) {
#  
#   country_handle = rates$country[rates$decline==1][i]
#   rate = round(abs(rates$rate_GHG[rates$decline==1][i]*100),1)
#   
#   p <- country_plot(country_handle,edgar_GHG_ar6,rate)
#   cat("  \n### ",country_handle,"  \n")
#   print(p$plot)
#   cat("  \n")
#   
# }




```
```{r save_data,echo=FALSE,warning=FALSE}

# output <- data %>% 
#   filter(year %in% c(time_start,2017)) %>% 
#   group_by(country) %>% 
#   summarise(rate_POP=(last(pop_UN)/first(pop_UN))^(1/(last(year)-time_start))-1,
#     rate_GDP=(last(gdp_ppp_WB)/first(gdp_ppp_WB))^(1/(last(year)-time_start))-1) %>% 
#   ungroup()
# 
# output <- left_join(data,output,by = "country")
# output <- output %>% 
#   group_by(country) %>% 
#   fill(gdp_ppp_WB)
# 
# output <- output %>% 
#   filter(year==2018) %>% 
#   select(-year,-decline)
# 
# 
# 
# wb <- openxlsx::createWorkbook(title = paste("decarbonising_countries",Sys.Date()))
# openxlsx::addWorksheet(wb,"data")
# openxlsx::writeData(wb, sheet = "data", output, colNames = T, rowNames = F)
# openxlsx::saveWorkbook(wb,paste0("../../Results/Data/decarbonising_countries_",Sys.Date(),".xlsx"),overwrite=T)

```


