---
title: "Covid emissions"
author: "William F. Lamb"
output: 
  word_document:
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../Results") })
  
---

## Setup

```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(openxlsx)
library(ggplot2); theme_set(theme_bw())
library(patchwork)
library(zoo)

load('../../Data/edgar6_v4_data_raw.RData')
Sys.setlocale("LC_ALL","English")

# set palette
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Set2") + scale_fill_brewer(palette="Set2")


wb <- openxlsx::createWorkbook(title = "ipcc_ar6_figure_covid2020")

```


## Long term trend and 2020 estimates

### Daily emissions from GCP

```{r daily_gcp, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}

# daily emissions long term (Global carbon project)

# daily_gcp <- read.xlsx("../../Data/COVID/COVID_data_for_figures_11June2020.xlsx",sheet="Figure 3")
# names(daily_gcp) <- c("year","x","date","med","low","high")
# 
# daily_gcp <- daily_gcp %>% 
#   filter(!is.na(date)) %>% 
#   filter(year!="year") %>% 
#   filter(year>1968) %>% 
#   filter(year<2020) %>% 
#   select(-x,-date) %>% 
#   mutate(med=as.numeric(med)) %>% 
#   mutate(low=as.numeric(low)) %>% 
#   mutate(high=as.numeric(high)) %>% 
#   mutate(dataset="Global Carbon Project") %>% 
#   mutate(year=as.numeric(year))
# 
# p_daily_gcp <- daily_gcp %>%
#   ggplot(.,aes(x=year,y=med)) +
#   geom_path(aes(group=dataset,color=dataset)) +
#   geom_vline(aes(xintercept=1973),linetype = "dashed") +
#   geom_text(data=data.frame(x=1973.5,y=25),aes(x,y,label="1973 Oil\n Crisis"),hjust=0,size=3.5) +
#   geom_vline(aes(xintercept=1991),linetype = "dashed") +
#   geom_text(data=data.frame(x=1991.5,y=25),aes(x,y,label="1991 Soviet Union\n dissolusion"),hjust=0,size=3.5) +
#   geom_vline(aes(xintercept=2008),linetype = "dashed") +
#   geom_text(data=data.frame(x=2008.5,y=25),aes(x,y,label="2008 Global\n financial crisis"),hjust=0,size=3.5) +
#   ylab("Global daily fossil\n CO2 emissions (MtCO2/day)") +
#   scale_y_continuous(limits=c(20,110),breaks=c(20,40,60,80,100)) +
#   scale_x_continuous(limits=c(1970,2019),breaks=c(1970,1980,1990,2000,2010,2019)) +
#   theme(legend.position="none",
#         axis.title.x = element_blank())

```

### Annual emissions from Global Carbon Project and EDGAR

```{r annual_gcp, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}

gcb <- read.csv(file="../../Data/COVID/GCB2021v29_global_MtCO2_data.csv")

data <- gcb %>% 
  filter(Year>1969) %>% 
  select(year=Year,value=Total) %>% 
  mutate(value=value/1000) %>% 
  mutate(dataset="Global Carbon Project") %>% 
  mutate(year=as.numeric(year))

# edgar <- edgar_raw %>%
#   filter(gas=="CO2") %>%
#   group_by(year) %>%
#   summarise(value=sum(value,na.rm=TRUE)/1e9) %>%
#   mutate(dataset="EDGAR")
# 
# data <- rbind(data,edgar)


#### calculate rate of decline for different crises

crises <- data %>% 
  filter(dataset=="Global Carbon Project") %>% 
  filter(year %in% c(1973,1974,1991,1992,2008,2009,2019,2020))

crises <- left_join(crises,data.frame(year=c(1973,1974,1991,1992,2008,2009,2019,2020),
                                      label=c("1973 Oil Crisis","1973 Oil Crisis",
                                              "1991 Soviet Union\ndissolusion",
                                              "1991 Soviet Union\ndissolusion",
                                              "2008 Global\nfinancial crisis",
                                              "2008 Global\nfinancial crisis",
                                              "2020 COVID-19\npandemic",
                                              "2020 COVID-19\npandemic"),
                                      position=c(16,16,22,22,30,30,33,33)))
crises <- crises %>% 
  group_by(label) %>% 
  mutate(change=first(value)-last(value)) %>% 
  mutate(rate=(change/first(value))*100) %>% 
  mutate(rate=round(rate,1))

crises <- crises %>% 
  group_by(label,rate,position) %>% 
  summarise(year=first(year)) %>% 
  mutate(year=ifelse(label=="2020 COVID-19\npandemic",year+1,year))

crises <- crises %>% 
  mutate(label2=paste0(label,"\n","-",rate,"%")) %>% 
  mutate(label2 = ifelse(year==2020,paste0(label,"\n-",rate,"% (GCB)\n-5.1% (EDGAR)\n-6.3% (BP)\n-5.8% (IEA)"),label2))

p_annual_gcb <- data %>% 
  ggplot(.,aes(x=year,y=value)) +
  geom_path(aes(group=dataset,color=dataset)) +
  
  geom_vline(data=crises,aes(xintercept=year),linetype="dashed") +
  
  geom_text(data=crises,aes(x=year+0.5,y=position,label=label2),vjust=1,hjust=0,size=3.5) +
  
  #geom_text(data=crises,aes(x=year+0.65,y=position,label=paste0("-",rate,"%"),hjust=0)) +
 
  
   
  ylab("Carbon emissions (GtCO2/year)") +
  scale_y_continuous(limits=c(10,40)) +
  scale_x_continuous(limits=c(1970,2027),breaks=c(1970,1980,1990,2000,2010,2020))  +
  ggtitle("a. Global carbon emissions and the impact of economic and geopolitical events") +
  theme(legend.position="none",
        axis.title.x = element_blank(),
        plot.title = element_text(size=12))

p_annual_gcb

```

## 2020 estimates

```{r 2020_estimates, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}
# 
# bp <- read.xlsx('../../Data/COVID/bp-stats-review-2021-all-data.xlsx',sheet=5,startRow = 3,cols = c(1:57)) %>% select(country=Million.tonnes.of.carbon.dioxide,everything())
# 
# bp <- gather(bp,year,value,-country) %>% 
#   filter(country=="Total World") %>% 
#   select(-country) %>% 
#   mutate(value=as.numeric(value)) %>% 
#   mutate(value=value/1000) %>% 
#   mutate(dataset="BP")
# 
# 
# data <- rbind(gcb,bp) %>% 
#   mutate(year=as.numeric(year)) %>% 
#   filter(year>=2019)
# 
# data <- data %>% 
#   group_by(dataset) %>% 
#   mutate(change=first(value)-last(value)) %>% 
#   mutate(change_fraction=(change/first(value))*100)
# 
# ### RESCALE TO GCP VALUE
# data <- data %>% 
#   mutate(rescaled=gcb$value[gcb$year==2019]-change)
# 
# 
# data %>%
#   filter(year==2020) %>% 
#   ggplot(.,aes(x=dataset,y=change)) +
#   geom_bar(stat='identity')
#   #geom_text(aes(x=year+0.5,y=change,label=dataset)) +
#   #scale_y_continuous(limits=c(10,40)) +
#   
# p_2020_estimates <- data %>% 
#   filter(year==2020) %>% 
#   ggplot(.,aes(x=year,y=rescaled,color=reorder(dataset,desc(dataset)))) +
#   geom_point() +
#   geom_text(aes(x=year+0.5,y=rescaled,label=dataset),hjust=0) +
#   scale_y_continuous(limits=c(10,40)) +
#   scale_x_continuous(limits=c(2019,2023),breaks=c(2020)) +
#   theme(axis.title.x = element_blank(),
#         axis.title.y = element_blank(),
#         axis.ticks.y = element_blank(),
#         axis.text.y = element_blank(),
#         panel.grid.minor.x = element_blank(),
#         legend.position = "none")
# 
# p_annual_gcb + p_2020_estimates + plot_layout(widths=c(4.5,1))


```



## Daily emissions 2020
### Carbon Monitor

```{r sectors_cm, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}

covid_sectors_cm <- read.csv(file="../../Data/COVID/carbonmonitor-global_datas_2021-08-31.csv")

covid_sectors_cm <- covid_sectors_cm %>% 
  filter(country=="WORLD") %>% 
  mutate(date=as.Date(date, "%d/%m/%Y")) %>% 
  select(country,date,sector,medium=value,timestamp)

## total
covid_sectors_total <- covid_sectors_cm %>% 
  group_by(date,timestamp) %>% 
  summarise(medium=sum(medium,na.rm=TRUE)) %>% 
  mutate(country="WORLD") %>% 
  mutate(sector="Total") 

covid_sectors_cm <- rbind(covid_sectors_cm,covid_sectors_total)

### sum domestic and intl. aviation

covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(sector=ifelse(sector=="Domestic Aviation","Aviation",sector)) %>% 
  mutate(sector=ifelse(sector=="International Aviation","Aviation",sector))

covid_sectors_cm <- covid_sectors_cm %>% 
  group_by(sector,date,timestamp) %>% 
  summarise(medium=sum(medium)) %>% 
  ungroup()

### Match other sectors to Le Quere
covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(sector=ifelse(sector=="Ground Transport","Transport",sector))


## add uncertainty
covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(uncertainty=0.072*medium) %>% 
  mutate(high=medium+uncertainty) %>% 
  mutate(low=medium-uncertainty) %>% 
  select(-uncertainty)

covid_sectors_cm <- gather(covid_sectors_cm,var,value,medium,high,low)

### subtract daily emissions in 2020 from 2019

covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(year=format(date,format="%Y")) %>% 
  mutate(day=format(date,format="%m-%d")) %>% 
  select(-date,-timestamp)

covid_sectors_cm <- spread(covid_sectors_cm,year,value)
covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(change=`2020`-`2019`) %>% 
  filter(!is.na(change)) %>% 
  mutate(date=paste0("2020-",day)) %>% 
  mutate(date=as.Date(date))

## rolling average 7 day (anomaly)
covid_sectors_cm <- covid_sectors_cm %>% 
  group_by(sector,var) %>% 
  mutate(change=change-first(change)) %>% 
  mutate(change_smooth=rollmean(change,k=7,align="center",fill=NA))

## rolling average 7 day (total)
# covid_sectors_cm <- covid_sectors_cm %>% 
#   group_by(sector) %>%  
#   mutate(`2020_smooth`=rollmean(`2020`,k=7,align="center",fill=NA))


covid_sectors_cm <- spread(covid_sectors_cm %>% select(sector,var,date,change_smooth),var,change_smooth)
  

```

### Global Carbon Project

```{r sectors_gcp, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}


## load in new data from Le Quere et al. 2020

sheet_names <- getSheetNames(file = "../../Data/COVID/PublicData_v15_Countries_UNFCCC-accounting-corr.xlsx")

covid_sectors_gcp <- read.xlsx("../../Data/COVID/PublicData_v15_Countries_UNFCCC-accounting-corr.xlsx",sheet="GLOBAL")
covid_sectors_gcp <- covid_sectors_gcp %>% filter(REGION_ID!="None")

covid_sectors_gcp <- gather(covid_sectors_gcp,key,value,TOTAL_CO2_MED:AVI_CO2_HIGH) %>% 
  mutate(value=as.numeric(value))

covid_sectors_gcp <- covid_sectors_gcp %>% 
  mutate(estimate=ifelse(grepl("MED",key),"medium",NA)) %>% 
  mutate(estimate=ifelse(grepl("HIGH",key),"high",estimate)) %>% 
  mutate(estimate=ifelse(grepl("LOW",key),"low",estimate))

covid_sectors_gcp <- covid_sectors_gcp %>% 
  mutate(sector=ifelse(grepl("PWR",key),"Power",NA)) %>% 
  mutate(sector=ifelse(grepl("IND",key),"Industry",sector)) %>% 
  mutate(sector=ifelse(grepl("TRS",key),"Transport",sector)) %>% 
  mutate(sector=ifelse(grepl("PUB",key),"Public sector",sector)) %>% 
  mutate(sector=ifelse(grepl("RES",key),"Residential",sector)) %>% 
  mutate(sector=ifelse(grepl("AVI",key),"Aviation",sector)) %>% 
  mutate(sector=ifelse(grepl("TOTAL",key),"Total",sector)) %>% 
  mutate(date=convertToDate(DATE)) %>% 
  select(-key,-DATE)

covid_sectors_gcp <- spread(covid_sectors_gcp,estimate,value)

# covid_sectors_gcp %>%
#   filter(sector!="Total") %>% 
#   ggplot(.,aes(x=date,y=medium,color=sector)) +
#   geom_line() +
#   geom_ribbon(aes(ymin=low,ymax=high,fill=sector),alpha=0.3) +
#   scale_x_date(breaks= as.Date(c("2020-01-01","2020-04-01","2020-07-01","2020-10-01")),date_labels = "%b") +
#   facet_grid(.~sector) +
#   ylab("Change in global daily fossil\n CO2 emissions (MtCO2/day)") +
#   theme(legend.position="none",
#         axis.title.x = element_blank())


```

### Sector comparison plot

```{r sector_comparison, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}

covid_sectors <- rbind(covid_sectors_gcp %>% 
                         select(sector,date,value=medium,high,low) %>% 
                         mutate(dataset="Global Carbon Project"),
                       covid_sectors_cm %>% 
                         select(sector,date,value=medium,high,low) %>% 
                         mutate(dataset="Carbon Monitor"))

p_covid_sectors <- covid_sectors %>% 
  filter(sector!="Total") %>% 
  filter(sector!="Public sector") %>% 
  ggplot(.,aes(x=date,y=value,color=reorder(dataset,desc(dataset)),fill=reorder(dataset,desc(dataset)))) +
  geom_line() +
  geom_ribbon(aes(ymin=low,ymax=high),alpha=0.3,) +
  scale_x_date(breaks= as.Date(c("2020-01-01","2020-04-01","2020-07-01","2020-10-01")),date_labels = "%b") +
  facet_grid(.~sector) +
  ylab("Change in global daily \n carbon emissions (MtCO2/day)") +
  ggtitle("b. Daily carbon emissions in 2020 versus 2019 and the impact of COVID-19 lockdown measures") +
  theme(legend.position="bottom",
        legend.title=element_blank(),
        axis.title.x = element_blank(),
        plot.title=element_text(size=12),
        panel.grid.minor = element_blank())

p_covid_sectors_total <- covid_sectors %>% 
  filter(sector=="Total") %>% 
  ggplot(.,aes(x=date,y=value,color=reorder(dataset,desc(dataset)),fill=reorder(dataset,desc(dataset)))) +
  geom_line() +
  geom_ribbon(aes(ymin=low,ymax=high),alpha=0.3,) +
  scale_x_date(breaks= as.Date(c("2020-01-01","2020-04-01","2020-07-01","2020-10-01")),date_labels = "%b") +
  facet_grid(.~sector) +
  theme(legend.position="none",
        legend.title=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.background = element_blank(),
        panel.grid.minor = element_blank())

p_covid_sectors <- (p_covid_sectors + p_covid_sectors_total + plot_layout(widths=c(5,1)))
p_covid_sectors
```


```{r covid_emissions, echo=FALSE,warning=FALSE,dpi=300,fig.width=8,fig.height=5,fig.path="../../Results/Plots/",dev=c('png','pdf')}

p <- p_annual_gcb / p_covid_sectors + plot_layout(heights=c(0.6,0.4))
p


openxlsx::addWorksheet(wb,"panel a")
openxlsx::addWorksheet(wb,"panel a reduction rates")
openxlsx::addWorksheet(wb,"panel b")

openxlsx::writeData(wb,"panel a",gcb, colNames = T, rowNames = F)
openxlsx::writeData(wb,"panel a reduction rates",crises, colNames = T, rowNames = F)
openxlsx::writeData(wb,"panel b",covid_sectors, colNames = T, rowNames = F)


openxlsx::saveWorkbook(wb,paste0("../../Results/Plot data/ipcc_ar6_figure_covid2020",".xlsx"),overwrite=T)



```


