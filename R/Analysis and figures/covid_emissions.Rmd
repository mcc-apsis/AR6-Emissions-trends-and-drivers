---
title: "Covid emissions"
author: "William F. Lamb"
output: 
  word_document:
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../Results") })
  
---

```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(openxlsx)
library(ggplot2); theme_set(theme_bw())
library(patchwork)
library(zoo)


Sys.setlocale("LC_ALL","English")

# set palette
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Set2") + scale_fill_brewer(palette="Set2")


wb <- openxlsx::createWorkbook(title = "ipcc_ar6_figure_covid2020")

```


## Long term trend

```{r long_trend, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}


long_trend <- read.xlsx("../../Data/COVID/COVID_data_for_figures_11June2020.xlsx",sheet="Figure 3")
names(long_trend) <- c("year","x","date","med","low","high")

long_trend <- long_trend %>% 
  filter(!is.na(date)) %>% 
  filter(year!="year") %>% 
  filter(year>1968) %>% 
  filter(year<2020) %>% 
  select(-x,-date) %>% 
  mutate(med=as.numeric(med)) %>% 
  mutate(low=as.numeric(low)) %>% 
  mutate(high=as.numeric(high)) %>% 
  mutate(dataset="Global Carbon Project") %>% 
  mutate(year=as.numeric(year))

p_long_trend <- long_trend %>%
  ggplot(.,aes(x=year,y=med)) +
  geom_path(aes(group=dataset,color=dataset)) +
  geom_vline(aes(xintercept=1973),linetype = "dashed") +
  geom_text(data=data.frame(x=1973.5,y=25),aes(x,y,label="1973 Oil\n Crisis"),hjust=0,size=3.5) +
  geom_vline(aes(xintercept=1991),linetype = "dashed") +
  geom_text(data=data.frame(x=1991.5,y=25),aes(x,y,label="1991 Soviet Union\n dissolusion"),hjust=0,size=3.5) +
  geom_vline(aes(xintercept=2008),linetype = "dashed") +
  geom_text(data=data.frame(x=2008.5,y=25),aes(x,y,label="2008 Global\n financial crisis"),hjust=0,size=3.5) +
  ylab("Global daily fossil\n CO2 emissions (MtCO2/day)") +
  scale_y_continuous(limits=c(20,110),breaks=c(20,40,60,80,100)) +
  scale_x_continuous(limits=c(1970,2019),breaks=c(1970,1980,1990,2000,2010,2019)) +
  theme(legend.position="none",
        axis.title.x = element_blank())
p_long_trend

```

## Sectors (Carbon Monitor)

```{r sectors_cm, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}

covid_sectors_cm <- read.csv(file="../../Data/COVID/carbonmonitor-global_datas_2021-08-31.csv")

covid_sectors_cm <- covid_sectors_cm %>% 
  filter(country=="WORLD") %>% 
  mutate(date=as.Date(date, "%d/%m/%Y"))

## total
covid_sectors_total <- covid_sectors_cm %>% 
  group_by(date,timestamp) %>% 
  summarise(value=sum(value,na.rm=TRUE)) %>% 
  mutate(country="WORLD") %>% 
  mutate(sector="Total") 

covid_sectors_cm <- rbind(covid_sectors_cm,covid_sectors_total)


### sum domestic and intl. aviation

covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(sector=ifelse(sector=="Domestic Aviation","Aviation",sector)) %>% 
  mutate(sector=ifelse(sector=="International Aviation","Aviation",sector))

covid_sectors_cm <- covid_sectors_cm %>% 
  group_by(sector,date,timestamp) %>% 
  summarise(value=sum(value)) %>% 
  ungroup()

### Match other sectors to Le Quere
covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(sector=ifelse(sector=="Ground Transport","Transport",sector))

### subtract daily emissions in 2020 from 2019

covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(year=format(date,format="%Y")) %>% 
  mutate(day=format(date,format="%m-%d")) %>% 
  select(-date,-timestamp)

covid_sectors_cm <- spread(covid_sectors_cm,year,value)
covid_sectors_cm <- covid_sectors_cm %>% 
  mutate(change=`2020`-`2019`) %>% 
  filter(!is.na(change)) %>% 
  mutate(date=paste0("2020-",day)) %>% 
  mutate(date=as.Date(date))

## rolling average 7 day (anomaly)
covid_sectors_cm <- covid_sectors_cm %>% 
  group_by(sector) %>% 
  mutate(change=change-first(change)) %>% 
  mutate(change_smooth=rollmean(change,k=7,align="left",fill=NA))

## rolling average 7 day (total)
covid_sectors_cm <- covid_sectors_cm %>% 
  group_by(sector) %>%  
  mutate(`2020_smooth`=rollmean(`2020`,k=7,align="left",fill=NA))


# covid_sectors_cm %>% 
#   ggplot(.,aes(x=date,y=change_smooth,color=sector,group=sector)) +
#   geom_line() +
#   facet_grid(.~sector) +
#   scale_x_date(breaks= as.Date(c("2020-01-01","2020-04-01","2020-07-01","2020-10-01")),date_labels = "%b") +
#   theme(legend.position="none",
#         axis.title.x = element_blank())
  

```

## Sectors (Global Carbon Project)

```{r sectors_gcp, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}


## load in new data from Le Quere et al. 2020

sheet_names <- getSheetNames(file = "../../Data/COVID/PublicData_v15_Countries_UNFCCC-accounting.xlsx")

covid_sectors_gcp <- read.xlsx("../../Data/COVID/PublicData_v15_Countries_UNFCCC-accounting.xlsx",sheet="GLOBAL")
covid_sectors_gcp <- covid_sectors_gcp %>% filter(REGION_ID!="None")

covid_sectors_gcp <- gather(covid_sectors_gcp,key,value,TOTAL_CO2_MED:AVI_CO2_HIGH) %>% 
  mutate(value=as.numeric(value))

covid_sectors_gcp <- covid_sectors_gcp %>% 
  mutate(estimate=ifelse(grepl("MED",key),"medium",NA)) %>% 
  mutate(estimate=ifelse(grepl("HIGH",key),"high",estimate)) %>% 
  mutate(estimate=ifelse(grepl("LOW",key),"low",estimate))

covid_sectors_gcp <- covid_sectors_gcp %>% 
  mutate(sector=ifelse(grepl("PWR",key),"Power",NA)) %>% 
  mutate(sector=ifelse(grepl("IND",key),"Industry",sector)) %>% 
  mutate(sector=ifelse(grepl("TRS",key),"Transport",sector)) %>% 
  mutate(sector=ifelse(grepl("PUB",key),"Public sector",sector)) %>% 
  mutate(sector=ifelse(grepl("RES",key),"Residential",sector)) %>% 
  mutate(sector=ifelse(grepl("AVI",key),"Aviation",sector)) %>% 
  mutate(sector=ifelse(grepl("TOTAL",key),"Total",sector)) %>% 
  mutate(date=convertToDate(DATE)) %>% 
  select(-key,-DATE)

covid_sectors_gcp <- spread(covid_sectors_gcp,estimate,value)

# covid_sectors_gcp %>%
#   filter(sector!="Total") %>% 
#   ggplot(.,aes(x=date,y=medium,color=sector)) +
#   geom_line() +
#   geom_ribbon(aes(ymin=low,ymax=high,fill=sector),alpha=0.3) +
#   scale_x_date(breaks= as.Date(c("2020-01-01","2020-04-01","2020-07-01","2020-10-01")),date_labels = "%b") +
#   facet_grid(.~sector) +
#   ylab("Change in global daily fossil\n CO2 emissions (MtCO2/day)") +
#   theme(legend.position="none",
#         axis.title.x = element_blank())


```

## Sector comparison

```{r sector_comparison, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}

covid_sectors <- rbind(covid_sectors_gcp %>% 
                         select(sector,date,value=medium,high,low) %>% 
                         mutate(dataset="Global Carbon Project"),
                       covid_sectors_cm %>% 
                         select(sector,date,value=change_smooth) %>% 
                         mutate(dataset="Carbon Monitor") %>% 
                         mutate(high=NA) %>% 
                         mutate(low=NA))

p_covid_sectors <- covid_sectors %>% 
  filter(sector!="Total") %>% 
  ggplot(.,aes(x=date,y=value,color=reorder(dataset,desc(dataset)),fill=reorder(dataset,desc(dataset)))) +
  geom_line() +
  geom_ribbon(aes(ymin=low,ymax=high),alpha=0.3,) +
  scale_x_date(breaks= as.Date(c("2020-01-01","2020-04-01","2020-07-01","2020-10-01")),date_labels = "%b") +
  facet_grid(.~sector) +
  ylab("Change in global daily fossil\n CO2 emissions (MtCO2/day)") +
  theme(legend.position="bottom",
        legend.title=element_blank(),
        axis.title.x = element_blank())
p_covid_sectors

```



## Totals


```{r totals, echo=FALSE,warning=FALSE,fig.width=8,fig.height=3}

year_mean <- read.xlsx("../../Data/COVID/PublicData_v15_Countries_UNFCCC-accounting.xlsx",sheet="mean") %>% 
  filter(REGION_NAME=="Global")
year_mean <- as.numeric(year_mean$TOTAL_CO2)


covid_totals <- covid_sectors_gcp %>% 
  filter(sector=="Total") %>% 
  mutate(high=high+year_mean) %>% 
  mutate(value=medium+year_mean) %>% 
  mutate(low=low+year_mean) %>% 
  select(sector,date,high,value,low) %>% 
  mutate(dataset="Global Carbon Project")

covid_totals <- rbind(covid_totals,covid_sectors_cm %>% 
                        filter(sector=="Total") %>% 
                        select(sector,date,value=`2020_smooth`) %>% 
                        mutate(high=NA) %>% 
                        mutate(low=NA) %>% 
                        mutate(dataset="Carbon Monitor"))

p_covid_totals <- covid_totals %>% 
  ggplot(.,aes(x=date,y=value,color=reorder(dataset,desc(dataset)),fill=reorder(dataset,desc(dataset)))) +
  geom_line() +
  geom_ribbon(aes(ymin=low,ymax=high),alpha=0.3) +
  scale_y_continuous(limits=c(20,110),breaks=c(20,40,60,80,100)) +
  scale_x_date(breaks= as.Date(c("2020-01-01","2020-04-01","2020-07-01","2020-10-01","2020-12-31")),date_labels = "%b") +
  geom_text(data=data.frame(x=as.Date("2020-01-01"),y=25),inherit.aes=FALSE,aes(x,y,label="2020 COVID-19\nPandemic"),hjust=0,size=3.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none")
p_covid_totals

```

```{r covid_emissions, echo=FALSE,warning=FALSE,fig.width=8,fig.height=5,fig.path="../../Results/Plots/",dev=c('png','pdf')}

(p_long_trend + p_covid_totals + plot_layout(widths=c(0.8,0.2))) / p_covid_sectors + plot_layout(heights=c(0.6,0.4))


```