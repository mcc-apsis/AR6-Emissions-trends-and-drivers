---
title: "build_summary_sheets"
output: word_document
---

```{r setup, include=FALSE}

## This is for summarising the current version of our data including:
## - Global totals by gas
## - Sector totals by gas
## - Regional totals by sector

## It also generates a summary sheet with the IPCC sectors, regions, and GWPs

## This script should be run after compiling the data (import_edgar6_data.R)

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(openxlsx)
library(patchwork)
library(zoo)

knitr::opts_chunk$set(echo = FALSE,warning=FALSE)
options(dplyr.summarise.inform = FALSE)

load('../../Data/edgar6_data_raw.RData')
load('../../Data/edgar6_data_ghg_gwp_ar5.RData')
edgar_ghg_ar5 <- edgar_ghg
load('../../Data/edgar6_data_ghg_gwp_ar6.RData')
edgar_ghg_ar6 <- edgar_ghg
load('../../Data/land.RData')


```

```{r gas_sheets}

wb <- openxlsx::createWorkbook(title = "ipcc_ar6_edgar_summary")
addWorksheet(wb,"info")
info = data.frame(x=c("Author","Units","Last update","Code"),
                  y=c("William F. Lamb",
                      "Gt of gas (or GtCO2eq in GWP tabs)",
                      as.character(Sys.Date()),
                      "https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers/blob/master/R/Data%20preparation/build_summary_sheets.Rmd"))
writeData(wb, sheet = "info",info, colNames = F, rowNames = F)


gases <- edgar_raw %>% 
  group_by(year,gas,gwp100_ar6,gwp100_ar5) %>% 
  summarise(value=sum(value,na.rm=TRUE)/1e9) %>% 
  ungroup()

gases_land <- land %>% 
  filter(year>1969) %>% 
  group_by(year) %>% 
  summarise(value=sum(mean,na.rm=TRUE)/1e9) %>% 
  mutate(gas="CO2 (Land-use)") %>% 
  mutate(gwp100_ar6=1) %>% 
  mutate(gwp100_ar5=1) %>% 
  ungroup()

gases <- rbind(gases,gases_land)
gases$gas <- fct_relevel(gases$gas,c("CO2","CO2 (Land-use)","CH4","N2O"))
gases <- spread(gases,year,value)

gases_gwps_ar5 <- gather(gases,year,value,`1970`:`2019`) 
gases_gwps_ar5 <- gases_gwps_ar5 %>% 
  mutate(value=value*gwp100_ar5)
gases_gwps_ar5 <- spread(gases_gwps_ar5,year,value) 


gases_gwps_ar6 <- gather(gases,year,value,`1970`:`2019`) 
gases_gwps_ar6 <- gases_gwps_ar6 %>% 
  mutate(value=value*gwp100_ar6)
gases_gwps_ar6 <- spread(gases_gwps_ar6,year,value) 



addWorksheet(wb,"gases")
addWorksheet(wb,"gases_gwp_ar5")
addWorksheet(wb,"gases_gwp_ar6")

writeData(wb, sheet = "gases", gases, colNames = T)
writeData(wb, sheet = "gases_gwp_ar5", gases_gwps_ar5 %>% select(-gwp100_ar6), colNames = T)
writeData(wb, sheet = "gases_gwp_ar6", gases_gwps_ar6 %>% select(-gwp100_ar5), colNames = T)


```

```{r sector_sheets}

sectors <- edgar_raw %>% 
  filter(year==2018) %>% 
  group_by(sector_code,fossil_bio,description,chapter_title,subsector_title,gas) %>% 
  summarise(value=sum(value,na.rm=TRUE)/1e9) %>% 
  ungroup()

sectors <- spread(sectors,gas,value)


sector_gwps_ar5 <- edgar_ghg_ar5 %>% 
  filter(year==2018) %>% 
  group_by(sector_code,fossil_bio,description,chapter_title,subsector_title) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas),sum,na.rm=TRUE) %>%
  ungroup()

sector_gwps_ar5 <- gather(sector_gwps_ar5,gas,value,CO2:Fgas) %>% 
  mutate(value=value/1e9)
sector_gwps_ar5$gas <- as.factor(sector_gwps_ar5$gas)
sector_gwps_ar5$gas <- fct_relevel(sector_gwps_ar5$gas,"CO2","CH4","N2O")
sector_gwps_ar5 <- spread(sector_gwps_ar5,gas,value)


sector_gwps_ar6 <- edgar_ghg_ar6 %>% 
  filter(year==2018) %>% 
  group_by(sector_code,fossil_bio,description,chapter_title,subsector_title) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas),sum,na.rm=TRUE) %>%
  ungroup()

sector_gwps_ar6 <- gather(sector_gwps_ar6,gas,value,CO2:Fgas) %>% 
  mutate(value=value/1e9)
sector_gwps_ar6$gas <- as.factor(sector_gwps_ar6$gas)
sector_gwps_ar6$gas <- fct_relevel(sector_gwps_ar6$gas,"CO2","CH4","N2O")
sector_gwps_ar6 <- spread(sector_gwps_ar6,gas,value)


addWorksheet(wb,"sectors_2018")
addWorksheet(wb,"sectors_2018_gwp_ar5")
addWorksheet(wb,"sectors_2018_gwp_ar6")


writeData(wb, sheet = "sectors_2018", sectors, colNames = T)
writeData(wb, sheet = "sectors_2018_gwp_ar5", sector_gwps_ar5, colNames = T)
writeData(wb, sheet = "sectors_2018_gwp_ar6", sector_gwps_ar6, colNames = T)


```

```{r region_sheets}

regions_ar5 <- edgar_ghg_ar5 %>% 
  filter(year==2018) %>% 
  group_by(region_ar6_6,chapter_title) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas),sum,na.rm=TRUE) %>%
  ungroup()

regions_ar5 <- gather(regions_ar5,gas,value,CO2:Fgas) %>% 
  mutate(value=value/1e9)
regions_ar5$gas <- as.factor(regions_ar5$gas)
regions_ar5$gas <- fct_relevel(regions_ar5$gas,"CO2","CH4","N2O")
regions_ar5 <- spread(regions_ar5,gas,value)


regions_ar6 <- edgar_ghg_ar6 %>% 
  filter(year==2018) %>% 
  group_by(region_ar6_6,chapter_title) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas),sum,na.rm=TRUE) %>%
  ungroup()

regions_ar6 <- gather(regions_ar6,gas,value,CO2:Fgas) %>% 
  mutate(value=value/1e9)
regions_ar6$gas <- as.factor(regions_ar6$gas)
regions_ar6$gas <- fct_relevel(regions_ar6$gas,"CO2","CH4","N2O")
regions_ar6 <- spread(regions_ar6,gas,value)



addWorksheet(wb,"regions_2018_gwp_ar5")
addWorksheet(wb,"regions_2018_gwp_ar6")

writeData(wb, sheet = "regions_2018_gwp_ar5", regions_ar5, colNames = T)
writeData(wb, sheet = "regions_2018_gwp_ar6", regions_ar6, colNames = T)

```

```{r classifications}

wb2 <- openxlsx::createWorkbook(title = "ipcc_ar6_data_metadata")

load('../../Data/ipcc_regions.RData')
load('../../Data/ipcc_sectors.RData')
load('../../Data/gwps.RData')

info = data.frame(x=c("Author","Last update","Code"),
                  y=c("William F. Lamb",
                      as.character(Sys.Date()),
                      "https://github.com/mcc-apsis/AR6-Emissions-trends-and-drivers/blob/master/R/Data%20preparation/build_summary_sheets.Rmd"))


addWorksheet(wb2,"info")
addWorksheet(wb2,"ipcc_sectors")
addWorksheet(wb2,"ipcc_regions")
addWorksheet(wb2,"ipcc_gwps")
addWorksheet(wb2,"ipcc_gwps_ch4")

writeData(wb2, sheet = "info",info, colNames = F, rowNames = F)
writeData(wb2, sheet = "ipcc_sectors", ipcc_sectors, colNames = T)
writeData(wb2, sheet = "ipcc_regions", ipcc_regions, colNames = T)
writeData(wb2, sheet = "ipcc_gwps", gwps, colNames = T)
writeData(wb2, sheet = "ipcc_gwps_ch4", gwps_ch4, colNames = T)



```

```{r sectors_gases}

# summary of sectors and their gases

sectors_gases <- edgar_raw %>% 
  group_by(chapter_title,subsector_title,sector_code,fossil_bio,gas) %>% 
  summarise(value=sum(value,na.rm=TRUE))

sectors_gases <- sectors_gases %>% 
  ungroup() %>% 
  mutate(sector_code = paste0(sector_code," (",fossil_bio,")")) %>% 
  select(-fossil_bio)

sectors_gases <- sectors_gases %>% 
  mutate(gas=as.character(gas)) %>% 
  mutate(gas=ifelse(value==0,NA,gas)) %>% 
  filter(!is.na(gas)) %>% 
  select(-value)

only_gases <- sectors_gases %>% 
  ungroup() %>% 
  select(-sector_code) %>% 
  distinct() %>% 
  group_by(chapter_title,subsector_title) %>% 
  summarise(gases=paste0(gas,collapse=", "))

only_sectors <- sectors_gases %>% 
  ungroup() %>% 
  select(-gas) %>% 
  distinct() %>% 
  group_by(chapter_title,subsector_title) %>% 
  summarise(sector_code=paste0(sector_code,collapse=", "))

sectors_gases <- left_join(only_sectors,only_gases,by = c("chapter_title", "subsector_title"))


addWorksheet(wb2,"sectors_gases")
writeData(wb2, sheet = "sectors_gases",sectors_gases, colNames = T, rowNames = F)

```


```{r save}

saveWorkbook(wb,"../../Results/Data/ipcc_ar6_data_summary.xlsx",overwrite = T)
saveWorkbook(wb2,"../../Results/Data/ipcc_ar6_data_metadata.xlsx",overwrite = T)


```

