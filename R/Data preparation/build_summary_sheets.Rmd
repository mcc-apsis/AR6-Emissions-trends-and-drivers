---
title: "build_summary_sheets"
output: word_document
---

```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(openxlsx)
library(patchwork)
library(zoo)

knitr::opts_chunk$set(echo = FALSE,warning=FALSE)
options(dplyr.summarise.inform = FALSE)


load('../../Data/edgar6_data_raw.RData')
load('../../Data/edgar6_data_ghg_gwp_ar5.RData')
load('../../Data/land.RData')

#edgar6_ghg <- edgar_ghg
# load('../../Data/edgar5_data_ghg_gwp_ar5.RData')
# edgar5_ghg <- edgar_ghg
```

```{r blarg,fig.height=6,fig.width=8}
# 
# 
# us <- edgar6_ghg %>% 
#   filter(ISO=="USA") %>% 
#   filter(sector_code %in% c("1B2b1","1B2b3","1B2b4","1B2b5","1B2c")) %>% 
#   mutate(version="edgar6") %>% 
#   select(year,GHG,sector_code,version)
# 
# us2 <- edgar5_ghg %>% 
#   filter(ISO=="USA") %>% 
#   filter(sector_code %in% c("1B2b1","1B2b3","1B2b4","1B2b5","1B2c")) %>% 
#   mutate(version="edgar5") %>% 
#   select(year,GHG,sector_code,version)
# 
# us <- rbind(us,us2)
# 
# 
# us %>% ggplot(.,aes(x=year,y=GHG,color=version)) +
#   geom_path() +
#   facet_grid(sector_code~.,scales="free") +
#   theme(legend.position="bottom")

```


```{r gas_sheets}

wb <- openxlsx::createWorkbook(title = "ipcc_ar6_edgar_summary")

gases <- edgar_raw %>% 
  group_by(year,gas,gwp100_ar6,gwp100_ar5) %>% 
  summarise(value=sum(value,na.rm=TRUE)) %>% 
  ungroup()

gases_land <- land %>% 
  filter(year>1969) %>% 
  group_by(year) %>% 
  summarise(value=sum(mean,na.rm=TRUE)) %>% 
  mutate(gas="CO2 (Land-use)") %>% 
  mutate(gwp100_ar6=1) %>% 
  mutate(gwp100_ar5=1) %>% 
  ungroup()

gases <- rbind(gases,gases_land)
gases$gas <- fct_relevel(gases$gas,c("CO2","CO2 (Land-use)","CH4","N2O"))
gases <- spread(gases,year,value)

gases_gwps <- gather(gases,year,value,`1970`:`2019`) 
gases_gwps <- gases_gwps %>% 
  mutate(value=value*gwp100_ar5)

gases_gwps <- spread(gases_gwps,year,value) 


addWorksheet(wb,"gases")
writeData(wb, sheet = "gases", gases, colNames = T)
addWorksheet(wb,"gases_gwp_ar5")
writeData(wb, sheet = "gases_gwp_ar5", gases_gwps %>% select(-gwp100_ar6), colNames = T)


```

```{r sector_sheets}

sectors <- edgar_raw %>% 
  filter(year==2018) %>% 
  group_by(sector_code,fossil_bio,description,chapter_title,subsector_title,gas) %>% 
  summarise(value=sum(value,na.rm=TRUE)) %>% 
  ungroup()

sectors <- spread(sectors,gas,value)


sector_gwps <- edgar_ghg %>% 
  filter(year==2018) %>% 
  group_by(sector_code,fossil_bio,description,chapter_title,subsector_title) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas),sum,na.rm=TRUE) %>%
  ungroup()

sector_gwps <- gather(sector_gwps,gas,value,CO2:Fgas) %>% 
  mutate(value=value/1e9)
sector_gwps$gas <- as.factor(sector_gwps$gas)
sector_gwps$gas <- fct_relevel(sector_gwps$gas,"CO2","CH4","N2O")
sector_gwps <- spread(sector_gwps,gas,value)

addWorksheet(wb,"sectors_2018")
writeData(wb, sheet = "sectors_2018", sectors, colNames = T)
addWorksheet(wb,"sectors_2018_gwp_ar5")
writeData(wb, sheet = "sectors_2018_gwp_ar5", sector_gwps, colNames = T)


saveWorkbook(wb,"../../Results/Data/Data summaries/ipcc_ar6_edgar_v6_summary.xlsx",overwrite = T)


```

```{r region_sheets}

regions <- edgar_ghg %>% 
  filter(year==2018) %>% 
  group_by(region_ar6_5,chapter_title) %>% 
  summarise_at(vars(CO2,CH4,N2O,Fgas),sum,na.rm=TRUE) %>%
  ungroup()

regions <- gather(regions,gas,value,CO2:Fgas) %>% 
  mutate(value=value/1e9)
regions$gas <- as.factor(regions$gas)
regions$gas <- fct_relevel(regions$gas,"CO2","CH4","N2O")
regions <- spread(regions,gas,value)


addWorksheet(wb,"regions_2018_gwp_ar5")
writeData(wb, sheet = "regions_2018_gwp_ar5", regions, colNames = T)

```


```{r save}

saveWorkbook(wb,"../../Results/Data/Data summaries/ipcc_ar6_edgar_v6_summary.xlsx",overwrite = T)


```

