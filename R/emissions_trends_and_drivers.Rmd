---
title: "Emissions trends and drivers: overview"
author: "William F. Lamb"
output: 
  word_document:
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Results") })
  
---

```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)
load('../Data/edgar.RData')

source("small_figures.R")

sectors = data.frame(key=c(6,7,9,10,11),value=c("Energy systems","AFOLU","Buildings","Transport","Industry"))

addLevel <- function(x, newlevel=NULL) {
  if(is.factor(x)) {
    if (is.na(match(newlevel, levels(x))))
      return(factor(x, levels=c(levels(x), newlevel)))
  }
  return(x)
}

```


### Total GHGs, split by sector

```{r ghgs_5sectors, echo=FALSE,warning=FALSE,fig.width=8,fig.path="Results/Plots/",dev=c('png','pdf')}

load('../Data/edgar.RData')

plot_data <- edgar_GHG %>% 
  filter(!is.na(chapter)) %>% 
  group_by(Year,chapter) %>% 
  summarise(total_ghg=sum(GHG,rm.na=T)/1e6) %>% 
  ungroup()

plot_data <- left_join(plot_data,sectors,by=c("chapter"="key")) %>% 
  select(Year,chapter,chapter_title=value,total_ghg)

# plot_data <- plot_data %>% 
#   mutate(IPCC_AR5_chapter=ifelse(IPCC_AR5_chapter==7,"Energy",IPCC_AR5_chapter)) %>% 
#   mutate(IPCC_AR5_chapter=ifelse(IPCC_AR5_chapter==8,"Transport",IPCC_AR5_chapter)) %>% 
#   mutate(IPCC_AR5_chapter=ifelse(IPCC_AR5_chapter==9,"Buildings",IPCC_AR5_chapter)) %>% 
#   mutate(IPCC_AR5_chapter=ifelse(IPCC_AR5_chapter==10,"Industry",IPCC_AR5_chapter)) %>% 
#   mutate(IPCC_AR5_chapter=ifelse(IPCC_AR5_chapter==11,"Agriculture",IPCC_AR5_chapter)) %>% 
#   #### add NA's to industry ####
#   mutate(IPCC_AR5_chapter = ifelse(is.na(IPCC_AR5_chapter),"Industry",IPCC_AR5_chapter)) %>% 
#   group_by(Year,IPCC_AR5_chapter) %>% 
#   summarise(total_ghg=sum(total_ghg)) %>% 
#   ungroup()

  
data <- xlsx::read.xlsx('../Data/data from Jan.xlsx',sheetIndex = "EDGAR gas - Figure 1",startRow = 10,endRow = 16,check.names=FALSE)

data <- gather(data,Year,value,-source,-gas) %>% 
  mutate(Year=as.numeric(Year)) %>% 
  filter(!is.na(value)) %>%
  filter(gas=="CO2 landuse") %>% 
  mutate(chapter=7,chapter_title="AFOLU") %>% 
  select(Year,chapter,chapter_title,total_ghg=value) 


plot_data <- rbind(plot_data,data)
#plot_data$IPCC_AR5_chapter <- as.factor(plot_data$IPCC_AR5_chapter)
#plot_data$IPCC_AR5_chapter <- factor(plot_data$IPCC_AR5_chapter,levels(plot_data$IPCC_AR5_chapter)[c(4,7,2,5,1,3,6)])


### merge agriculture and FOLU
plot_data <- plot_data %>% 
  group_by(Year,chapter,chapter_title) %>% 
  summarise(total_ghg=sum(total_ghg)) %>% 
  ungroup()

 plot_data$chapter_title <- factor(plot_data$chapter_title,levels(plot_data$chapter_title)[c(3,5,2,4,1)])

shares <- plot_data %>% 
  filter(Year %in% c(1970,1980,1990,2000,2010,2017)) %>% 
  group_by(Year) %>% 
  mutate(totals=sum(total_ghg)) %>% 
  ungroup() %>% 
  group_by(Year,chapter) %>% 
  mutate(fractions=(total_ghg/totals)*100) %>% 
  ungroup()

shares <- shares %>%
  arrange(Year,chapter_title)

for (i in seq(1,30,5)) {
  
  shares$location[i] = (shares$total_ghg[i]/2) + shares$total_ghg[i+1] + shares$total_ghg[i+2] + shares$total_ghg[i+3] + shares$total_ghg[i+4]
  shares$location[i+1] = (shares$total_ghg[i+1]/2) + shares$total_ghg[i+2] + shares$total_ghg[i+3] + shares$total_ghg[i+4]
  shares$location[i+2] = (shares$total_ghg[i+2]/2) + shares$total_ghg[i+3] + shares$total_ghg[i+4]
  shares$location[i+3] = (shares$total_ghg[i+3]/2) + shares$total_ghg[i+4]
  shares$location[i+4] = (shares$total_ghg[i+4]/2)
  
}



plot_data %>%
  #filter(IPCC_AR5_chapter!="NA") %>% 
  #filter(IPCC_AR5_chapter!="Agriculture") %>% 
  ggplot(.,aes(x=Year,y=total_ghg,fill=chapter_title)) +
  geom_area() +
  geom_text(data=shares,aes(x=Year,y=location,label=paste(round(fractions,0),"%",sep="")))+
  geom_vline(xintercept=c(1970,1980,1990,2000,2010,2017),alpha=0.3,linetype="dashed") +
  ylab("GHG emissions (GtCO2eq/yr)") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
          legend.position = c(0.12,0.8),
        legend.title=element_blank(),
        legend.background = element_blank())


plot_data <- spread(plot_data,Year,total_ghg)
sum(plot_data$`2017`)

xlsx::write.xlsx(as.data.frame(plot_data),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "Total_GHGs_Sector",append=TRUE,row.names=FALSE)


```


### GHG emissions by gas (Figure 1)

```{r Fig1_trend, echo=FALSE,warning=FALSE,fig.width=8,fig.path="Results/Plots/",dev=c('png','pdf')}

######### load Jan data ######### 


plot_data <- edgar_GHG %>% 
  group_by(Year) %>% 
  summarise(CO2=sum(CO2,na.rm=T)/1e6,CH4=sum(CH4,na.rm=T)/1e6,N2O=sum(N2O,na.rm=T)/1e6,Fgas=sum(Fgas,na.rm=T)/1e6)

data <- xlsx::read.xlsx('../Data/data from Jan.xlsx',sheetIndex = "EDGAR gas - Figure 1",startRow = 10,endRow = 16,check.names=FALSE)

data <- gather(data,Year,value,-source,-gas) %>% 
  mutate(Year=as.numeric(Year)) %>% 
  filter(!is.na(value)) %>%
  filter(gas=="CO2 landuse") %>% 
  select(Year,CO2_Landuse=value) 

plot_data <- left_join(plot_data,data,by=c("Year"="Year"))

plot_data<- gather(plot_data,gas,value,-Year) 
plot_data <- plot_data %>% 
  mutate(gas=ifelse(gas=="CO2","CO2 FFI",gas)) %>% 
  mutate(gas=ifelse(gas=="CO2_Landuse","CO2 FOLU",gas))
plot_data$gas <- as.factor(plot_data$gas)
plot_data$gas <- factor(plot_data$gas,levels(plot_data$gas)[c(3,2,1,5,4)])

shares <- plot_data %>% 
  filter(Year %in% c(1970,1980,1990,2000,2010,2017)) %>% 
  group_by(Year) %>% 
  mutate(totals=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year,gas) %>% 
  mutate(fractions=(value/totals)*100)


shares <- shares %>%
  arrange(Year,gas)

for (i in seq(1,30,5)) {
  
  shares$location[i] = (shares$value[i]/2) + shares$value[i+1] + shares$value[i+2] + shares$value[i+3] + shares$value[i+4]
  shares$location[i+1] = (shares$value[i+1]/2) + shares$value[i+2] + shares$value[i+3] + shares$value[i+4]
  shares$location[i+2] = (shares$value[i+2]/2) + shares$value[i+3] + shares$value[i+4]
  shares$location[i+3] = (shares$value[i+3]/2) + shares$value[i+4]
  shares$location[i+4] = (shares$value[i+4]/2)
}



plot_data %>% 
  ggplot(.,aes(x=Year,y=value,fill=gas)) +
  geom_area() +
  geom_text(data=shares,aes(x=Year,y=location,label=paste(round(fractions,0),"%",sep="")))+
  geom_vline(xintercept=c(1970,1980,1990,2000,2010,2017),alpha=0.3,linetype="dashed") +
  ylab('GHG Emissions (GtCO2eq/yr)') +
  theme_bw() +
  theme(axis.title.x = element_blank(),
          legend.position = c(0.12,0.8),
        legend.title=element_blank(),
        legend.background = element_blank()) 


plot_data %>%
  ggplot(.,aes(x=Year,y=value,color=gas)) +
  geom_line() +
  theme_bw() +
  ylab('GHG Emissions (GtCO2eq/yr)') +
  facet_wrap(.~gas,scales='free') +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin=margin(0,10,0,0)))
  

blarg <- plot_data %>% 
  group_by(gas) %>% 
  summarise(value=sum(value))


blarg$gas <- addLevel(blarg$gas,"Total")
blarg <- rbind(blarg,c(gas="Total",value=sum(blarg$value))) %>% 
  mutate(value=as.numeric(value))
blarg$gas <-  factor(blarg$gas,levels(blarg$gas)[c(6,5,4,3,2,1)])

  
blarg$start <- cumsum(blarg$value)
blarg$start <- c(head(blarg$start, -1), 0)
blarg$end <- c(0, head(blarg$start, -1))
blarg <- cbind(blarg,id=c(6,5,4,3,2,1))

blarg %>%
  ggplot(.,aes(fill=gas)) +
  geom_rect(aes(x = gas,
                xmin = id - 0.45, 
                xmax = id + 0.45, 
                ymin = start,
                ymax = end)) +
  theme_bw() +
  ylab('GHG Emissions (GtCO2eq)') +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin=margin(0,10,0,0)))

plot_data <- spread(plot_data,Year,value)

xlsx::write.xlsx(as.data.frame(plot_data),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "Total_GHG_gas",append=T,row.names=FALSE)


```

### Long term CO2 emissions sources and sinks (Figure 2)


```{r Fig2_budget, echo=FALSE,warning=FALSE,fig.width=10,fig.height=6,fig.path="Results/Plots/",dev=c('png','pdf')}

######### load the global carbon budget ######### 

gcb <- xlsx::read.xlsx('Data/data from Jan.xlsx',sheetIndex = "CDIAC CO2 - Figure 2",startRow = 3,endRow = 270,colIndex=1:9)
names(gcb) <- c("Year","Total","Gas","Oil","Coal","Cement","Flaring","Net land-use","Total_CO2")

# fft <- read.xlsx('Data/Global_Carbon_Budget_2018v1.0.xlsx',sheetIndex = 'Fossil Emissions by Fuel Type',startRow = 13,endRow = 2017,colIndex = 1:8)

budget_data <- gather(gcb,key,value,-Year) %>% 
  filter(key!="Total_CO2",key!="Total") %>% 
  filter(Year>=1850) 

budget_data$key <- as.factor(budget_data$key)
budget_data$key <- factor(budget_data$key,levels(budget_data$key)[c(1,2,3,4,6,5)])

fractions <- budget_data %>% 
  filter(Year %in% c(1850,1900,1950,2000)) %>% 
  group_by(Year) %>% 
  mutate(totals=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year,key) %>% 
  mutate(fractions=(value/totals)*100)

p1 <- budget_data %>% 
  ggplot(.,aes(x=Year,y=value,fill=key,color=key)) + 
  geom_area() +
  geom_text(data=fractions,aes(x=Year,y=value+totals,label=paste(round(fractions,0),"%",sep=""))) +
  geom_vline(xintercept=c(1850,1900,1950,2000),alpha=0.3,linetype="dashed") +
  ylab("Carbon emissions (GtCO2/yr)") +
  theme_bw() +
  theme(legend.position = c(0.15,0.7),
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        legend.background = element_blank())

##### future budget code

# future_budget <- data.frame(target=c("1.5oC target","2oC target"),budget=c(500,1000)) %>% 
#   mutate(years=ceiling(budget/as.vector(plot_data %>% filter(Year==2017) %>% summarise(total=sum(value)))[[1]]))
# 
# p2 <- future_budget %>% 
#   ggplot(.,aes(x=target,y=budget)) +
#   geom_bar(stat='identity') +
#   geom_text(aes(x=target,y=budget+50,label=paste("Years: ",years))) +
#   theme(axis.title.x = element_blank()) +
#   ylab("Total carbon budget relative to climate targets (GtCO2)")

###
date_data <- gcb %>% 
  select(Year,value=Total_CO2) %>% 
  filter(Year>=1850) %>% 
  mutate(key=ifelse(Year>=1850 & Year < 1890,'1850-1889',NA)) %>% 
  mutate(key=ifelse(Year>=1890 & Year < 1930,'1890-1930',key)) %>% 
  mutate(key=ifelse(Year>=1930 & Year < 1970,'1930-1970',key)) %>% 
  mutate(key=ifelse(Year>=1970 & Year < 2010,'1970-2010',key)) %>% 
  mutate(key=ifelse(Year>=2010,'2010-2017',key)) %>% 
  filter(!is.na(key))

date_data <- date_data %>% 
  mutate(key=as.factor(key)) %>% 
  group_by(key) %>% 
  summarise(value=sum(value)) %>% 
  add_row(key="1.5",value=420) %>% 
  add_row(key="2.0",value=1170)


date_data$key <- factor(date_data$key,levels(date_data$key)[c(7,6,5,4,3,2,1)])

p2 <- date_data %>% 
  ggplot(.,aes(x='x',y=value,fill=key)) +
  geom_bar(stat='identity') +
  ylab('Carbon emissions, cumulative (GtCO2)') +
  theme_bw() +
  theme(legend.position= c(0.5,0.5),
        legend.background = element_blank(),
        axis.title.x = element_blank())


time_data <- data.frame(target=c("1.5oC target","2oC target"),budget=c(420,1170)) %>% 
  group_by(budget) %>% 
  mutate(current_emissions=budget/as.vector(budget_data %>% filter(Year==2017) %>% summarise(total=sum(value)))[[1]]) %>% 
  mutate(current_emissions=round(current_emissions,0)+2017) %>% 
  ungroup()

time_data <- cbind(time_data,data.frame(three=c(2030,2084),seven=c(2037,NA)))
time_data <- gather(time_data,key,value,-budget,-target) %>% 
  mutate(key=as.factor(key))

time_data$key <- factor(time_data$key,levels(time_data$key)[c(2,3,1)])


p3 <- time_data %>% 
  ggplot(.,aes(x=key,y=value,fill=target)) + 
  geom_bar(stat='identity') +
  geom_text(aes(x=key,y=value+2,label=round(value-2017,0))) +
  #scale_y_continuous(limits=c(2017,2100),oob =rescale_none) +
  coord_flip(ylim = c(2017,2100)) +
  facet_grid(target~.) +
  theme_bw() +
  theme(legend.position='none',
        axis.title.y=element_blank()) +
  ylab('Year of budget exceedance') 

p4<- ggarrange(p2,p3,ncol=2,widths=c(1,2))

p <- ggarrange(p1,p4,nrow=2)
p

budget_data <- spread(budget_data,Year,value)

xlsx::write.xlsx(as.data.frame(budget_data),file=paste("Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "CO2_budget",append=T,row.names=FALSE)

```

### Regional per capita trends (Figure 6)

```{r percapita_trends, echo=FALSE,warning=FALSE,fig.width=8,fig.height=4,fig.path="Results/Plots/",dev=c('png','pdf')}

######
load('Data/edgar.RData')
load('Data/basic.RData')

edgar_GHG <- left_join(edgar_GHG,basic %>% select(ISO,pop_UN,Year,gdp_real_WB),by=c("ISO"="ISO","Year"="Year"))

######

region <- edgar_GHG %>% 
  filter(Year>1969 & Year<2018) %>% 
  select(Year,WB.income,Country,GHG,gdp_real_WB,pop_UN) %>% 
  group_by(Year,Country,WB.income) %>% 
  summarise(GHG=sum(GHG,na.rm=T),pop_UN=first(pop_UN),gdp_real_WB=first(gdp_real_WB)) %>% 
  group_by(Year,WB.income) %>% 
  summarise(ghg_total = sum(GHG,na.rm=T)*1000,pop=sum(pop_UN,na.rm=T),gdp=sum(gdp_real_WB,na.rm=T)) %>% 
  mutate(ghg_pc = ghg_total/pop,ghg_gdp = ghg_total/gdp)
  

# region <- edgar_GHG %>% 
#   filter(Year>1969 & Year<2018) %>% 
#   #filter(!is.na(WB.income)) %>% 
#   group_by(WB.income,Year) %>% 
#   summarise(ghg_total = sum(GHG,na.rm=T)*1000,pop=sum(pop_UN,na.rm=T),gdp=sum(gdp_real_WB,na.rm=T)) %>% 
#   mutate(ghg_pc = ghg_total/pop,ghg_gdp = ghg_total/gdp)

## cumulative emissions total (horizontal bar chart)
# p1 <- region %>% 
#   group_by(WB.income) %>% 
#   summarise(cumulative_ghg = sum(ghg_total)/1e6) %>% 
#   ggplot(.,aes(y=cumulative_ghg,x=WB.income,fill=WB.income)) +
#   geom_bar(stat='identity') +
#   ylab("Cumulative GHG emissions (GtCO2eq)") +
#   coord_flip() +
#   theme(legend.title = element_blank(), legend.position = "none") +
#   theme(axis.title.y = element_blank()) 

## total ghg emissions (stacked area)
# p2 <- region %>% ggplot(.,aes(x=Year,y=ghg_total/1e6,fill=WB.income)) +
#   geom_area() +
#   ylab("GHG Emissions (GtCO2eq/yr)") +
#   theme(legend.title = element_blank(),legend.position = "none")

## per capita ghg emissions (line chart)
p3 <- region %>% 
  filter(!is.na(WB.income)) %>% 
  ggplot(.,aes(x=Year,y=ghg_pc,colour=WB.income)) +
  ylab('GHG Emissions per capita (tCO2eq/capita/yr)') +
  geom_path(size=1) +
  theme_bw() +
  theme(legend.position = c(0.12,0.8),
        legend.title=element_blank(),
        legend.background = element_blank(),
        axis.title.x = element_blank())

## ghg emissions per gdp (line chart)
p4 <- region %>% 
  filter(!is.na(WB.income)) %>% 
  ggplot(.,aes(x=Year,y=ghg_gdp,colour=WB.income)) +
  ylab('GHG Emissions per $GDP (tCO2eq/$/yr)') +
  theme_bw() +
  geom_path(size=1) +
  theme(legend.title = element_blank(), legend.position = "none",
        axis.title.x = element_blank())


#ggarrange(p1, p2, p3, p4, nrow=2,ncol=2)
ggarrange(p3,p4,nrow=1,ncol=2)

xlsx::write.xlsx(as.data.frame(region),file=paste("Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "per_capita_trends",append=T,row.names=FALSE)


```


### Total GHGs, split by region

```{r ghgs_total_income, echo=FALSE,warning=FALSE,fig.width=8,fig.path="Results/Plots/",dev=c('png','pdf')}

plot_data <- edgar_GHG %>%
  group_by(Year,WB.income) %>% 
  summarise(value=sum(GHG,rm.na=T)/1e6)

shares <- plot_data %>% 
  filter(Year %in% c(1970,1980,1990,2000,2010,2017)) %>% 
  group_by(Year) %>% 
  mutate(totals=sum(value)) %>% 
  ungroup() %>% 
  group_by(Year,WB.income) %>% 
  mutate(fractions=(value/totals)*100)

shares <- shares %>%
  arrange(Year)

for (i in seq(1,24,4)) {
  
  shares$location[i] = (shares$value[i]/2) + shares$value[i+1] + shares$value[i+2] + shares$value[i+3]
  shares$location[i+1] = (shares$value[i+1]/2) + shares$value[i+2] + shares$value[i+3]
  shares$location[i+2] = (shares$value[i+2]/2) + shares$value[i+3]
  shares$location[i+3] = (shares$value[i+3]/2)
  
}

p <- plot_data %>%
    ggplot(.,aes(x=Year,y=value,fill=WB.income)) +
    geom_area(color='#737373') +
    geom_text(data=shares,aes(x=Year,y=location,label=paste(round(fractions,0),"%",sep="")))+
    geom_vline(xintercept=c(1970,1980,1990,2000,2010,2017),alpha=0.3,linetype="dashed") +
    theme_bw() +
    theme(legend.justification=c(0,1), 
          legend.position=c(0.05, 0.97),
          legend.title=element_blank(),
          legend.background = element_blank(),
          legend.spacing.x = unit(0.2,'cm'),
          axis.title.x = element_blank(),
          plot.title = element_text(size = 12))


p

plot_data <- spread(plot_data,Year,total_ghg)

xlsx::write.xlsx(as.data.frame(plot_data),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "Total_GHGs_Income",row.names=FALSE)

```