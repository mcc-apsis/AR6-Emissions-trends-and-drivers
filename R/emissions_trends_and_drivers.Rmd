---
title: "Emissions trends and drivers: overview"
author: "William F. Lamb"
output: 
  word_document:
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Results") })
  
---

```{r setup, include=FALSE}

rm(list = ls())
library(tidyverse)
library(ggpubr)
library(gganimate)
library(xlsx)
load('../Data/edgar.RData')

source("small_figures.R")
source("decomp_figure_countries.R")
source("decomp_figure_sectors.R")

sectors = data.frame(key=c(6,7,9,10,11),value=c("Energy systems","AFOLU","Buildings","Transport","Industry"))

edgar_GHG <- edgar_GHG %>% 
  mutate(region_ar6_5_short=ifelse(region_ar6_5=="Developed Countries","DEV",NA)) %>% 
  mutate(region_ar6_5_short=ifelse(region_ar6_5=="Latin America and Caribbean","LAM",region_ar6_5_short)) %>% 
  mutate(region_ar6_5_short=ifelse(region_ar6_5=="Africa and Middle East","AME",region_ar6_5_short)) %>% 
  mutate(region_ar6_5_short=ifelse(region_ar6_5=="Eastern Europe and West-Central Asia","EEA",region_ar6_5_short)) %>% 
  mutate(region_ar6_5_short=ifelse(region_ar6_5=="Asia and developing Pacific","APC",region_ar6_5_short)) %>% 
  mutate(region_ar6_5_short=ifelse(region_ar6_5=="Intl. Shipping","SEA",region_ar6_5_short)) %>% 
  mutate(region_ar6_5_short=ifelse(region_ar6_5=="Intl. Aviation","AIR",region_ar6_5_short))


edgar_GHG$region_ar6_5_short <- as.factor(edgar_GHG$region_ar6_5_short)

edgar_GHG$region_ar6_5_short <- factor(edgar_GHG$region_ar6_5_short,levels(edgar_GHG$region_ar6_5_short)[c(1,7,2,3,4,5,6)])

# set palette
ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Set2") + scale_fill_brewer(palette="Set2")


```



### Figure 1: GHG emissions by gas

```{r Fig1_trend, echo=FALSE,warning=FALSE,fig.width=8,fig.height=6,fig.path="Results/Plots/",dev=c('png','pdf')}

######### load Jan data ######### 


plot_data <- edgar_GHG %>% 
  filter(year>1989) %>% 
  filter(year<2018) %>% 
  group_by(year) %>% 
  summarise(CO2=sum(CO2,na.rm=T)/1e9,CH4=sum(CH4,na.rm=T)/1e9,N2O=sum(N2O,na.rm=T)/1e9,Fgas=sum(Fgas,na.rm=T)/1e9)

land_data <- xlsx::read.xlsx('../Data/data from Jan.xlsx',sheetIndex = "EDGAR gas - Figure 1",startRow = 10,endRow = 16,check.names=FALSE)

land_data <- gather(land_data,year,value,-source,-gas) %>% 
  mutate(year=as.numeric(year)) %>% 
  filter(!is.na(value)) %>%
  filter(gas=="CO2 landuse") %>% 
  select(year,CO2_Landuse=value) 

plot_data <- left_join(plot_data,land_data,by=c("year"="year"))
plot_data<- gather(plot_data,gas,value,-year) 
plot_data <- plot_data %>% 
  mutate(gas=ifelse(gas=="CO2","CO2 FFI",gas)) %>% 
  mutate(gas=ifelse(gas=="CO2_Landuse","CO2 FOLU",gas))

plot_data$gas <- as.factor(plot_data$gas)
plot_data$gas <-  factor(plot_data$gas,levels(plot_data$gas)[c(4,5,1,3,2)])

shares <- plot_data %>% 
  filter(year %in% c(1990,2000,2010,2017)) %>% 
  group_by(year) %>% 
  mutate(totals=sum(value)) %>% 
  ungroup() %>% 
  group_by(year,gas) %>% 
  mutate(fractions=(value/totals)*100)

shares <- locate_shares(shares,"gas",4)

p1 <- plot_data %>% 
  ggplot(.,aes(x=year,y=value,fill=gas)) +
  geom_area() +
  geom_text(data=shares,aes(x=year,y=location,label=paste(round(fractions,0),"%",sep="")),size=3.5,colour="#252525")+
  geom_vline(xintercept=c(1990,2000,2010,2017),alpha=0.3,linetype="dashed") +
  ylab('GHG Emissions \n(GtCO2eq/yr)') +
  labs(fill="Gas") +
  scale_y_continuous(breaks=c(0,10,20,30,40,50,60)) +
  scale_x_continuous(breaks=c(1990,2000,2010,2017)) +
  big_trend_theme +
  theme(legend.position = c(0.225,0.85),
        legend.background = element_rect(linetype = 1, size = 0.5, colour = "#525252"),
        legend.margin = margin(l=5,t=5,b=5,r=10,unit="pt"),
        legend.text = element_text(size=8),
        legend.title = element_text(size=8)) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE),
         shape = guide_legend(override.aes = list(size = 0.5)),
         color = guide_legend(override.aes = list(size = 0.5)))


p2 <- plot_data %>%
  ggplot(.,aes(x=year,y=value,color=gas)) +
  geom_line() +
  scale_x_continuous(breaks=c(1995,2010)) +
  theme_bw() +
  ylab('GHG Emissions \n(Gt/yr - original units)') +
  facet_wrap(.~gas,scales='free',nrow=1) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin=margin(0,10,0,0)),
        text = element_text(size=11),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())
  

###### waterfall

waterfall <- plot_data %>%
  filter(year==2017) %>% 
  group_by(gas) %>%
  summarise(value=sum(value)) %>% 
  arrange(desc(gas))

waterfall$end <- cumsum(waterfall$value)
waterfall$start <- c(0, head(waterfall$end, -1))
waterfall <- cbind(waterfall,id=c(5,4,3,2,1))

second_waterfall <- plot_data %>%
  filter(year==2017) %>% 
  group_by(gas) %>%
  summarise(value=sum(value)) %>% 
  arrange(desc(gas))

second_waterfall$end <- cumsum(second_waterfall$value)
second_waterfall$start <- c(0, head(second_waterfall$end, -1))
second_waterfall <- cbind(second_waterfall,id=c(5,4,3,2,1))

p3 <- waterfall %>%
  ggplot(.,aes(fill=gas)) +
  geom_rect(aes(x = gas,
                xmin = id - 0.4,
                xmax = id + 0.4,
                ymin = start,
                ymax = end)) +
  scale_y_continuous(breaks=c(0,10,20,30,40,50,60)) +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin=margin(0,10,0,0)),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank())

p4 <- second_waterfall %>%
  ggplot(.,aes(fill=gas)) +
  geom_rect(aes(x = gas,
                xmin = id - 0.4,
                xmax = id + 0.4,
                ymin = start,
                ymax = end)) +
  scale_y_continuous(breaks=c(0,10,20,30,40,50,60)) +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin=margin(0,10,0,0)),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_blank())

plot <- ggarrange(p1,p3,p4,nrow=1,ncol=3,widths = c(0.8,0.1,0.1),align = "h")
plot <- ggarrange(plot,p2,nrow=2,ncol=1,heights = c(0.7,0.3),align="v")
plot 

#plot_data <- spread(plot_data,year,value)

#xlsx::write.xlsx(as.data.frame(plot_data),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "Total_GHG_gas",append=T,row.names=FALSE)


```

### Figure 2: Long term CO2 emissions sources and sinks


```{r Fig2_budget, echo=FALSE,warning=FALSE,fig.width=10,fig.height=6,fig.path="Results/Plots/",dev=c('png','pdf')}

######### load the global carbon budget ######### 

gcb <- xlsx::read.xlsx('../Data/data from Jan.xlsx',sheetIndex = "CDIAC CO2 - Figure 2",startRow = 3,endRow = 270,colIndex=1:9)
names(gcb) <- c("Year","Total","Gas","Oil","Coal","Cement","Flaring","Net land-use","Total_CO2")

# fft <- read.xlsx('Data/Global_Carbon_Budget_2018v1.0.xlsx',sheetIndex = 'Fossil Emissions by Fuel Type',startRow = 13,endRow = 2017,colIndex = 1:8)

budget_data <- gather(gcb,key,value,-Year) %>% 
  filter(key!="Total_CO2",key!="Total") %>% 
  filter(Year>=1850) %>% 
  select(year=Year,everything())

budget_data$key <- as.factor(budget_data$key)
budget_data$key <- factor(budget_data$key,levels(budget_data$key)[c(1,2,3,4,6,5)])

shares <- budget_data %>% 
  filter(year %in% c(1850,1900,1950,2000)) %>% 
  group_by(year) %>% 
  mutate(totals=sum(value)) %>% 
  ungroup() %>% 
  group_by(year,key) %>% 
  mutate(fractions=(value/totals)*100)


shares <- locate_shares(shares,"key",4)

p1 <- budget_data %>% 
  ggplot(.,aes(x=year,y=value,fill=key,color=key)) + 
  geom_area() +
  geom_text(data=shares,aes(x=year,y=location,label=paste(round(fractions,0),"%",sep="")),size=3.5,colour="#252525")+
  geom_vline(xintercept=c(1850,1900,1950,2000),alpha=0.3,linetype="dashed") +
  ylab("Carbon emissions (GtCO2/yr)") +
  big_trend_theme +
  theme(legend.position = c(0.15,0.7),
        legend.title = element_blank(),
        legend.background = element_blank())


date_data <- gcb %>% 
  select(Year,value=Total_CO2) %>% 
  filter(Year>=1850) %>% 
  #mutate(key=ifelse(Year>=1850 & Year < 1890,'1850-1889',NA)) %>% 
  #mutate(key=ifelse(Year>=1890 & Year < 1930,'1890-1930',key)) %>% 
  #mutate(key=ifelse(Year>=1930 & Year < 1970,'1930-1970',key)) %>% 
  #mutate(key=ifelse(Year>=1970 & Year < 2010,'1970-2010',key)) %>% 
  mutate(key=NA) %>%
  mutate(key=ifelse(Year>1850 & Year < 2010,'1850-2009',key)) %>% 
  mutate(key=ifelse(Year>=2010,'2010-2017',key)) %>% 
  filter(!is.na(key))

date_data <- date_data %>% 
  mutate(key=as.factor(key)) %>% 
  group_by(key) %>% 
  summarise(value=sum(value)) %>% 
  add_row(key="1.5 budget",value=420) %>% 
  add_row(key="2.0 budget",value=1170)

date_data$key <- factor(date_data$key,levels(date_data$key)[c(4,3,2,1)])

p2 <- date_data %>% 
  ggplot(.,aes(x='x',y=value,fill=key)) +
  geom_bar(stat='identity') +
  ylab('Carbon emissions, cumulative (GtCO2)') +
  big_trend_theme +
  theme(legend.position= c(0.5,0.5),
        legend.background = element_blank(),
        axis.title.x = element_blank())


time_data <- data.frame(target=c("1.5oC target","2oC target"),budget=c(420,1170)) %>% 
  group_by(budget) %>% 
  mutate(current_emissions=budget/as.vector(budget_data %>% filter(year==2017) %>% summarise(total=sum(value)))[[1]]) %>% 
  mutate(current_emissions=round(current_emissions,0)+2017) %>% 
  ungroup()

time_data <- cbind(time_data,data.frame(three=c(2030,2084),seven=c(2037,NA)))
time_data <- gather(time_data,key,value,-budget,-target) %>% 
  mutate(key=as.factor(key))

time_data$key <- factor(time_data$key,levels(time_data$key)[c(2,3,1)])


p3 <- time_data %>% 
  ggplot(.,aes(x=key,y=value,fill=target)) + 
  geom_bar(stat='identity') +
  geom_text(aes(x=key,y=value+2,label=round(value-2017,0))) +
  #scale_y_continuous(limits=c(2017,2100),oob =rescale_none) +
  coord_flip(ylim = c(2017,2100)) +
  facet_grid(target~.) +
  theme_bw() +
  theme(legend.position='none',
        axis.title.y=element_blank()) +
  ylab('Year of budget exceedance') 

p4<- ggarrange(p2,p3,ncol=2,widths=c(1,2))

p <- ggarrange(p1,p4,nrow=2)
p

#budget_data <- spread(budget_data,year,value)

#xlsx::write.xlsx(as.data.frame(budget_data),file=paste("Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "CO2_budget",append=T,row.names=FALSE)

```


### Figure 5: Total GHGs, split by region

```{r Fig5_ghgs_region, echo=FALSE,warning=FALSE,fig.width=8,fig.height=12,fig.path="Results/Plots/",dev=c('png','pdf')}

plot_data <- edgar_GHG %>%
  group_by(year,region_ar6_5_short) %>% 
  summarise(value=sum(GHG,na.rm=TRUE)/1e9) %>% 
  filter(year>1989) %>% 
  filter(year<2018)

shares <- plot_data %>% 
  filter(year %in% c(1990,2000,2010,2017)) %>% 
  group_by(year) %>% 
  mutate(totals=sum(value)) %>% 
  ungroup() %>% 
  group_by(year,region_ar6_5_short) %>% 
  mutate(fractions=(value/totals)*100)

shares <- locate_shares(shares,"region_ar6_5_short",4)

p1 <- plot_data %>%
  ggplot(.,aes(x=year,y=value,fill=region_ar6_5_short)) +
  geom_area() +
  geom_text(data=shares,aes(x=year,y=location,label=paste(round(fractions,0),"%",sep="")),size=3.5,colour="#252525")+
  geom_vline(xintercept=c(1990,2000,2010,2017),alpha=0.3,linetype="dashed") +
  
  labs(fill="Gas") +
  scale_y_continuous(breaks=c(0,10,20,30,40,50,60)) +
  scale_x_continuous(breaks=c(1990,2000,2010,2017)) +
  
  big_trend_theme +
  theme(legend.justification=c(0,1), 
        legend.position=c(0.05, 0.97),
        legend.title=element_blank(),
        legend.background = element_blank(),
        legend.spacing.x = unit(0.2,'cm')) +
  ylab('GHG Emissions \n(GtCO2eq/yr)')
  

########### Decomposition figure ###########

totals <- edgar_GHG %>% 
  filter(year>1989) %>% 
  filter(year<2018) %>% 
  group_by(ISO,country,year,region_ar6_5,region_ar6_10,region_ar6_22,region_ar6_dev,region_ar6_5_short) %>% 
  summarise_at(c("CO2","CH4","N2O","Fgas","GHG"),sum,na.rm=TRUE) %>% 
  mutate(chapter=0,sector_code="Total",description="Total",category_1="Total",category_2="Total",category_3="Total")

load('../Data/basic.RData')
decomp <- decomp_figure_countries(2010,'sector_code','Total','GHG',totals,basic)




p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)
p3 <- ggarrange(decomp$pc_plot,decomp$pgdp_plot,ncol=2,nrow=1)
# p2 <- annotate_figure(p2,
#   top = text_grob("B. Decomposition of relative and absolute contribution by country",size = 12,hjust=0.75))

plot <- ggarrange(p1,p2,p3,ncol=1,nrow=3,heights=c(0.2,0.3,0.3))
plot


##########





#plot_data <- spread(plot_data,year,value)

#xlsx::write.xlsx(as.data.frame(plot_data),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "Total_GHGs_Income",row.names=FALSE)

```




### Figure 9: Total GHGs, split by sector

```{r Fig9_sectors, echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,fig.path="Results/Plots/",dev=c('png','pdf')}

load('../Data/edgar.RData')

edgar_GHG <- left_join(edgar_GHG,sectors %>% select(chapter_title=value,everything()),by=c("chapter"="key"))

plot_data <- edgar_GHG  %>% 
  filter(year>1989) %>% 
  filter(year<2018) %>% 
  filter(!is.na(chapter)) %>% 
  group_by(year,chapter,chapter_title) %>%  
  summarise(value=sum(GHG,na.rm=TRUE)/1e9) %>% 
  ungroup()

data <- xlsx::read.xlsx('../Data/data from Jan.xlsx',sheetIndex = "EDGAR gas - Figure 1",startRow = 10,endRow = 16,check.names=FALSE)

data <- gather(data,year,value,-source,-gas) %>%  
  filter(year>1989) %>% 
  filter(year<2018) %>% 
  mutate(year=as.numeric(year)) %>% 
  filter(!is.na(value)) %>%
  filter(gas=="CO2 landuse") %>% 
  mutate(chapter=7,chapter_title="AFOLU") %>% 
  select(year,chapter,chapter_title,value) 


plot_data <- rbind(plot_data,data)

### merge agriculture and FOLU
plot_data <- plot_data %>% 
  group_by(year,chapter,chapter_title) %>% 
  summarise(value=sum(value)) %>% 
  ungroup()

plot_data$chapter_title <- factor(plot_data$chapter_title,levels(plot_data$chapter_title)[c(3,1,2,5,4)])

shares <- plot_data %>% 
  filter(year %in% c(1990,2000,2010,2017)) %>% 
  group_by(year) %>% 
  mutate(totals=sum(value)) %>% 
  ungroup() %>% 
  group_by(year,chapter) %>% 
  mutate(fractions=(value/totals)*100) %>% 
  ungroup()

shares <- locate_shares(shares,"chapter",4)

p1 <- plot_data %>%
  ggplot(.,aes(x=year,y=value,fill=chapter_title)) +
  geom_area() +
  geom_text(data=shares,aes(x=year,y=location,label=paste(round(fractions,0),"%",sep="")))+
  geom_vline(xintercept=c(1990,2000,2010,2017),alpha=0.3,linetype="dashed") +
  ylab("GHG emissions (GtCO2eq/yr)") +
  
  labs(fill="Sector") +
  scale_y_continuous(breaks=c(0,10,20,30,40,50,60)) +
  scale_x_continuous(breaks=c(1990,2000,2010,2017)) +
  
  big_trend_theme +
  theme(axis.title.x = element_blank(),
          legend.position = c(0.12,0.8),
        legend.title=element_blank(),
        legend.background = element_blank())


######## subsectors

decomp <- decomp_figure_sectors(2010,'GHG',edgar_GHG)


  
p2 <- ggarrange(decomp$rate_plot,decomp$abs_plot,ncol=2,nrow=1)

plot <- ggarrange(p1,p2,ncol=1,nrow=2,heights=c(0.4,0.6))
plot

  
# xlsx::write.xlsx(as.data.frame(plot_data),file=paste("../Results/IPCC_plot_data_",Sys.Date(),".xlsx",sep=""),sheetName = "Total_GHGs_Sector",append=TRUE,row.names=FALSE)


```




